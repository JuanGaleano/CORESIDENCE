# LIBRARIES AND FUNCTIONS ####
`%notin%` <- Negate(`%in%`)
library(tidyverse)
library(haven)
library(tibble)
library(tidylog)
library(writexl)
library(readxl)
library(doParallel)

setwd("N:\\Shared drives\\CORESIDENCE\\WP2_DATA\\2_4_CORESIDENCE_DATABASE")

#### ipums #####
load("A3_CORESIDENCE_IPUMS_list_2024.RData")
#save(df,file="df.Rdata")

no_cores <- detectCores() - 68  
registerDoParallel(cores=no_cores)  
cl <- makeCluster(no_cores)  

FUN_PASO1_LIST <-  function(df) {
  library(tidyverse)
  library(haven)  
  VALID_GQ<-c(10,99)
  
  if(all(is.na(df$RESIDENT))) {
    # If all values in 'resident' are NA, set the entire column (or a new one) to 4
    df$RESIDENT <- 4
  } else {
    # If not all values are NA, copy the actual values from 'resident'
    df$RESIDENT <- df$RESIDENT
  }
  
  df<-df|>
    mutate(RESIDENT=unclass(RESIDENT))|>
    filter(RESIDENT %in% c(4,1))
  
  
  df<-as_tibble(df)
  df<-df %>%
    filter(GQ %in% VALID_GQ) %>% #filtrem nom?s els private households
    add_count(SERIAL)%>%
    filter(AGE != 999)%>%
    mutate(child5=ifelse(AGE<=4,1,0),
           adult18=ifelse(AGE>=18,1,0),
           adult18M=ifelse((AGE>=18&SEX==1),1,0),
           adult18F=ifelse((AGE>=18&SEX==2),1,0),
           child18=ifelse(AGE<18,1,0),
           elderly65=ifelse(AGE>=65,1,0),
           
           age00_09=ifelse((AGE2=="0-4"|AGE2=="5-9"),1,0),
           age10_19=ifelse((AGE2=="10-14"|AGE2=="15-19"),1,0),
           age20_29=ifelse((AGE2=="20-24"|AGE2=="25-29"),1,0),
           age30_39=ifelse((AGE2=="30-34"|AGE2=="35-39"),1,0),
           age40_49=ifelse((AGE2=="40-44"|AGE2=="45-49"),1,0),
           age50_59=ifelse((AGE2=="50-54"|AGE2=="55-59"),1,0),
           age60_69=ifelse((AGE2=="60-64"|AGE2=="65-69"),1,0),
           age70_79=ifelse((AGE2=="70-74"|AGE2=="75-79"),1,0),
           age80=ifelse(AGE>=80,1,0),
           
           heads=ifelse(RELATE==1,1,0), 
           spouses=ifelse(RELATE==2,1,0),
           childs=ifelse(RELATE==3,1,0),
           other_relatives=ifelse(RELATE==4,1,0),
           non_relatives=ifelse(RELATE==5,1,0),
           other_rel_or_non_rel=ifelse(RELATE==6,1,0),
           
           grandchilds=ifelse(RELATED %in% c(4100, 4110,4120,4130),1,0),
           parents=ifelse(RELATED %in% c(4200,4210,4211,4220 ),1,0),
           siblings=ifelse(RELATED %in% c(4400,4410,4420,4430,4431,4432),1,0),
           
           WEIGHT_POP= sum(PWEIGHT,na.rm = TRUE)*1,
           #WEIGHT_A= sum(df[df$RELATE==1,"PWEIGHT_A"]),
           WEIGHT_A= sum(PWEIGHT[RELATE==1]),
           WEIGHT_A2= sum(PWEIGHT[RELATE==1&n==2]),
           WEIGHT_A3= sum(PWEIGHT[RELATE==1&n==3]),
           WEIGHT_A4= sum(PWEIGHT[RELATE==1&n==4]),
           WEIGHT_A5= sum(PWEIGHT[RELATE==1&n==5]),
           WEIGHT_AM= sum(PWEIGHT[RELATE==1&SEX==1]),
           WEIGHT_AF= sum(PWEIGHT[RELATE==1&SEX==2]),
           WEIGHT_2029=sum(PWEIGHT[RELATE==1&age20_29==1]),
           WEIGHT_3039=sum(PWEIGHT[RELATE==1&age30_39==1]),
           WEIGHT_4049=sum(PWEIGHT[RELATE==1&age40_49==1]),
           WEIGHT_5059=sum(PWEIGHT[RELATE==1&age50_59==1]),
           WEIGHT_6069=sum(PWEIGHT[RELATE==1&age60_69==1]),
           
           M_headed=ifelse((RELATE==1 & SEX==1),1,0),
           F_headed=ifelse((RELATE==1 & SEX==2),1,0),
           headed2029=ifelse((RELATE==1 &age20_29==1),1,0), 
           headed3039=ifelse((RELATE==1 &age30_39==1),1,0),
           headed4049=ifelse((RELATE==1 &age40_49==1),1,0),
           headed5059=ifelse((RELATE==1 &age50_59==1),1,0),
           headed6069=ifelse((RELATE==1 &age60_69==1),1,0)
    )
  
}

system.time(
  PASO1_LIST<-parLapply(cl, CORE_LIST, FUN_PASO1_LIST)
)

rm(CORE_LIST)
gc()

FUN_PASO2_LIST <-  function(df) {
  library(tidyverse)
  library(haven) 
  df<-df|>
    group_by(SERIAL)|>
    mutate(hh_per1=n(),
           hh_parents=sum(parents*PWEIGHT),
           hh_grandchilds=sum(grandchilds*PWEIGHT),
           hh_heads=sum(heads*PWEIGHT),
           hh_spouses=sum(spouses*PWEIGHT),
           hh_childs=sum(childs*PWEIGHT),
           hh_other_relatives=sum(other_relatives*PWEIGHT),
           hh_non_relatives=sum(non_relatives*PWEIGHT),
           hh_other_rel_or_non_rel=sum(other_rel_or_non_rel*PWEIGHT))|>
    mutate(family_type= #ifelse(hh_per1==1, 10, # unipersonal households 
             ifelse(hh_per1==1, 10, # unipersonal households 
                           ifelse(hh_spouses>0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20, #nuclear 
                                  ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives ==0 & hh_non_relatives==0,20,#nuclear 
                                         ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20,#nuclear 
                                                
                                                
                                                ifelse(hh_spouses>0 & hh_childs>0 &  hh_other_relatives >0 & hh_non_relatives==0,31,# nuclear + other relatives
                                                       ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives >0 & hh_non_relatives==0,31,
                                                              ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives >0 & hh_non_relatives==0,31,
                                                                     
                                                                     ifelse(hh_spouses>0 & hh_childs>0 &  hh_other_relatives ==0 & hh_non_relatives>0,32,
                                                                            ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives ==0 & hh_non_relatives>0,32,
                                                                                   ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives>0,32,       
                                                                                          
                                                                                          ifelse(hh_spouses>0 & hh_childs>0 &  hh_other_relatives >0 & hh_non_relatives>0,33,
                                                                                                 ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives >0 & hh_non_relatives>0,33,
                                                                                                        ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives >0 & hh_non_relatives>0,33,        
                                                                                                               
                                                                                                               ifelse(hh_spouses==0 & hh_childs==0 &  hh_other_relatives >0 & hh_non_relatives==0,34,
                                                                                                                      ifelse(hh_spouses==0 & hh_childs==0 &  hh_other_relatives ==0 & hh_non_relatives>0,35,
                                                                                                                             ifelse(hh_spouses==0 & hh_childs==0 &  hh_other_relatives >0 & hh_non_relatives>0,36,
                                                                                                                                    0)))))))))))))))))|>
    mutate(family_type2=ifelse(hh_per1==1, 10,
                               ifelse(hh_spouses>0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20,
                                      ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives ==0 & hh_non_relatives==0,20,
                                             ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20,       
                                                    ifelse(hh_non_relatives>0,30, # "Other non family",
                                                           ifelse((hh_parents>0 | hh_grandchilds>0),40,# "Stem family",
                                                                  ifelse(hh_other_relatives>0,50, 9999))))))))|>
    
    mutate(family_type3=ifelse(any(F_headed==1)&(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0),21,9999))|>#monomarental )
    ungroup()
  
  
}

system.time(
  PASO2_LIST<-parLapply(cl, PASO1_LIST, FUN_PASO2_LIST)
)

rm(PASO1_LIST)
gc()

FUN_PASO3_LIST <-  function(df) {
  library(tidyverse)
  library(haven) 
  df<-df |>
    mutate(#WEIGHT_FT10= sum(PWEIGHT[family_type==10]),
      WEIGHT_FT10= sum(PWEIGHT[family_type==10]),
      WEIGHT_FT20= sum(PWEIGHT[RELATE==1&family_type==20]),
      WEIGHT_FT31= sum(PWEIGHT[RELATE==1&family_type==31]),
      WEIGHT_FT32= sum(PWEIGHT[RELATE==1&family_type==32]),
      WEIGHT_FT33= sum(PWEIGHT[RELATE==1&family_type==33]),
      WEIGHT_FT34= sum(PWEIGHT[RELATE==1&family_type==34]),
      WEIGHT_FT35= sum(PWEIGHT[RELATE==1&family_type==35]),
      WEIGHT_FT36= sum(PWEIGHT[RELATE==1&family_type==36]),
      WEIGHT_FT00= sum(PWEIGHT[RELATE==1&family_type==0]),
      
      WEIGHT_FT210= sum(PWEIGHT[family_type2==10]),
      WEIGHT_FT220= sum(PWEIGHT[RELATE==1&family_type2==20]),
      WEIGHT_FT230= sum(PWEIGHT[RELATE==1&family_type2==30]),
      WEIGHT_FT240= sum(PWEIGHT[RELATE==1&family_type2==40]),
      WEIGHT_FT250= sum(PWEIGHT[RELATE==1&family_type2==50]),
      WEIGHT_FT299= sum(PWEIGHT[RELATE==1&family_type2==9999]),
      
      WEIGHT_FT321= sum(PWEIGHT[RELATE==1&family_type3==21])
    )  
  
}

system.time(
  PASO3_LIST<-parLapply(cl, PASO2_LIST, FUN_PASO3_LIST)
)

rm(PASO2_LIST)
gc()

FUN_PASO4_LIST <-  function(df) {
  library(tidyverse)
  library(haven)
  df<-df |> ##### STEP 4 #######
  group_by(SAMPLE,CNTRY,YEAR,SERIAL,CONTINENT,CNTRY_ISO,
           SOURCE,CENSUS_ROUND,DECADE,FIVE_YEAR,CONTINENT2,
           WEIGHT_POP,WEIGHT_A,WEIGHT_A2,WEIGHT_A3,WEIGHT_A4,
           WEIGHT_A5, WEIGHT_AM,WEIGHT_AF,WEIGHT_2029,WEIGHT_3039,WEIGHT_4049,
           WEIGHT_5059,WEIGHT_6069,
           WEIGHT_FT10, 
           WEIGHT_FT20,
           WEIGHT_FT31,WEIGHT_FT32,WEIGHT_FT33,WEIGHT_FT34,WEIGHT_FT35,
           WEIGHT_FT36,WEIGHT_FT00,WEIGHT_FT210,WEIGHT_FT220,WEIGHT_FT230,
           WEIGHT_FT240,WEIGHT_FT250,WEIGHT_FT299,
           WEIGHT_FT321,
           family_type,
           family_type2,
           family_type3)|>
    summarise(hh=1,
              hh_per1=n(),
              hh_m=sum(M_headed),
              hh_f=sum(F_headed),
              hh_per=sum(hh*PWEIGHT),
              hh_child5=sum(child5*PWEIGHT),
              hh_adult18=sum(adult18*PWEIGHT),
              hh_adult18b=sum(adult18),
              
              hh_00_09=sum(age00_09*PWEIGHT),
              hh_10_19=sum(age10_19*PWEIGHT),
              hh_20_29=sum(age20_29*PWEIGHT),
              hh_30_39=sum(age30_39*PWEIGHT),
              hh_40_49=sum(age40_49*PWEIGHT),
              hh_50_59=sum(age50_59*PWEIGHT),
              hh_60_69=sum(age60_69*PWEIGHT),
              hh_70_79=sum(age70_79*PWEIGHT),
              hh_80=sum(age80*PWEIGHT),
              
              hh_adult18M=sum(adult18M*PWEIGHT),
              hh_adult18F=sum(adult18F*PWEIGHT),
              hh_adult18Mb=sum(adult18M),
              
              hh_child18=sum(child18*PWEIGHT),
              hh_elderly65=sum(elderly65*PWEIGHT),
              
              hh_heads=sum(heads*PWEIGHT),
              hh_spouses=sum(spouses*PWEIGHT),
              hh_childs=sum(childs*PWEIGHT),
              hh_other_relatives=sum(other_relatives*PWEIGHT),
              hh_non_relatives=sum(non_relatives*PWEIGHT),
              hh_other_rel_or_non_rel=sum(other_rel_or_non_rel*PWEIGHT),
              
              hh_grandchilds=sum(grandchilds*PWEIGHT),
              hh_parents=sum(parents*PWEIGHT),
              hh_siblings=sum(siblings*PWEIGHT), 
              hh_M_headed=sum(M_headed*PWEIGHT),
              hh_F_headed=sum(F_headed*PWEIGHT),
              hh_headed2029=sum(headed2029*PWEIGHT),
              hh_headed3039=sum(headed3039*PWEIGHT),
              hh_headed4049=sum(headed4049*PWEIGHT),
              hh_headed5059=sum(headed5059*PWEIGHT),
              hh_headed6069=sum(headed6069*PWEIGHT)
    )|>
    ungroup()
  
}

system.time(
  PASO4_LIST<-parLapply(cl, PASO3_LIST, FUN_PASO4_LIST)
)

rm(PASO3_LIST)
gc()

FUN_PASO5_LIST <-  function(df) {
  library(tidyverse)
  library(haven)
  df<-df |>
    group_by(CNTRY,CNTRY_ISO,YEAR,SOURCE,SAMPLE,CONTINENT,CONTINENT2,CENSUS_ROUND,DECADE,FIVE_YEAR)|>
    summarise(WPOP=round(unique(WEIGHT_POP),0),
              
              HS01=sum(ifelse(hh_per1==1,hh,0))/sum(hh),
              HS02=sum(ifelse(hh_per1==2,hh,0))/sum(hh),
              HS03=sum(ifelse(hh_per1==3,hh,0))/sum(hh),
              HS04=sum(ifelse(hh_per1==4,hh,0))/sum(hh),
              HS05=sum(ifelse(hh_per1==5,hh,0))/sum(hh),
              HS06=sum(ifelse(hh_per1==6,hh,0))/sum(hh),
              HS07=sum(ifelse(hh_per1==7,hh,0))/sum(hh),
              HS08=sum(ifelse(hh_per1==8,hh,0))/sum(hh),
              HS09=sum(ifelse(hh_per1==9,hh,0))/sum(hh),
              HS10=sum(ifelse(hh_per1==10,hh,0))/sum(hh),
              HS11=sum(ifelse(hh_per1>10,hh,0))/sum(hh),
              HS12=sum(ifelse((hh_per1==2|hh_per1==3),hh,0))/sum(hh),
              HS13=sum(ifelse((hh_per1==4|hh_per1==5),hh,0))/sum(hh),
              HS14=sum(ifelse(hh_per1>=6,hh,0))/sum(hh),
              HS15=sum(hh_child5 != 0)/sum(hh),
              HS16=sum(hh_elderly65 != 0)/sum(hh),
              HS17=sum(hh_per)/unique(WEIGHT_A),
              HS18=sum(hh_child5)/unique(WEIGHT_A),
              HS19=sum(hh_adult18)/unique(WEIGHT_A),
              HS20=sum(hh_child18)/unique(WEIGHT_A),
              HS21=sum(hh_elderly65)/unique(WEIGHT_A),
              HS22=sum(hh_00_09)/unique(WEIGHT_A),
              HS23=sum(hh_10_19)/unique(WEIGHT_A),
              HS24=sum(hh_20_29)/unique(WEIGHT_A),
              HS25=sum(hh_30_39)/unique(WEIGHT_A),
              HS26=sum(hh_40_49)/unique(WEIGHT_A),
              HS27=sum(hh_50_59)/unique(WEIGHT_A),
              HS28=sum(hh_60_69)/unique(WEIGHT_A),
              HS29=sum(hh_70_79)/unique(WEIGHT_A),
              HS30=sum(hh_80)/unique(WEIGHT_A),
              
              HR01=sum(hh_heads)/unique(WEIGHT_A),
              HR02=sum(hh_spouses)/unique(WEIGHT_A),
              HR03=sum(hh_childs)/unique(WEIGHT_A),
              HR04=sum(hh_other_relatives)/unique(WEIGHT_A),
              HR05=sum(hh_non_relatives)/unique(WEIGHT_A),
              HR06=sum(hh_other_rel_or_non_rel)/unique(WEIGHT_A),
              
              HR07=sum(hh_heads[hh_per1==2])/unique(WEIGHT_A2),
              HR08=sum(hh_spouses[hh_per1==2])/unique(WEIGHT_A2),
              HR09=sum(hh_childs[hh_per1==2])/unique(WEIGHT_A2),
              HR10=sum(hh_other_relatives[hh_per1==2])/unique(WEIGHT_A2),
              HR11=sum(hh_non_relatives[hh_per1==2])/unique(WEIGHT_A2),
              HR12=sum(hh_other_rel_or_non_rel[hh_per1==2])/unique(WEIGHT_A2),
              
              HR13=sum(hh_heads[hh_per1==3])/unique(WEIGHT_A3),
              HR14=sum(hh_spouses[hh_per1==3])/unique(WEIGHT_A3),
              HR15=sum(hh_childs[hh_per1==3])/unique(WEIGHT_A3),
              HR16=sum(hh_other_relatives[hh_per1==3])/unique(WEIGHT_A3),
              HR17=sum(hh_non_relatives[hh_per1==3])/unique(WEIGHT_A3),
              HR18=sum(hh_other_rel_or_non_rel[hh_per1==3])/unique(WEIGHT_A3),
              
              HR19=sum(hh_heads[hh_per1==4])/unique(WEIGHT_A4),
              HR20=sum(hh_spouses[hh_per1==4])/unique(WEIGHT_A4),
              HR21=sum(hh_childs[hh_per1==4])/unique(WEIGHT_A4),
              HR22=sum(hh_other_relatives[hh_per1==4])/unique(WEIGHT_A4),
              HR23=sum(hh_non_relatives[hh_per1==4])/unique(WEIGHT_A4),
              HR24=sum(hh_other_rel_or_non_rel[hh_per1==4])/unique(WEIGHT_A4),
              
              HR25=sum(hh_heads[hh_per1==5])/unique(WEIGHT_A5),
              HR26=sum(hh_spouses[hh_per1==5])/unique(WEIGHT_A5),
              HR27=sum(hh_childs[hh_per1==5])/unique(WEIGHT_A5),
              HR28=sum(hh_other_relatives[hh_per1==5])/unique(WEIGHT_A5),
              HR29=sum(hh_non_relatives[hh_per1==5])/unique(WEIGHT_A5),
              HR30=sum(hh_other_rel_or_non_rel[hh_per1==5])/unique(WEIGHT_A5),
              
              HT01=sum(ifelse(family_type==10,1,0)/sum(hh)),
              HT02=sum(ifelse(family_type==20,1,0)/sum(hh)),
              HT03=sum(ifelse(family_type==31,1,0)/sum(hh)),
              HT04=sum(ifelse(family_type==32,1,0)/sum(hh)),
              HT05=sum(ifelse(family_type==33,1,0)/sum(hh)),
              HT06=sum(ifelse(family_type==34,1,0)/sum(hh)),
              HT07=sum(ifelse(family_type==35,1,0)/sum(hh)),
              HT08=sum(ifelse(family_type==36,1,0)/sum(hh)),
              HT09=sum(ifelse(family_type==0,1,0)/sum(hh)),
              
              HT10=sum(hh_per[family_type==10])/unique(WEIGHT_FT10),
              HT11=sum(hh_per[family_type==20])/unique(WEIGHT_FT20),
              HT12=sum(hh_per[family_type==31])/unique(WEIGHT_FT31),
              HT13=sum(hh_per[family_type==32])/unique(WEIGHT_FT32),
              HT14=sum(hh_per[family_type==33])/unique(WEIGHT_FT33),
              HT15=sum(hh_per[family_type==34])/unique(WEIGHT_FT34),
              HT16=sum(hh_per[family_type==35])/unique(WEIGHT_FT35),
              HT17=sum(hh_per[family_type==36])/unique(WEIGHT_FT36),
              HT18=sum(hh_per[family_type==0])/unique(WEIGHT_FT00),
              
              HT20=sum(ifelse(family_type2==10,1,0)/sum(hh)),
              HT21=sum(ifelse(family_type2==20,1,0)/sum(hh)),
              HT22=sum(ifelse(family_type2==40,1,0)/sum(hh)),
              HT23=sum(ifelse(family_type2==50,1,0)/sum(hh)),
              HT24=sum(ifelse(family_type2==30,1,0)/sum(hh)),
              HT25=sum(ifelse(family_type2==9999,1,0)/sum(hh)),
              HT26=sum(hh_per[family_type2==10])/unique(WEIGHT_FT210),
              HT27=sum(hh_per[family_type2==20])/unique(WEIGHT_FT220),
              HT28=sum(hh_per[family_type2==40])/unique(WEIGHT_FT240),
              HT29=sum(hh_per[family_type2==50])/unique(WEIGHT_FT250),
              HT30=sum(hh_per[family_type2==30])/unique(WEIGHT_FT230),
              HT31=sum(hh_per[family_type2==9999])/unique(WEIGHT_FT299),
              
              HH01=sum(hh_M_headed[hh_M_headed!=0])/unique(WEIGHT_A),
              HH02=sum(hh_F_headed[hh_F_headed!=0])/unique(WEIGHT_A),
              
              HH03=sum(ifelse((hh_m==1 &hh_per1==1),hh,0))/sum(hh_m),
              HH04=sum(ifelse((hh_m==1 &hh_per1==2),hh,0))/sum(hh_m),
              HH05=sum(ifelse((hh_m==1 &hh_per1==3),hh,0))/sum(hh_m),
              HH06=sum(ifelse((hh_m==1 &hh_per1==4),hh,0))/sum(hh_m),
              HH07=sum(ifelse((hh_m==1 &hh_per1==5),hh,0))/sum(hh_m),
              HH08=sum(ifelse((hh_m==1 &hh_per1==6),hh,0))/sum(hh_m),
              HH09=sum(ifelse((hh_m==1 &hh_per1==7),hh,0))/sum(hh_m),
              HH10=sum(ifelse((hh_m==1 &hh_per1==8),hh,0))/sum(hh_m),
              HH11=sum(ifelse((hh_m==1 &hh_per1==9),hh,0))/sum(hh_m),
              HH12=sum(ifelse((hh_m==1 &hh_per1==10),hh,0))/sum(hh_m),
              HH13=sum(ifelse((hh_m==1 &hh_per1>10),hh,0))/sum(hh_m),
              
              HH14=sum(ifelse((hh_f==1 &hh_per1==1),hh,0))/sum(hh_f),
              HH15=sum(ifelse((hh_f==1 &hh_per1==2),hh,0))/sum(hh_f),
              HH16=sum(ifelse((hh_f==1 &hh_per1==3),hh,0))/sum(hh_f),
              HH17=sum(ifelse((hh_f==1 &hh_per1==4),hh,0))/sum(hh_f),
              HH18=sum(ifelse((hh_f==1 &hh_per1==5),hh,0))/sum(hh_f),
              HH19=sum(ifelse((hh_f==1 &hh_per1==6),hh,0))/sum(hh_f),
              HH20=sum(ifelse((hh_f==1 &hh_per1==7),hh,0))/sum(hh_f),
              HH21=sum(ifelse((hh_f==1 &hh_per1==8),hh,0))/sum(hh_f),
              HH22=sum(ifelse((hh_f==1 &hh_per1==9),hh,0))/sum(hh_f),
              HH23=sum(ifelse((hh_f==1 &hh_per1==10),hh,0))/sum(hh_f),
              HH24=sum(ifelse((hh_f==1 &hh_per1>10),hh,0))/sum(hh_f),
              
              HH25=sum(ifelse((hh_m==1 &family_type2==10),1,0)/sum(hh_m)),
              HH26=sum(ifelse((hh_m==1 &family_type2==20),1,0)/sum(hh_m)),
              HH27=sum(ifelse((hh_m==1 &family_type2==40),1,0)/sum(hh_m)),
              HH28=sum(ifelse((hh_m==1 &family_type2==50),1,0)/sum(hh_m)),
              HH29=sum(ifelse((hh_m==1 &family_type2==30),1,0)/sum(hh_m)),
              HH30=sum(ifelse((hh_m==1 &family_type2==9999),1,0)/sum(hh_m)),
              
              HH31=sum(ifelse((hh_f==1 &family_type2==10),1,0)/sum(hh_f)),
              HH32=sum(ifelse((hh_f==1 &family_type2==20),1,0)/sum(hh_f)),
              HH33=sum(ifelse((hh_f==1 &family_type2==40),1,0)/sum(hh_f)),
              HH34=sum(ifelse((hh_f==1 &family_type2==50),1,0)/sum(hh_f)),
              HH35=sum(ifelse((hh_f==1 &family_type2==30),1,0)/sum(hh_f)),
              HH36=sum(ifelse((hh_f==1 &family_type2==9999),1,0)/sum(hh_f)),
              
              HH37=sum(hh_per[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH38=sum(hh_per[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH39=sum(hh_child18[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH40=sum(hh_child18[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH41=sum(hh_adult18[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH42=sum(hh_adult18[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH43=sum(hh_elderly65[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH44=sum(hh_elderly65[hh_F_headed!=0])/unique(WEIGHT_AF),
              
              HH45=sum(hh_spouses[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH46=sum(hh_spouses[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH47=sum(hh_childs[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH48=sum(hh_childs[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH49=sum(hh_other_relatives[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH50=sum(hh_other_relatives[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH51=sum(hh_non_relatives[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH52=sum(hh_non_relatives[hh_F_headed!=0])/unique(WEIGHT_AF),
              
              HH53=sum(hh_adult18M[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH54=sum(hh_adult18M[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH55=sum(hh_adult18F[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH56=sum(hh_adult18F[hh_F_headed!=0])/unique(WEIGHT_AF),
              
              HH20_29=sum(hh_child18[hh_headed2029!=0])/unique(WEIGHT_2029),
              HH30_39=sum(hh_child18[hh_headed3039!=0])/unique(WEIGHT_3039),
              HH40_49=sum(hh_child18[hh_headed4049!=0])/unique(WEIGHT_4049),
              HH50_59=sum(hh_child18[hh_headed5059!=0])/unique(WEIGHT_5059),
              HH60_69=sum(hh_child18[hh_headed6069!=0])/unique(WEIGHT_6069)
    )
  
}

system.time(
  PASO5_LIST<-parLapply(cl, PASO4_LIST, FUN_PASO5_LIST)
)

agrr_database_ipums <- data.table::rbindlist(PASO5_LIST)

save(agrr_database_ipums, file="N:\\Shared drives\\CORESIDENCE\\TEAM FOLDERS\\Juan Galeano\\AGGR_INDICATORS_IPUMS_2024.RData")

gc()

##### DHS #####
# READ ALL DHS FILES ####
setwd("i:\\Shared drives\\CORESIDENCE\\WP2_DATA\\2_1_Input Data\\DHS_ORIGINALS")

patt.shp <- ".*RData*"

data.shp <-list.files(pattern=patt.shp)

sample_DHS_LIST <- sapply(data.shp, function(x) mget(load(x)), simplify = TRUE) 

# DROP ELEMENT FROM LIST (100% NA in related) ####

sample_DHS_LIST[["JOR_1990_DHS.RData.df"]]<-NULL

sample_DHS_LIST[["UGA_2011B_DHS.RData.df"]]<-NULL

sample_DHS_LIST[["AGO_2006-07_DHS.RData.df"]]<-NULL #MIS
sample_DHS_LIST[["AGO_2011_DHS.RData.df"]]<-NULL #MIS

sample_DHS_LIST[["BGD_2014_DHS.RData.df"]]<-NULL #SPA
sample_DHS_LIST[["BGD_2017_DHS.RData.df"]]<-NULL #SPA

sample_DHS_LIST[["BFA_2014_DHS.RData.df"]]<-NULL # MIS
sample_DHS_LIST[["BFA_2017-18_DHS.RData.df"]]<-NULL # MIS

sample_DHS_LIST[["BDI_2012_DHS.RData.df"]]<-NULL # MIS

sample_DHS_LIST[["COG_2009_DHS.RData.df"]]<-NULL #AIS

sample_DHS_LIST[["CIV_2005_DHS.RData.df"]]<-NULL #AIS

sample_DHS_LIST[["DOM_2007B_DHS.RData.df"]]<-NULL # SPECIAL DHS
sample_DHS_LIST[["DOM_2013B_DHS.RData.df"]]<-NULL # SPECIAL DHS

#sample_DHS_LIST[["EGY_2003_DHS.RData.df"]]<-NULL # ITNERIM DHS

#sample_DHS_LIST[["ETH_2019_DHS.RData.df"]]<-NULL # ITNERIM DHS

sample_DHS_LIST[["GHA_2017_DHS.RData.df"]]<-NULL # SPECIAL
sample_DHS_LIST[["GHA_2019_DHS.RData.df"]]<-NULL # MIIS

sample_DHS_LIST[["GTM_1997_DHS.RData.df"]]<-NULL # MIIS

#sample_DHS_LIST[["GTM_1998-99_DHS.RData.df"]]<-NULL # interim

sample_DHS_LIST[["GIN_2021_DHS.RData.df"]]<-NULL # MIIS

sample_DHS_LIST[["GUY_2005_DHS.RData.df"]]<-NULL #AIS

sample_DHS_LIST[["HTI_2013_DHS.RData.df"]]<-NULL # SPA
sample_DHS_LIST[["HTI_2016_DHS.RData.df"]]<-NULL # SPA
sample_DHS_LIST[["HTI_2017-18_DHS.RData.df"]]<-NULL # SPA

#sample_DHS_LIST[["JOR_2009_DHS.RData.df"]]<-NULL # ITNERIM DHS

sample_DHS_LIST[["KEN_2015_DHS.RData.df"]]<-NULL # MIS
sample_DHS_LIST[["KEN_2020_DHS.RData.df"]]<-NULL # MIS

sample_DHS_LIST[["LBR_2009_DHS.RData.df"]]<-NULL # MIS
sample_DHS_LIST[["LBR_2011_DHS.RData.df"]]<-NULL # MIS
sample_DHS_LIST[["LBR_2016_DHS.RData.df"]]<-NULL # MIS

sample_DHS_LIST[["MDG_2011_DHS.RData.df"]]<-NULL # MIS
sample_DHS_LIST[["MDG_2013_DHS.RData.df"]]<-NULL # MIS
sample_DHS_LIST[["MDG_2016_DHS.RData.df"]]<-NULL # MIS

sample_DHS_LIST[["MWI_2012_DHS.RData.df"]]<-NULL # MIS
sample_DHS_LIST[["MWI_2014_DHS.RData.df"]]<-NULL # MIS
sample_DHS_LIST[["MWI_2017_DHS.RData.df"]]<-NULL # MIS

sample_DHS_LIST[["MLI_2010_DHS.RData.df"]]<-NULL # SPECIAL
sample_DHS_LIST[["MLI_2015_DHS.RData.df"]]<-NULL # MIS
sample_DHS_LIST[["MLI_2021_DHS.RData.df"]]<-NULL # MIS

sample_DHS_LIST[["MOZ_2015_DHS.RData.df"]]<-NULL # AIS
sample_DHS_LIST[["MOZ_2018_DHS.RData.df"]]<-NULL # MIS

sample_DHS_LIST[["NGA_2010_DHS.RData.df"]]<-NULL # MIS
sample_DHS_LIST[["NGA_2015_DHS.RData.df"]]<-NULL # MIS

#sample_DHS_LIST[["RWA_2007-08_DHS.RData.df"]]<-NULL # ITNERIM DHS
sample_DHS_LIST[["RWA_2013_DHS.RData.df"]]<-NULL # MIS
sample_DHS_LIST[["RWA_2017_DHS.RData.df"]]<-NULL # MIS

sample_DHS_LIST[["SEN_2006_DHS.RData.df"]]<-NULL # MIS
sample_DHS_LIST[["SEN_2008-09_DHS.RData.df"]]<-NULL # MIS
sample_DHS_LIST[["SEN_2016_DHS.RData.df"]]<-NULL # SPA
sample_DHS_LIST[["SEN_2020-21_DHS.RData.df"]]<-NULL # MIS

sample_DHS_LIST[["SLE_2013_DHS.RData.df"]]<-NULL # MIS
sample_DHS_LIST[["SLE_2016_DHS.RData.df"]]<-NULL # MIS

sample_DHS_LIST[["TZA_2003-04_DHS.RData.df"]]<-NULL # AIS
sample_DHS_LIST[["TZA_2008-09_DHS.RData.df"]]<-NULL # AIS
sample_DHS_LIST[["TZA_2011-12_DHS.RData.df"]]<-NULL # AIS
sample_DHS_LIST[["TZA_2017_DHS.RData.df"]]<-NULL # MIS

sample_DHS_LIST[["TGO_2017_DHS.RData.df"]]<-NULL # MIS

sample_DHS_LIST[["UGA_2009_DHS.RData.df"]]<-NULL # MIS
#sample_DHS_LIST[["UGA_2011B_DHS.RData.df"]]<-NULL # 
sample_DHS_LIST[["UGA_2011_DHS.RData.df"]]<-NULL # AIS
sample_DHS_LIST[["UGA_2014-15_DHS.RData.df"]]<-NULL # MIS
sample_DHS_LIST[["UGA_2018-19_DHS.RData.df"]]<-NULL # MIS

sample_DHS_LIST[["VNM_2005_DHS.RData.df"]]<-NULL # AIS

sample_DHS_LIST[["BRA_1991_DHS.RData.df"]]<-NULL # NORDEST SAMPLE

# CORE FILE DHS #####

FUN_CORE_DHS_LIST <-  function(df) {
  library(tidyverse)
  library(haven)
  library(readxl)
  ######  
  regionw <- read_excel("regionw.xlsx")
  df<-as_tibble(df)
  df$SOURCE<-"DHS"
  df$SAMPLE<-with(df,paste(country_control, year_control, SOURCE, sep="_"))
  df$PWEIGHT_A<-(df$HV005/1000000)
  df$hh<-1
  df$AGE<-as.numeric(df$HV105)
  df$YEAR<-as.numeric(substr(df$SAMPLE,5,8))
  #df<-df%>%drop_na(AGE)
  df$AGE[is.na(df$AGE), ] <- 999
  
  #df$AGE[is.na(df$AGE)] <- 999
  
  df$AGE2<-with(df,  ifelse(AGE==999, "999",
                            ifelse(AGE<=4, "0-4",
                                   ifelse(AGE<=9, "5-9", 
                                          ifelse(AGE<=14, "10-14",
                                                 ifelse(AGE<=19, "15-19",
                                                        ifelse(AGE<=24, "20-24",
                                                               ifelse(AGE<=29, "25-29",
                                                                      ifelse(AGE<=34, "30-34",
                                                                             ifelse(AGE<=39, "35-39",
                                                                                    ifelse(AGE<=44, "40-44",
                                                                                           ifelse(AGE<=49, "45-49",
                                                                                                  ifelse(AGE<=54, "50-54",
                                                                                                         ifelse(AGE<=59, "55-59",
                                                                                                                ifelse(AGE<=64, "60-64",
                                                                                                                       ifelse(AGE<=69, "65-69",
                                                                                                                              ifelse(AGE<=74, "70-74",
                                                                                                                                     ifelse(AGE<=79, "75-79",
                                                                                                                                            ifelse(AGE<=84, "80-84",
                                                                                                                                                   ifelse(AGE<=89, "85-89",
                                                                                                                                                          ifelse(AGE<=94, "90-94","95+")))))))))))))))))))))
  
  
  df$CENSUS_ROUND<-with(df,ifelse((YEAR>=1956 & YEAR <=1965), 1960,
                                  ifelse((YEAR>=1966 & YEAR <=1975), 1970,
                                         ifelse((YEAR>=1976 & YEAR <=1985), 1980,
                                                ifelse((YEAR>=1986 & YEAR <=1995), 1990,
                                                       ifelse((YEAR>=1996 & YEAR <=2005), 2000,
                                                              ifelse((YEAR>=2006 & YEAR <=2015), 2010,
                                                                     ifelse((YEAR>=2016 & YEAR <=2025), 2020,0))))))))
  
  df$DECADE<-with(df,ifelse((YEAR>=1951 & YEAR <=1960), 1950,
                            ifelse((YEAR>=1961 & YEAR <=1970), 1960,
                                   ifelse((YEAR>=1971 & YEAR <=1980), 1970,
                                          ifelse((YEAR>=1981 & YEAR <=1990), 1980,
                                                 ifelse((YEAR>=1991 & YEAR <=2000), 1990,
                                                        ifelse((YEAR>=2001 & YEAR <=2010), 2000,
                                                               ifelse((YEAR>=2011 & YEAR <=2020), 2010,
                                                                      ifelse((YEAR>=2021 & YEAR <=2030), 2020,0)))))))))
  
  df$FIVE_YEAR<-with(df,ifelse((YEAR>=1951 & YEAR <=1955), 1951,
                               ifelse((YEAR>=1956 & YEAR <=1960), 1956,
                                      ifelse((YEAR>=1961 & YEAR <=1965), 1961,
                                             ifelse((YEAR>=1966 & YEAR <=1970), 1966,
                                                    ifelse((YEAR>=1971 & YEAR <=1975), 1971,
                                                           ifelse((YEAR>=1976 & YEAR <=1980), 1976,
                                                                  ifelse((YEAR>=1981 & YEAR <=1985), 1981,
                                                                         ifelse((YEAR>=1986 & YEAR <=1990), 1986,
                                                                                ifelse((YEAR>=1991 & YEAR <=1995), 1991,
                                                                                       ifelse((YEAR>=1996 & YEAR <=2000), 1996,
                                                                                              ifelse((YEAR>=2001 & YEAR <=2005), 2001,
                                                                                                     ifelse((YEAR>=2006 & YEAR <=2010), 2006,
                                                                                                            ifelse((YEAR>=2011 & YEAR <=2015), 2011,
                                                                                                                   ifelse((YEAR>=2016 & YEAR <=2020), 2016,
                                                                                                                          ifelse((YEAR>=2021 & YEAR <=2025), 2021,0))))))))))))))))
  
  
  
  df$HV101b<-as.character(as_factor(df$HV101))
  df$HV101b[is.na(df$HV101b)] <- "Missing"
  ######  
  df<-df%>%
    mutate(HV101c=case_when(HV101b == "Head" ~ "Head", #
                            
                            HV101b == "Wife or husband"  ~ "Wife or husband",#
                            
                            HV101b == "Son/daughter" ~ "Son/daughter",#
                            
                            HV101b == "Son/daughter-in-law" ~ "Son/daughter-in-law", #
                            HV101b == "Son/daughter of wife or husband {CG}" ~ "Son/daughter-in-law",
                            HV101b == "Step-son/step-daughter" ~ "Stepchild",
                            HV101b == "Step child" ~ "Stepchild",# stepchid
                            HV101b == "Stepchild" ~ "Stepchild",# stepchid
                            HV101b == "Stepson/daughter" ~ "Stepchild",# stepchid
                            
                            HV101b == "Grandchild" ~ "Grandchild",# 
                            
                            HV101b == "Parent" ~ "Parent",# 
                            HV101b == "Parent-in-law" ~ "Parent-in-law",
                            HV101b == "Parent / parent-in-law" ~ "Parent/parent-in-law",
                            HV101b == "Parent/ parent-in-law" ~ "Parent/parent-in-law",
                            HV101b == "Parent/parent-in-law" ~ "Parent/parent-in-law",
                            HV101b == "Parents,p. in-law" ~ "Parent/parent-in-law",
                            HV101b == "Parents/ parent-in-law" ~ "Parent/parent-in-law",
                            
                            HV101b == "Brother/sister" ~ "Brother/sister",#
                            
                            HV101b == "Co-spouse" ~ "Co-spouse",#
                            HV101b == "Cohabiting partner" ~ "Cohabiting partner",
                            
                            HV101b == "Aunts/uncle"  ~ "Aunts/uncle",#
                            HV101b == "Uncle/aunt"  ~ "Aunts/uncle",
                            HV101b == "Uncle/Aunt/Other relative"  ~ "Other relative",
                            HV101b == "Brother-in-law or sister-in-law" ~ "Brother-in-law/sister-in-law",
                            HV101b == "Brother-in-law/sister-in-law" ~ "Brother-in-law/sister-in-law",
                            HV101b == "Brother or sister-in-law" ~ "Brother-in-law/sister-in-law",
                            HV101b == "Brother/sister-in-law" ~ "Brother-in-law/sister-in-law",
                            HV101b == "Brother/sister in law" ~ "Brother-in-law/sister-in-law",
                            HV101b == "Brother/Sister in law" ~ "Brother-in-law/sister-in-law",
                            HV101b == "Sister brother-in-law" ~ "Brother-in-law/sister-in-law",
                            HV101b == "Sister/ brother in law" ~ "Brother-in-law/sister-in-law",
                            HV101b == "other relative" ~ "Other relative",
                            HV101b == "Other relative" ~ "Other relative",
                            
                            HV101b == "Adopted child" ~ "Adopted",# adopted
                            HV101b == "Adopted/foster child" ~ "Adopted/foster child",#
                            HV101b == "Adopted/ foster/ stepchild" ~ "Adopted/foster child",
                            HV101b == "Adopted/foster child" ~ "Adopted/foster child",
                            HV101b == "Adopted/foster child/child of wife / husband" ~ "Adopted/foster child",
                            HV101b == "Adopted/foster child/step child" ~ "Adopted/foster child",
                            HV101b == "Adopted/foster child/stepchild" ~ "Adopted/foster child",
                            HV101b == "Adopted/foster/step child" ~ "Adopted/foster child",
                            HV101b == "Adopted/foster/stepchild" ~ "Adopted/foster child",
                            HV101b == "Foster" ~ "Foster child", #foster
                            
                            HV101b == "Domestic" ~ "Domestic",#
                            HV101b == "Domestic employee" ~ "Domestic",
                            HV101b == "Domestic employee (CS)" ~ "Domestic",
                            HV101b == "Domestic servant" ~ "Domestic",
                            HV101b == "Domestic service" ~ "Domestic",
                            HV101b == "Domestic worker" ~ "Domestic",
                            HV101b == "Related to house maid" ~ "Related to house maid",
                            HV101b == "Herdboy" ~ "Herdboy",
                            HV101b == "Herdboy (CS)" ~ "Herdboy",
                            HV101b == "House maid" ~ "Domestic",
                            HV101b == "Housekeeper" ~ "Domestic",
                            HV101b == "In-house maid" ~ "Domestic",
                            HV101b == "Maid" ~ "Domestic",
                            HV101b == "Maid / domestic worker" ~ "Domestic",
                            HV101b == "Not related" ~ "Not related",
                            HV101b == "Tenant" ~ "Tenant",
                            
                            
                            HV101b == "Nephew/niece" ~ "Niece/nephew",
                            HV101b == "Nephew/niece in law" ~ "Niece/nephew in law",
                            HV101b == "Niece/ nephew by blood" ~ "Niece/nephew by blood",
                            HV101b == "Niece/ nephew by marriage" ~ "Niece/nephew by marriage",
                            HV101b == "Niece/nehew by blood" ~ "Niece/nephew by blood",
                            HV101b == "Niece/nephew" ~ "Niece/nephew",
                            HV101b == "Niece/nephew by blood" ~ "Niece/nephew by blood",
                            HV101b == "Niece/nephew by marriage" ~ "Niece/nephew by marriage", 
                            
                            HV101b == "DK" ~ "Don't know", #
                            HV101b == "Don't know" ~ "Don't know",
                            
                            HV101b == "Missing" ~ "Missing", #
                            
                            HV101b == "Mother not listed" ~ "Mother not listed",#
                            
                            HV101b == "Grand-parent" ~ "Grandparent",
                            HV101b == "Grand father/mother" ~ "Grandparent",
                            HV101b == "Grand parents" ~ "Grandparent",
                            HV101b == "Grandparent" ~ "Grandparent",
                            
                            HV101b == "Great grandson/granddaughter" ~ "Great grandchild")) ###greatgrandchild
  
  
  df<-df%>%
    mutate(RELATE=case_when(HV101c == "Head" ~ 1,#
                            
                            HV101c == "Wife or husband" ~ 2,#
                            HV101c == "Co-spouse" ~ 2,#
                            HV101c == "Cohabiting partner" ~ 2,#
                            
                            HV101c == "Son/daughter" ~ 3,#
                            HV101c == "Son/daughter-in-law" ~ 3,#
                            HV101c == "Stepchild" ~ 3,
                            
                            HV101c == "Adopted" ~ 3,#
                            HV101c == "Adopted/foster child" ~ 3,#
                            HV101c == "Foster child" ~ 3,#
                            
                            HV101c == "Grandchild" ~ 4,#
                            
                            HV101c == "Parent" ~ 4,#
                            HV101c == "Parent-in-law"~ 4,#
                            HV101c == "Parent/parent-in-law"~ 4,#
                            
                            HV101c == "Brother/sister" ~ 4,#
                            HV101c == "Aunts/uncle" ~ 4,#
                            HV101c == "Brother-in-law/sister-in-law" ~ 4,#
                            
                            HV101c == "Niece/nephew" ~ 4,
                            HV101c == "Niece/nephew in law" ~ 4,
                            HV101c == "Niece/nephew by blood" ~ 4,
                            HV101c == "Niece/nephew by marriage" ~ 4,
                            
                            
                            HV101c == "Mother not listed" ~ 4,#
                            HV101c == "Grandparent" ~ 4,
                            HV101c == "Great grandchild" ~ 4,
                            HV101c == "Other relative" ~ 4,#
                            
                            HV101c == "Domestic" ~ 5,#
                            HV101c == "Related to house maid" ~ 5,#
                            HV101c == "Herdboy" ~ 5,#
                            HV101c == "Tenant" ~ 5,#
                            HV101c == "Not related" ~ 5,#
                            
                            HV101c == "Don't know" ~ 9,#
                            HV101c == "Missing" ~ 8),
           
           RELATED=case_when(HV101c == "Head" ~ 1000,#
                             
                             HV101c == "Wife or husband" ~ 2100,#
                             HV101c == "Co-spouse" ~ 2110,#
                             HV101c == "Cohabiting partner" ~ 2200,#
                             
                             HV101c == "Son/daughter" ~ 3100,#
                             HV101c == "Son/daughter-in-law" ~ 3400,#
                             HV101c == "Stepchild" ~ 3300,
                             
                             HV101c == "Adopted" ~ 3200,#
                             HV101c == "Adopted/foster child" ~ 3210,#
                             HV101c == "Foster child" ~ 3220,#
                             
                             HV101c == "Grandchild" ~ 4100,#
                             
                             HV101c == "Parent" ~ 4210,#
                             HV101c == "Parent-in-law"~ 4220,#
                             HV101c == "Parent/parent-in-law"~ 4200,#
                             
                             HV101c == "Brother/sister" ~ 4410,#
                             HV101c == "Aunts/uncle" ~ 4700,#
                             HV101c == "Brother-in-law/sister-in-law" ~ 4430,#
                             
                             HV101c == "Niece/nephew" ~ 4810,
                             HV101c == "Niece/nephew in law" ~ 4811,
                             HV101c == "Niece/nephew by blood" ~ 4812,
                             HV101c == "Niece/nephew by marriage" ~ 4813,
                             
                             
                             HV101c == "Mother not listed" ~ 4920,#
                             HV101c == "Grandparent" ~ 4500,
                             HV101c == "Great grandchild" ~ 4120,
                             HV101c == "Other relative" ~ 4900,#
                             
                             HV101c == "Domestic" ~ 5210,#
                             HV101c == "Related to house maid" ~ 5220,#
                             HV101c == "Herdboy" ~ 5230,#
                             HV101c == "Tenant" ~ 5700,#
                             HV101c == "Not related" ~ 5900,#
                             
                             HV101c == "Don't know" ~ 9999,#
                             HV101c == "Missing" ~ 8888))#
  
  
  df$RELATE<-labelled(x=df$RELATE,
                      labels=c("Head"=1, 
                               "Spouse/partner"=2,
                               "Child"=3, 
                               "Other relative"=4,
                               "Non-relative"=5,
                               "Other relative or non-relative"=6,
                               "Missing" = 8,
                               "Unknown"=9),
                      label="Relationship to household head [general version]")
  
  
  df$RELATED<-labelled(x=df$RELATED,
                       labels=c("Head" = 1000,#
                                "Spouse" = 2100,#
                                "Co-Spouse"=2110,
                                "Unmarried partner"= 2200,#
                                
                                "Biological child" = 3100,#
                                "Adopted child" = 3200,#
                                "Adopted/foster child" = 3210,#
                                "Foster child"= 3220,#
                                "Stepchild" = 3300,#
                                "Child/child-in-law" = 3400,#
                                
                                "Grandchild" = 4100,#
                                "Parent" = 4210,#
                                "Parent-in-law" = 4220,
                                "Parent/parent-in-law" = 4200,
                                
                                "Sibling" = 4410,#
                                "Aunt/uncle" = 4700,#
                                "Sibling-in-law" = 4430,#
                                
                                "Nephew/niece" = 4810,#
                                "Niece/nephew in law" = 4811,#
                                "Niece/nephew by blood" = 4812,#
                                "Niece/nephew by marriage" = 4813,#
                                
                                "Other relative, not elsewhere classified" = 4900,#
                                "Other relative with different family name"=4920,
                                "Grandparent" = 4500,#
                                "Great grandchild" = 4120,
                                
                                "Domestic employee" = 5210,#
                                "Relative of employee, n.s." = 5220,#
                                "Herdboy"=5230,
                                "Tenant"=5700,
                                "Non-relative, n.e.c." = 5900,#
                                
                                "Unknown " = 9999,
                                "Missing " = 8888), #
                       label="Relationship to household head [detailed version]")
  
  regionw<-as.data.frame(regionw)
  df<-as.data.frame(df)
  df<- data.frame(df,
                  regionw[match(df[,"country_control"],
                                regionw[,"ISO3"]),c("REGIONW")])
  colnames(df)[grep(names(df %>% select(last_col())), colnames(df))]<-"REGIONW"
  
  df<-df%>%
    mutate(CONTINENT=case_when(REGIONW == 11 ~ "Eastern Africa",
                               REGIONW == 12 ~ "Middle Africa",
                               REGIONW == 13 ~ "Northern Africa",
                               REGIONW == 14 ~ "Southern Africa",
                               REGIONW == 15 ~ "Western Africa",
                               REGIONW == 21 ~ "Caribbean" ,
                               REGIONW == 22 ~ "Central America" ,
                               REGIONW == 23 ~ "South America" ,
                               REGIONW == 24 ~ "North America",
                               REGIONW == 31 ~ "Central Asia",
                               REGIONW == 32 ~ "Eastern Asia",
                               REGIONW == 33 ~ "Southern Asia" ,
                               REGIONW == 34 ~ "South-Eastern Asia",
                               REGIONW == 35 ~ "Western Asia",
                               REGIONW == 41 ~ "Eastern Europe" ,
                               REGIONW == 42 ~ "Northern Europe" ,
                               REGIONW == 43 ~ "Southern Europe",
                               REGIONW == 44 ~ "Western Europe",
                               REGIONW == 51 ~ "Australia and New Zealand" ,
                               REGIONW == 52 ~ "Melanesia",
                               REGIONW == 53 ~ "Micronesia",
                               REGIONW == 54 ~ "Polynesia"))
  
  df<-df%>%
    mutate(CONT2=case_when(CONTINENT == "Eastern Africa" ~ "AFRICA",
                           CONTINENT == "Middle Africa" ~ "AFRICA",
                           CONTINENT == "Northern Africa" ~ "AFRICA",
                           CONTINENT == "Southern Africa" ~ "AFRICA",
                           CONTINENT == "Western Africa" ~ "AFRICA",
                           CONTINENT == "Caribbean" ~ "LATIN-AMERICA",
                           CONTINENT == "Central America" ~ "LATIN-AMERICA",
                           CONTINENT == "South America" ~ "LATIN-AMERICA",
                           CONTINENT == "North America" ~ "NORTH-AMERICA",
                           CONTINENT == "Central Asia" ~ "ASIA",
                           CONTINENT == "Eastern Asia" ~ "ASIA",
                           CONTINENT == "Southern Asia" ~ "ASIA",
                           CONTINENT == "South-Eastern Asia" ~ "ASIA",
                           CONTINENT == "Western Asia" ~ "ASIA",
                           CONTINENT == "Eastern Europe" ~ "EUROPE",
                           CONTINENT == "Northern Europe" ~ "EUROPE",
                           CONTINENT == "Southern Europe" ~ "EUROPE",
                           CONTINENT == "Western Europe" ~ "EUROPE",
                           CONTINENT == "Australia and New Zealand" ~ "OCEANIA",
                           CONTINENT == "Melanesia" ~ "OCEANIA",
                           CONTINENT == "Micronesia" ~ "OCEANIA",
                           CONTINENT == "Polynesia" ~ "OCEANIA"))
}

system.time(
  CORE_DHS_LIST<-parLapply(cl, sample_DHS_LIST, FUN_CORE_DHS_LIST)
)

FUN_PASO1_DHS_LIST <-  function(df) {
  library(tidyverse)
  library(haven)  
  df$HV104[is.na(df$HV104)] <- 3 #(NA, missing)
  df<-df %>%
    add_count(HHID)%>%
    mutate(child5=ifelse(AGE<=4,1,0),
           adult18=ifelse(AGE>=18,1,0),
           adult18M=ifelse((AGE>=18&HV104==1),1,0),
           adult18F=ifelse((AGE>=18&HV104==2),1,0),
           child18=ifelse(AGE<18,1,0),
           elderly65=ifelse(AGE>=65,1,0),
           
           age00_09=ifelse((AGE2=="0-4"|AGE2=="5-9"),1,0),
           age10_19=ifelse((AGE2=="10-14"|AGE2=="15-19"),1,0),
           age20_29=ifelse((AGE2=="20-24"|AGE2=="25-29"),1,0),
           age30_39=ifelse((AGE2=="30-34"|AGE2=="35-39"),1,0),
           age40_49=ifelse((AGE2=="40-44"|AGE2=="45-49"),1,0),
           age50_59=ifelse((AGE2=="50-54"|AGE2=="55-59"),1,0),
           age60_69=ifelse((AGE2=="60-64"|AGE2=="65-69"),1,0),
           age70_79=ifelse((AGE2=="70-74"|AGE2=="75-79"),1,0),
           age80=ifelse(AGE>=80,1,0),
           
           heads=ifelse(RELATE==1,1,0), 
           spouses=ifelse(RELATE==2,1,0),
           childs=ifelse(RELATE==3,1,0),
           other_relatives=ifelse(RELATE==4,1,0),
           non_relatives=ifelse(RELATE==5,1,0),
           other_rel_or_non_rel=ifelse(RELATE==6,1,0),
           
           grandchilds=ifelse(RELATED %in% c(4100, 4110,4120,4130),1,0),
           parents=ifelse(RELATED %in% c(4200,4210,4211,4220 ),1,0),
           siblings=ifelse(RELATED %in% c(4400,4410,4420,4430,4431,4432),1,0),
           
           WEIGHT_POP= sum(PWEIGHT_A,na.rm = TRUE)*1,
           #WEIGHT_A= sum(df[df$RELATE==1,"PWEIGHT_A"]),
           WEIGHT_A= sum(PWEIGHT_A[RELATE==1]),
           WEIGHT_A2= sum(PWEIGHT_A[RELATE==1&n==2]),
           WEIGHT_A3= sum(PWEIGHT_A[RELATE==1&n==3]),
           WEIGHT_A4= sum(PWEIGHT_A[RELATE==1&n==4]),
           WEIGHT_A5= sum(PWEIGHT_A[RELATE==1&n==5]),
           WEIGHT_AM= sum(PWEIGHT_A[RELATE==1&HV104==1]),
           WEIGHT_AF= sum(PWEIGHT_A[RELATE==1&HV104==2]),
           WEIGHT_2029=sum(PWEIGHT_A[RELATE==1&age20_29==1]),
           WEIGHT_3039=sum(PWEIGHT_A[RELATE==1&age30_39==1]),
           WEIGHT_4049=sum(PWEIGHT_A[RELATE==1&age40_49==1]),
           WEIGHT_5059=sum(PWEIGHT_A[RELATE==1&age50_59==1]),
           WEIGHT_6069=sum(PWEIGHT_A[RELATE==1&age60_69==1]),
           
           M_headed=ifelse((RELATE==1 & HV104==1),1,0),
           F_headed=ifelse((RELATE==1 & HV104==2),1,0),
           headed2029=ifelse((RELATE==1 &age20_29==1),1,0), 
           headed3039=ifelse((RELATE==1 &age30_39==1),1,0),
           headed4049=ifelse((RELATE==1 &age40_49==1),1,0),
           headed5059=ifelse((RELATE==1 &age50_59==1),1,0),
           headed6069=ifelse((RELATE==1 &age60_69==1),1,0))
   
}

system.time(
  PASO1_DHS_LIST<-parLapply(cl, CORE_DHS_LIST, FUN_PASO1_DHS_LIST)
)

rm(CORE_DHS_LIST)
gc()

FUN_PASO2_DHS_LIST <-  function(df) {
  library(tidyverse)
  library(haven) 
  df<-df|>
    group_by(HHID)|>
    mutate(hh_per1=n(),
           hh_parents=sum(parents*PWEIGHT_A),
           hh_grandchilds=sum(grandchilds*PWEIGHT_A),
           hh_heads=sum(heads*PWEIGHT_A),
           hh_spouses=sum(spouses*PWEIGHT_A),
           hh_childs=sum(childs*PWEIGHT_A),
           hh_other_relatives=sum(other_relatives*PWEIGHT_A),
           hh_non_relatives=sum(non_relatives*PWEIGHT_A),
           hh_other_rel_or_non_rel=sum(other_rel_or_non_rel*PWEIGHT_A))|>
    mutate(family_type= #ifelse(hh_per1==1, 10, # unipersonal households 
             ifelse(hh_per1==1, 10, # unipersonal households 
                           ifelse(hh_spouses>0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20, #nuclear 
                                  ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives ==0 & hh_non_relatives==0,20,#nuclear 
                                         ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20,#nuclear 
                                                
                                                
                                                ifelse(hh_spouses>0 & hh_childs>0 &  hh_other_relatives >0 & hh_non_relatives==0,31,# nuclear + other relatives
                                                       ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives >0 & hh_non_relatives==0,31,
                                                              ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives >0 & hh_non_relatives==0,31,
                                                                     
                                                                     ifelse(hh_spouses>0 & hh_childs>0 &  hh_other_relatives ==0 & hh_non_relatives>0,32,
                                                                            ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives ==0 & hh_non_relatives>0,32,
                                                                                   ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives>0,32,       
                                                                                          
                                                                                          ifelse(hh_spouses>0 & hh_childs>0 &  hh_other_relatives >0 & hh_non_relatives>0,33,
                                                                                                 ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives >0 & hh_non_relatives>0,33,
                                                                                                        ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives >0 & hh_non_relatives>0,33,        
                                                                                                               
                                                                                                               ifelse(hh_spouses==0 & hh_childs==0 &  hh_other_relatives >0 & hh_non_relatives==0,34,
                                                                                                                      ifelse(hh_spouses==0 & hh_childs==0 &  hh_other_relatives ==0 & hh_non_relatives>0,35,
                                                                                                                             ifelse(hh_spouses==0 & hh_childs==0 &  hh_other_relatives >0 & hh_non_relatives>0,36,
                                                                                                                                    0)))))))))))))))))|>
    mutate(family_type2=ifelse(hh_per1==1, 10,
                               ifelse(hh_spouses>0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20,
                                      ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives ==0 & hh_non_relatives==0,20,
                                             ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20,       
                                                    ifelse(hh_non_relatives>0,30, # "Other non family",
                                                           ifelse((hh_parents>0 | hh_grandchilds>0),40,# "Stem family",
                                                                  ifelse(hh_other_relatives>0,50, 9999))))))))|>
    
    mutate(family_type3=ifelse(any(F_headed==1)&(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0),21,9999))|>#monomarental )
    ungroup()
  
}

system.time(
  PASO2_DHS_LIST<-parLapply(cl, PASO1_DHS_LIST, FUN_PASO2_DHS_LIST)
)

rm(PASO1_DHS_LIST)
gc()

FUN_PASO3_DHS_LIST <-  function(df) {
  library(tidyverse)
  library(haven) 
  df<-df |>
    mutate(#WEIGHT_FT10= sum(PWEIGHT[family_type==10]),
      WEIGHT_FT10= sum(PWEIGHT_A[family_type==10]),
      WEIGHT_FT20= sum(PWEIGHT_A[RELATE==1&family_type==20]),
      WEIGHT_FT31= sum(PWEIGHT_A[RELATE==1&family_type==31]),
      WEIGHT_FT32= sum(PWEIGHT_A[RELATE==1&family_type==32]),
      WEIGHT_FT33= sum(PWEIGHT_A[RELATE==1&family_type==33]),
      WEIGHT_FT34= sum(PWEIGHT_A[RELATE==1&family_type==34]),
      WEIGHT_FT35= sum(PWEIGHT_A[RELATE==1&family_type==35]),
      WEIGHT_FT36= sum(PWEIGHT_A[RELATE==1&family_type==36]),
      WEIGHT_FT00= sum(PWEIGHT_A[RELATE==1&family_type==0]),
      
      WEIGHT_FT210= sum(PWEIGHT_A[family_type2==10]),
      WEIGHT_FT220= sum(PWEIGHT_A[RELATE==1&family_type2==20]),
      WEIGHT_FT230= sum(PWEIGHT_A[RELATE==1&family_type2==30]),
      WEIGHT_FT240= sum(PWEIGHT_A[RELATE==1&family_type2==40]),
      WEIGHT_FT250= sum(PWEIGHT_A[RELATE==1&family_type2==50]),
      WEIGHT_FT299= sum(PWEIGHT_A[RELATE==1&family_type2==9999]),
      
      WEIGHT_FT321= sum(PWEIGHT_A[RELATE==1&family_type3==21])
    )  
  
} 

system.time(
  PASO3_DHS_LIST<-parLapply(cl, PASO2_DHS_LIST, FUN_PASO3_DHS_LIST)
)

rm(PASO2_DHS_LIST)
gc()

FUN_PASO4_DHS_LIST <-  function(df) {
  library(tidyverse)
  library(haven)
  df<-df |> 
  group_by(SAMPLE,country_control,YEAR,HHID,CONTINENT,
           SOURCE,CENSUS_ROUND,DECADE,FIVE_YEAR,CONT2,
           WEIGHT_POP,WEIGHT_A,WEIGHT_A2,WEIGHT_A3,WEIGHT_A4,
           WEIGHT_A5, WEIGHT_AM,WEIGHT_AF,WEIGHT_2029,WEIGHT_3039,WEIGHT_4049,
           WEIGHT_5059,WEIGHT_6069,
           WEIGHT_FT10,
           WEIGHT_FT20,
           WEIGHT_FT31,WEIGHT_FT32,WEIGHT_FT33,WEIGHT_FT34,WEIGHT_FT35,
           WEIGHT_FT36,WEIGHT_FT00,WEIGHT_FT210,WEIGHT_FT220,WEIGHT_FT230,
           WEIGHT_FT240,WEIGHT_FT250,WEIGHT_FT299,
           WEIGHT_FT321,
           family_type,
           family_type2,
           family_type3)|>
    summarise(hh=1,
              hh_per1=n(),
              hh_m=sum(M_headed),
              hh_f=sum(F_headed),
              hh_per=sum(hh*PWEIGHT_A),
              hh_child5=sum(child5*PWEIGHT_A),
              hh_adult18=sum(adult18*PWEIGHT_A),
              hh_adult18b=sum(adult18),
              
              hh_00_09=sum(age00_09*PWEIGHT_A),
              hh_10_19=sum(age10_19*PWEIGHT_A),
              hh_20_29=sum(age20_29*PWEIGHT_A),
              hh_30_39=sum(age30_39*PWEIGHT_A),
              hh_40_49=sum(age40_49*PWEIGHT_A),
              hh_50_59=sum(age50_59*PWEIGHT_A),
              hh_60_69=sum(age60_69*PWEIGHT_A),
              hh_70_79=sum(age70_79*PWEIGHT_A),
              hh_80=sum(age80*PWEIGHT_A),
              
              hh_adult18M=sum(adult18M*PWEIGHT_A),
              hh_adult18F=sum(adult18F*PWEIGHT_A),
              hh_adult18Mb=sum(adult18M),
              
              hh_child18=sum(child18*PWEIGHT_A),
              hh_elderly65=sum(elderly65*PWEIGHT_A),
              
              hh_heads=sum(heads*PWEIGHT_A),
              hh_spouses=sum(spouses*PWEIGHT_A),
              hh_childs=sum(childs*PWEIGHT_A),
              hh_other_relatives=sum(other_relatives*PWEIGHT_A),
              hh_non_relatives=sum(non_relatives*PWEIGHT_A),
              hh_other_rel_or_non_rel=sum(other_rel_or_non_rel*PWEIGHT_A),
              
              hh_grandchilds=sum(grandchilds*PWEIGHT_A),
              hh_parents=sum(parents*PWEIGHT_A),
              hh_siblings=sum(siblings*PWEIGHT_A), 
              hh_M_headed=sum(M_headed*PWEIGHT_A),
              hh_F_headed=sum(F_headed*PWEIGHT_A),
              hh_headed2029=sum(headed2029*PWEIGHT_A),
              hh_headed3039=sum(headed3039*PWEIGHT_A),
              hh_headed4049=sum(headed4049*PWEIGHT_A),
              hh_headed5059=sum(headed5059*PWEIGHT_A),
              hh_headed6069=sum(headed6069*PWEIGHT_A)
    )|>
    ungroup()
} 
  
system.time(
  PASO4_DHS_LIST<-parLapply(cl, PASO3_DHS_LIST, FUN_PASO4_DHS_LIST)
)


FUN_PASO5_DHS_LIST <-  function(df) {
  library(tidyverse)
  library(haven)
  df<-df |>
    group_by(country_control,YEAR,SOURCE,SAMPLE,CONTINENT,CONT2,CENSUS_ROUND,DECADE,FIVE_YEAR)|>
    summarise(WPOP=round(unique(WEIGHT_POP),0),
              
              HS01=sum(ifelse(hh_per1==1,hh,0))/sum(hh),
              HS02=sum(ifelse(hh_per1==2,hh,0))/sum(hh),
              HS03=sum(ifelse(hh_per1==3,hh,0))/sum(hh),
              HS04=sum(ifelse(hh_per1==4,hh,0))/sum(hh),
              HS05=sum(ifelse(hh_per1==5,hh,0))/sum(hh),
              HS06=sum(ifelse(hh_per1==6,hh,0))/sum(hh),
              HS07=sum(ifelse(hh_per1==7,hh,0))/sum(hh),
              HS08=sum(ifelse(hh_per1==8,hh,0))/sum(hh),
              HS09=sum(ifelse(hh_per1==9,hh,0))/sum(hh),
              HS10=sum(ifelse(hh_per1==10,hh,0))/sum(hh),
              HS11=sum(ifelse(hh_per1>10,hh,0))/sum(hh),
              HS12=sum(ifelse((hh_per1==2|hh_per1==3),hh,0))/sum(hh),
              HS13=sum(ifelse((hh_per1==4|hh_per1==5),hh,0))/sum(hh),
              HS14=sum(ifelse(hh_per1>=6,hh,0))/sum(hh),
              HS15=sum(hh_child5 != 0)/sum(hh),
              HS16=sum(hh_elderly65 != 0)/sum(hh),
              HS17=sum(hh_per)/unique(WEIGHT_A),
              HS18=sum(hh_child5)/unique(WEIGHT_A),
              HS19=sum(hh_adult18)/unique(WEIGHT_A),
              HS20=sum(hh_child18)/unique(WEIGHT_A),
              HS21=sum(hh_elderly65)/unique(WEIGHT_A),
              HS22=sum(hh_00_09)/unique(WEIGHT_A),
              HS23=sum(hh_10_19)/unique(WEIGHT_A),
              HS24=sum(hh_20_29)/unique(WEIGHT_A),
              HS25=sum(hh_30_39)/unique(WEIGHT_A),
              HS26=sum(hh_40_49)/unique(WEIGHT_A),
              HS27=sum(hh_50_59)/unique(WEIGHT_A),
              HS28=sum(hh_60_69)/unique(WEIGHT_A),
              HS29=sum(hh_70_79)/unique(WEIGHT_A),
              HS30=sum(hh_80)/unique(WEIGHT_A),
              
              HR01=sum(hh_heads)/unique(WEIGHT_A),
              HR02=sum(hh_spouses)/unique(WEIGHT_A),
              HR03=sum(hh_childs)/unique(WEIGHT_A),
              HR04=sum(hh_other_relatives)/unique(WEIGHT_A),
              HR05=sum(hh_non_relatives)/unique(WEIGHT_A),
              HR06=sum(hh_other_rel_or_non_rel)/unique(WEIGHT_A),
              
              HR07=sum(hh_heads[hh_per1==2])/unique(WEIGHT_A2),
              HR08=sum(hh_spouses[hh_per1==2])/unique(WEIGHT_A2),
              HR09=sum(hh_childs[hh_per1==2])/unique(WEIGHT_A2),
              HR10=sum(hh_other_relatives[hh_per1==2])/unique(WEIGHT_A2),
              HR11=sum(hh_non_relatives[hh_per1==2])/unique(WEIGHT_A2),
              HR12=sum(hh_other_rel_or_non_rel[hh_per1==2])/unique(WEIGHT_A2),
              
              HR13=sum(hh_heads[hh_per1==3])/unique(WEIGHT_A3),
              HR14=sum(hh_spouses[hh_per1==3])/unique(WEIGHT_A3),
              HR15=sum(hh_childs[hh_per1==3])/unique(WEIGHT_A3),
              HR16=sum(hh_other_relatives[hh_per1==3])/unique(WEIGHT_A3),
              HR17=sum(hh_non_relatives[hh_per1==3])/unique(WEIGHT_A3),
              HR18=sum(hh_other_rel_or_non_rel[hh_per1==3])/unique(WEIGHT_A3),
              
              HR19=sum(hh_heads[hh_per1==4])/unique(WEIGHT_A4),
              HR20=sum(hh_spouses[hh_per1==4])/unique(WEIGHT_A4),
              HR21=sum(hh_childs[hh_per1==4])/unique(WEIGHT_A4),
              HR22=sum(hh_other_relatives[hh_per1==4])/unique(WEIGHT_A4),
              HR23=sum(hh_non_relatives[hh_per1==4])/unique(WEIGHT_A4),
              HR24=sum(hh_other_rel_or_non_rel[hh_per1==4])/unique(WEIGHT_A4),
              
              HR25=sum(hh_heads[hh_per1==5])/unique(WEIGHT_A5),
              HR26=sum(hh_spouses[hh_per1==5])/unique(WEIGHT_A5),
              HR27=sum(hh_childs[hh_per1==5])/unique(WEIGHT_A5),
              HR28=sum(hh_other_relatives[hh_per1==5])/unique(WEIGHT_A5),
              HR29=sum(hh_non_relatives[hh_per1==5])/unique(WEIGHT_A5),
              HR30=sum(hh_other_rel_or_non_rel[hh_per1==5])/unique(WEIGHT_A5),
              
              HT01=sum(ifelse(family_type==10,1,0)/sum(hh)),
              HT02=sum(ifelse(family_type==20,1,0)/sum(hh)),
              HT03=sum(ifelse(family_type==31,1,0)/sum(hh)),
              HT04=sum(ifelse(family_type==32,1,0)/sum(hh)),
              HT05=sum(ifelse(family_type==33,1,0)/sum(hh)),
              HT06=sum(ifelse(family_type==34,1,0)/sum(hh)),
              HT07=sum(ifelse(family_type==35,1,0)/sum(hh)),
              HT08=sum(ifelse(family_type==36,1,0)/sum(hh)),
              HT09=sum(ifelse(family_type==0,1,0)/sum(hh)),
              
              HT10=sum(hh_per[family_type==10])/unique(WEIGHT_FT10),
              HT11=sum(hh_per[family_type==20])/unique(WEIGHT_FT20),
              HT12=sum(hh_per[family_type==31])/unique(WEIGHT_FT31),
              HT13=sum(hh_per[family_type==32])/unique(WEIGHT_FT32),
              HT14=sum(hh_per[family_type==33])/unique(WEIGHT_FT33),
              HT15=sum(hh_per[family_type==34])/unique(WEIGHT_FT34),
              HT16=sum(hh_per[family_type==35])/unique(WEIGHT_FT35),
              HT17=sum(hh_per[family_type==36])/unique(WEIGHT_FT36),
              HT18=sum(hh_per[family_type==0])/unique(WEIGHT_FT00),
              
              HT20=sum(ifelse(family_type2==10,1,0)/sum(hh)),
              HT21=sum(ifelse(family_type2==20,1,0)/sum(hh)),
              HT22=sum(ifelse(family_type2==40,1,0)/sum(hh)),
              HT23=sum(ifelse(family_type2==50,1,0)/sum(hh)),
              HT24=sum(ifelse(family_type2==30,1,0)/sum(hh)),
              HT25=sum(ifelse(family_type2==9999,1,0)/sum(hh)),
              HT26=sum(hh_per[family_type2==10])/unique(WEIGHT_FT210),
              HT27=sum(hh_per[family_type2==20])/unique(WEIGHT_FT220),
              HT28=sum(hh_per[family_type2==40])/unique(WEIGHT_FT240),
              HT29=sum(hh_per[family_type2==50])/unique(WEIGHT_FT250),
              HT30=sum(hh_per[family_type2==30])/unique(WEIGHT_FT230),
              HT31=sum(hh_per[family_type2==9999])/unique(WEIGHT_FT299),
              
              HH01=sum(hh_M_headed[hh_M_headed!=0])/unique(WEIGHT_A),
              HH02=sum(hh_F_headed[hh_F_headed!=0])/unique(WEIGHT_A),
              
              HH03=sum(ifelse((hh_m==1 &hh_per1==1),hh,0))/sum(hh_m),
              HH04=sum(ifelse((hh_m==1 &hh_per1==2),hh,0))/sum(hh_m),
              HH05=sum(ifelse((hh_m==1 &hh_per1==3),hh,0))/sum(hh_m),
              HH06=sum(ifelse((hh_m==1 &hh_per1==4),hh,0))/sum(hh_m),
              HH07=sum(ifelse((hh_m==1 &hh_per1==5),hh,0))/sum(hh_m),
              HH08=sum(ifelse((hh_m==1 &hh_per1==6),hh,0))/sum(hh_m),
              HH09=sum(ifelse((hh_m==1 &hh_per1==7),hh,0))/sum(hh_m),
              HH10=sum(ifelse((hh_m==1 &hh_per1==8),hh,0))/sum(hh_m),
              HH11=sum(ifelse((hh_m==1 &hh_per1==9),hh,0))/sum(hh_m),
              HH12=sum(ifelse((hh_m==1 &hh_per1==10),hh,0))/sum(hh_m),
              HH13=sum(ifelse((hh_m==1 &hh_per1>10),hh,0))/sum(hh_m),
              
              HH14=sum(ifelse((hh_f==1 &hh_per1==1),hh,0))/sum(hh_f),
              HH15=sum(ifelse((hh_f==1 &hh_per1==2),hh,0))/sum(hh_f),
              HH16=sum(ifelse((hh_f==1 &hh_per1==3),hh,0))/sum(hh_f),
              HH17=sum(ifelse((hh_f==1 &hh_per1==4),hh,0))/sum(hh_f),
              HH18=sum(ifelse((hh_f==1 &hh_per1==5),hh,0))/sum(hh_f),
              HH19=sum(ifelse((hh_f==1 &hh_per1==6),hh,0))/sum(hh_f),
              HH20=sum(ifelse((hh_f==1 &hh_per1==7),hh,0))/sum(hh_f),
              HH21=sum(ifelse((hh_f==1 &hh_per1==8),hh,0))/sum(hh_f),
              HH22=sum(ifelse((hh_f==1 &hh_per1==9),hh,0))/sum(hh_f),
              HH23=sum(ifelse((hh_f==1 &hh_per1==10),hh,0))/sum(hh_f),
              HH24=sum(ifelse((hh_f==1 &hh_per1>10),hh,0))/sum(hh_f),
              
              HH25=sum(ifelse((hh_m==1 &family_type2==10),1,0)/sum(hh_m)),
              HH26=sum(ifelse((hh_m==1 &family_type2==20),1,0)/sum(hh_m)),
              HH27=sum(ifelse((hh_m==1 &family_type2==40),1,0)/sum(hh_m)),
              HH28=sum(ifelse((hh_m==1 &family_type2==50),1,0)/sum(hh_m)),
              HH29=sum(ifelse((hh_m==1 &family_type2==30),1,0)/sum(hh_m)),
              HH30=sum(ifelse((hh_m==1 &family_type2==9999),1,0)/sum(hh_m)),
              
              HH31=sum(ifelse((hh_f==1 &family_type2==10),1,0)/sum(hh_f)),
              HH32=sum(ifelse((hh_f==1 &family_type2==20),1,0)/sum(hh_f)),
              HH33=sum(ifelse((hh_f==1 &family_type2==40),1,0)/sum(hh_f)),
              HH34=sum(ifelse((hh_f==1 &family_type2==50),1,0)/sum(hh_f)),
              HH35=sum(ifelse((hh_f==1 &family_type2==30),1,0)/sum(hh_f)),
              HH36=sum(ifelse((hh_f==1 &family_type2==9999),1,0)/sum(hh_f)),
              
              HH37=sum(hh_per[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH38=sum(hh_per[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH39=sum(hh_child18[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH40=sum(hh_child18[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH41=sum(hh_adult18[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH42=sum(hh_adult18[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH43=sum(hh_elderly65[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH44=sum(hh_elderly65[hh_F_headed!=0])/unique(WEIGHT_AF),
              
              HH45=sum(hh_spouses[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH46=sum(hh_spouses[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH47=sum(hh_childs[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH48=sum(hh_childs[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH49=sum(hh_other_relatives[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH50=sum(hh_other_relatives[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH51=sum(hh_non_relatives[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH52=sum(hh_non_relatives[hh_F_headed!=0])/unique(WEIGHT_AF),
              
              HH53=sum(hh_adult18M[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH54=sum(hh_adult18M[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH55=sum(hh_adult18F[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH56=sum(hh_adult18F[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH57=sum(hh[hh_adult18Mb==0]),
              HH58=sum(hh[hh_adult18Mb==1]),
              HH59=sum(hh[hh_adult18Mb==2]),
              HH60=sum(hh[hh_adult18Mb==3]),
              HH61=sum(hh[hh_adult18Mb==4]),
              HH62=sum(hh[hh_adult18Mb==5]),
              HH63=sum(hh[hh_adult18Mb>=6]),
              
              HH64=sum(hh_m[hh_adult18Mb==0]),
              HH65=sum(hh_m[hh_adult18Mb==1]),
              HH66=sum(hh_m[hh_adult18Mb==2]),
              HH67=sum(hh_m[hh_adult18Mb==3]),
              HH68=sum(hh_m[hh_adult18Mb==4]),
              HH69=sum(hh_m[hh_adult18Mb==5]),
              HH70=sum(hh_m[hh_adult18Mb>=6]),
              
              HH71=sum(hh_f[hh_adult18Mb==0]),
              HH72=sum(hh_f[hh_adult18Mb==1]),
              HH73=sum(hh_f[hh_adult18Mb==2]),
              HH74=sum(hh_f[hh_adult18Mb==3]),
              HH75=sum(hh_f[hh_adult18Mb==4]),
              HH76=sum(hh_f[hh_adult18Mb==5]),
              HH77=sum(hh_f[hh_adult18Mb>=6]),
              HTMM=sum(ifelse(family_type3==21,1,0)/sum(hh))
    )
  
  
}

system.time(
  PASO5_DHS_LIST<-parLapply(cl, PASO4_DHS_LIST, FUN_PASO5_DHS_LIST)
)

agrr_database_dhs <- data.table::rbindlist(PASO5_DHS_LIST)

regionw <- read_excel("regionw.xlsx")
regionw<-as.data.frame(regionw)
agrr_database_dhs<-as.data.frame(agrr_database_dhs)
agrr_database_dhs<- data.frame(agrr_database_dhs,
                               regionw[match(agrr_database_dhs[,"country_control"],
                                             regionw[,"ISO3"]),c("EU Member States")])

colnames(agrr_database_dhs)[grep(names(agrr_database_dhs %>% select(last_col())), colnames(agrr_database_dhs))]<-"CNTRY"

save(agrr_database_dhs, file="G:/Shared drives/CORESIDENCE/WP4_RESEARCH OUTPUT/4_1_Articles/(9) Gender asymmetries in household headship/DATABASE/AGGR_INDICATORS_DHS_RITA.RData")
gc()

##### LFS #######
# READ ALL LFS FILES ####
setwd("G:\\Shared drives\\CORESIDENCE\\WP2_DATA\\2_1_Input Data\\LFS\\A2_TEST_LFS")

patt.shp <- ".*pdf*"

data.shp <-list.files(pattern=patt.shp)
data.shp<-paste(substr(data.shp,6,17),".RData",sep="")

data.shp[118]<-"POL_2006_LFS.RData"


setwd("G:\\Shared drives\\CORESIDENCE\\WP2_DATA\\2_1_Input Data\\LFS\\")
sample_LFS_LIST <- sapply(data.shp, function(x) mget(load(x)), simplify = TRUE) 

sample_LFS_LIST[["BGR_2000_LFS.RData.df"]]<-NULL
sample_LFS_LIST[["CHE_2000_LFS.RData.df"]]<-NULL
sample_LFS_LIST[["CHE_2005_LFS.RData.df"]]<-NULL
sample_LFS_LIST[["CHE_2010_LFS.RData.df"]]<-NULL
sample_LFS_LIST[["CHE_2015_LFS.RData.df"]]<-NULL
sample_LFS_LIST[["IRL_2000_LFS.RData.df"]]<-NULL
sample_LFS_LIST[["IRL_2005_LFS.RData.df"]]<-NULL
sample_LFS_LIST[["ISL_1995_LFS.RData.df"]]<-NULL
sample_LFS_LIST[["ISL_2000_LFS.RData.df"]]<-NULL
sample_LFS_LIST[["ISL_2005_LFS.RData.df"]]<-NULL
sample_LFS_LIST[["ISL_2010_LFS.RData.df"]]<-NULL
sample_LFS_LIST[["ISL_2015_LFS.RData.df"]]<-NULL
sample_LFS_LIST[["LTU_2000_LFS.RData.df"]]<-NULL
sample_LFS_LIST[["LVA_2000_LFS.RData.df"]]<-NULL
sample_LFS_LIST[["MLT_2010_LFS.RData.df"]]<-NULL
sample_LFS_LIST[["MLT_2015_LFS.RData.df"]]<-NULL
sample_LFS_LIST[["POL_2000_LFS.RData.df"]]<-NULL
sample_LFS_LIST[["PRT_1990_LFS.RData.df"]]<-NULL
sample_LFS_LIST[["LUX_2015_LFS.RData.df"]]<-NULL
sample_LFS_LIST[["LUX_2005_LFS.RData.df"]]<-NULL
sample_LFS_LIST[["LVA_2005_LFS.RData.df"]]<-NULL

FUN_CORE_LFS_LIST <-  function(df) {
  library(tidyverse)
  library(haven)
  library(readxl)
  ######  
  regionw <- read_excel("G:/Shared drives/CORESIDENCE/WP4_RESEARCH OUTPUT/4_1_Articles/(1) Household size and composition a global update/DATABASE/regionw.xlsx")
  df<-as.data.frame(df)
  regionw<-as.data.frame(regionw)
  df<- data.frame(df,
                  regionw[match(df[,"COUNTRY"],
                                regionw[,"country"]),c("REGIONW","ISO3")])
  
  
  df<-as_tibble(df)
  df$SOURCE<-"LFS"
  df$SAMPLE<-with(df,paste(ISO3, REFYEAR, SOURCE, sep="_"))
  # df$PWEIGHT_A<-(df$HV005/1000000)
  df$hh<-1
  df$AGE<-as.numeric(df$AGE)
  
  df<-df%>%drop_na(AGE)
  #df$AGE[is.na(df$AGE)] <- 999
  df$YEAR<-df$REFYEAR
  
  df$AGE2<-with(df,  ifelse(AGE==999, "999",
                            ifelse(AGE==2, "0-4",
                                   ifelse(AGE==7, "5-9", 
                                          ifelse(AGE==12, "10-14",
                                                 ifelse(AGE==17, "15-19",
                                                        ifelse(AGE==22, "20-24",
                                                               ifelse(AGE==27, "25-29",
                                                                      ifelse(AGE==32, "30-34",
                                                                             ifelse(AGE==37, "35-39",
                                                                                    ifelse(AGE==42, "40-44",
                                                                                           ifelse(AGE==47, "45-49",
                                                                                                  ifelse(AGE<=52, "50-54",
                                                                                                         ifelse(AGE<=57, "55-59",
                                                                                                                ifelse(AGE<=62, "60-64",
                                                                                                                       ifelse(AGE<=67, "65-69",
                                                                                                                              ifelse(AGE<=72, "70-74",
                                                                                                                                     ifelse(AGE<=77, "75-79",
                                                                                                                                            ifelse(AGE<=82, "80-84",
                                                                                                                                                   ifelse(AGE<=87, "85-89",
                                                                                                                                                          ifelse(AGE<=92, "90-94","95+")))))))))))))))))))))
  
  
  df$CENSUS_ROUND<-with(df,ifelse((YEAR>=1956 & YEAR <=1965), 1960,
                                  ifelse((YEAR>=1966 & YEAR <=1975), 1970,
                                         ifelse((YEAR>=1976 & YEAR <=1985), 1980,
                                                ifelse((YEAR>=1986 & YEAR <=1995), 1990,
                                                       ifelse((YEAR>=1996 & YEAR <=2005), 2000,
                                                              ifelse((YEAR>=2006 & YEAR <=2015), 2010,
                                                                     ifelse((YEAR>=2016 & YEAR <=2025), 2020,0))))))))
  
  df$DECADE<-with(df,ifelse((YEAR>=1951 & YEAR <=1960), 1950,
                            ifelse((YEAR>=1961 & YEAR <=1970), 1960,
                                   ifelse((YEAR>=1971 & YEAR <=1980), 1970,
                                          ifelse((YEAR>=1981 & YEAR <=1990), 1980,
                                                 ifelse((YEAR>=1991 & YEAR <=2000), 1990,
                                                        ifelse((YEAR>=2001 & YEAR <=2010), 2000,
                                                               ifelse((YEAR>=2011 & YEAR <=2020), 2010,
                                                                      ifelse((YEAR>=2021 & YEAR <=2030), 2020,0)))))))))
  
  df$FIVE_YEAR<-with(df,ifelse((YEAR>=1951 & YEAR <=1955), 1951,
                               ifelse((YEAR>=1956 & YEAR <=1960), 1956,
                                      ifelse((YEAR>=1961 & YEAR <=1965), 1961,
                                             ifelse((YEAR>=1966 & YEAR <=1970), 1966,
                                                    ifelse((YEAR>=1971 & YEAR <=1975), 1971,
                                                           ifelse((YEAR>=1976 & YEAR <=1980), 1976,
                                                                  ifelse((YEAR>=1981 & YEAR <=1985), 1981,
                                                                         ifelse((YEAR>=1986 & YEAR <=1990), 1986,
                                                                                ifelse((YEAR>=1991 & YEAR <=1995), 1991,
                                                                                       ifelse((YEAR>=1996 & YEAR <=2000), 1996,
                                                                                              ifelse((YEAR>=2001 & YEAR <=2005), 2001,
                                                                                                     ifelse((YEAR>=2006 & YEAR <=2010), 2006,
                                                                                                            ifelse((YEAR>=2011 & YEAR <=2015), 2011,
                                                                                                                   ifelse((YEAR>=2016 & YEAR <=2020), 2016,
                                                                                                                          ifelse((YEAR>=2021 & YEAR <=2025), 2021,0))))))))))))))))
  
  
  
  df$HHLINK[is.na(df$HHLINK)] <- "Missing"
  df<-df%>%
    mutate(RELATE=case_when(HHLINK == "1" ~ 1,#
                            HHLINK == "2" ~ 2,#
                            HHLINK == "3" ~ 3,#
                            HHLINK == "4" ~ 4,#
                            HHLINK == "5" ~ 4,#
                            HHLINK == "6" ~ 5,
                            HHLINK == "9" ~ 9,
                            HHLINK == "0" ~ 8),
           
           RELATED=case_when(HHLINK == "1" ~ 1000,#
                             HHLINK == "2" ~ 2000,#
                             HHLINK == "3" ~ 3000,#
                             HHLINK == "4" ~ 4200,#
                             HHLINK == "5" ~ 4900,#
                             HHLINK == "6" ~ 5900,
                             HHLINK == "9" ~ 9999,
                             HHLINK == "0" ~ 8888))#
  
  
  df$RELATE<-labelled(x=df$RELATE,
                      labels=c("Head"=1, 
                               "Spouse/partner"=2,
                               "Child"=3, 
                               "Other relative"=4,
                               "Non-relative"=5,
                               "Other relative or non-relative"=6,
                               "Missing"=8,
                               "Unknown"=9),
                      label="Relationship to household head [general version]")
  
  
  df$RELATED<-labelled(x=df$RELATED,
                       labels=c("Head" = 1000,#
                                "Spouse/partner" = 2000,#
                                "Child" = 3000,#
                                "Parent/parent-in-law" = 4200,#
                                "Other relative" = 4000,#
                                "Non-relative, n.e.c." = 5900,#
                                "Missing"=8888,
                                "Unknown " = 9999), #
                       label="Relationship to household head [detailed version]")
  
  
  
  df<-df%>%
    mutate(CONTINENT=case_when(REGIONW == 11 ~ "Eastern Africa",
                               REGIONW == 12 ~ "Middle Africa",
                               REGIONW == 13 ~ "Northern Africa",
                               REGIONW == 14 ~ "Southern Africa",
                               REGIONW == 15 ~ "Western Africa",
                               REGIONW == 21 ~ "Caribbean" ,
                               REGIONW == 22 ~ "Central America" ,
                               REGIONW == 23 ~ "South America" ,
                               REGIONW == 24 ~ "North America",
                               REGIONW == 31 ~ "Central Asia",
                               REGIONW == 32 ~ "Eastern Asia",
                               REGIONW == 33 ~ "Southern Asia" ,
                               REGIONW == 34 ~ "South-Eastern Asia",
                               REGIONW == 35 ~ "Western Asia",
                               REGIONW == 41 ~ "Eastern Europe" ,
                               REGIONW == 42 ~ "Northern Europe" ,
                               REGIONW == 43 ~ "Southern Europe",
                               REGIONW == 44 ~ "Western Europe",
                               REGIONW == 51 ~ "Australia and New Zealand" ,
                               REGIONW == 52 ~ "Melanesia",
                               REGIONW == 53 ~ "Micronesia",
                               REGIONW == 54 ~ "Polynesia"))
  
  df<-df%>%
    mutate(CONT2=case_when(CONTINENT == "Eastern Africa" ~ "AFRICA",
                           CONTINENT == "Middle Africa" ~ "AFRICA",
                           CONTINENT == "Northern Africa" ~ "AFRICA",
                           CONTINENT == "Southern Africa" ~ "AFRICA",
                           CONTINENT == "Western Africa" ~ "AFRICA",
                           CONTINENT == "Caribbean" ~ "LATIN-AMERICA",
                           CONTINENT == "Central America" ~ "LATIN-AMERICA",
                           CONTINENT == "South America" ~ "LATIN-AMERICA",
                           CONTINENT == "North America" ~ "NORTH-AMERICA",
                           CONTINENT == "Central Asia" ~ "ASIA",
                           CONTINENT == "Eastern Asia" ~ "ASIA",
                           CONTINENT == "Southern Asia" ~ "ASIA",
                           CONTINENT == "South-Eastern Asia" ~ "ASIA",
                           CONTINENT == "Western Asia" ~ "ASIA",
                           CONTINENT == "Eastern Europe" ~ "EUROPE",
                           CONTINENT == "Northern Europe" ~ "EUROPE",
                           CONTINENT == "Southern Europe" ~ "EUROPE",
                           CONTINENT == "Western Europe" ~ "EUROPE",
                           CONTINENT == "Australia and New Zealand" ~ "OCEANIA",
                           CONTINENT == "Melanesia" ~ "OCEANIA",
                           CONTINENT == "Micronesia" ~ "OCEANIA",
                           CONTINENT == "Polynesia" ~ "OCEANIA"))
}

system.time(
  CORE_LFS_LIST<-parLapply(cl, sample_LFS_LIST, FUN_CORE_LFS_LIST)
)

FUN_PASO1_LFS_LIST <-  function(df) {
  library(tidyverse)
  library(haven)  
  df$SEX[is.na(df$SEX)] <- 3
  VALID_GQ<-1
  df<-df %>%
    filter(HHTYPE %in% VALID_GQ) %>% #filtrem nom?s els private households
    mutate(hhid=paste(HHNUM,REFWEEK, sep="-"))%>%
    add_count(hhid)%>%
    
    mutate(#hhid=paste(HHNUM,REFWEEK, sep="-"),
      child5=ifelse(AGE<7,1,0),
      adult18=ifelse(AGE>17,1,0),
      adult18M=ifelse((AGE>17&SEX==1),1,0),
      adult18F=ifelse((AGE>17&SEX==2),1,0),
      child18=ifelse(AGE<=17,1,0),
      elderly65=ifelse(AGE>62,1,0),
      
      age00_09=ifelse((AGE==2|AGE==7),1,0),
      age10_19=ifelse((AGE==12|AGE==17),1,0),
      age20_29=ifelse((AGE==22|AGE==27),1,0),
      age30_39=ifelse((AGE==32|AGE==37),1,0),
      age40_49=ifelse((AGE==42|AGE==47),1,0),
      age50_59=ifelse((AGE==52|AGE==57),1,0),
      age60_69=ifelse((AGE==62|AGE==67),1,0),
      age70_79=ifelse((AGE==72|AGE==77),1,0),
      age80=ifelse(AGE>=82,1,0),
      
      heads=ifelse(RELATE==1,1,0), 
      spouses=ifelse(RELATE==2,1,0),
      childs=ifelse(RELATE==3,1,0),
      other_relatives=ifelse(RELATE==4,1,0),
      non_relatives=ifelse(RELATE==5,1,0),
      other_rel_or_non_rel=ifelse(RELATE==6,1,0),
      
      grandchilds=ifelse(RELATED %in% c(4100, 4110,4120,4130),1,0),
      parents=ifelse(RELATED %in% c(4200,4210,4211,4220 ),1,0),
      siblings=ifelse(RELATED %in% c(4400,4410,4420,4430,4431,4432),1,0),
      
      WEIGHT_POP= sum(COEFF,na.rm = TRUE)*1000,
      #WEIGHT_A= sum(df[df$RELATE==1,"PWEIGHT_A"]),
      WEIGHT_A= sum(COEFF[RELATE==1],na.rm = TRUE),
      WEIGHT_A2= sum(COEFF[RELATE==1&n==2]),
      WEIGHT_A3= sum(COEFF[RELATE==1&n==3]),
      WEIGHT_A4= sum(COEFF[RELATE==1&n==4]),
      WEIGHT_A5= sum(COEFF[RELATE==1&n==5]),
      WEIGHT_AM= sum(COEFF[RELATE==1&SEX==1]),
      WEIGHT_AF= sum(COEFF[RELATE==1&SEX==2]),
      WEIGHT_2029=sum(COEFF[RELATE==1&age20_29==1]),
      WEIGHT_3039=sum(COEFF[RELATE==1&age30_39==1]),
      WEIGHT_4049=sum(COEFF[RELATE==1&age40_49==1]),
      WEIGHT_5059=sum(COEFF[RELATE==1&age50_59==1]),
      WEIGHT_6069=sum(COEFF[RELATE==1&age60_69==1]),
      headed2029=ifelse((RELATE==1 &age20_29==1),1,0), 
      headed3039=ifelse((RELATE==1 &age30_39==1),1,0),
      headed4049=ifelse((RELATE==1 &age40_49==1),1,0),
      headed5059=ifelse((RELATE==1 &age50_59==1),1,0),
      headed6069=ifelse((RELATE==1 &age60_69==1),1,0),
      
      M_headed=ifelse((RELATE==1 & SEX==1),1,0),
      F_headed=ifelse((RELATE==1 & SEX==2),1,0))|>
    drop_na(COEFF)
           
  
}

system.time(
  PASO1_LFS_LIST<-parLapply(cl, CORE_LFS_LIST, FUN_PASO1_LFS_LIST)
)

FUN_PASO2_LFS_LIST <-  function(df) {
  library(tidyverse)
  library(haven) 
  df<-df|>
    group_by(hhid)|>
    mutate(hh_per1=n(),
           hh_parents=sum(parents*COEFF),
           hh_grandchilds=sum(grandchilds*COEFF),
           hh_heads=sum(heads*COEFF),
           hh_spouses=sum(spouses*COEFF),
           hh_childs=sum(childs*COEFF),
           hh_other_relatives=sum(other_relatives*COEFF),
           hh_non_relatives=sum(non_relatives*COEFF),
           hh_other_rel_or_non_rel=sum(other_rel_or_non_rel*COEFF))|>
    mutate(family_type= #ifelse(hh_per1==1, 10, # unipersonal households 
             ifelse(hh_per1==1&AGE<50, 11, # unipersonal households 
                    ifelse(hh_per1==1&AGE>=50, 12, # unipersonal households 
                           ifelse(hh_spouses>0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20, #nuclear 
                                  ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives ==0 & hh_non_relatives==0,20,#nuclear 
                                         ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20,#nuclear 
                                                
                                                
                                                ifelse(hh_spouses>0 & hh_childs>0 &  hh_other_relatives >0 & hh_non_relatives==0,31,# nuclear + other relatives
                                                       ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives >0 & hh_non_relatives==0,31,
                                                              ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives >0 & hh_non_relatives==0,31,
                                                                     
                                                                     ifelse(hh_spouses>0 & hh_childs>0 &  hh_other_relatives ==0 & hh_non_relatives>0,32,
                                                                            ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives ==0 & hh_non_relatives>0,32,
                                                                                   ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives>0,32,       
                                                                                          
                                                                                          ifelse(hh_spouses>0 & hh_childs>0 &  hh_other_relatives >0 & hh_non_relatives>0,33,
                                                                                                 ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives >0 & hh_non_relatives>0,33,
                                                                                                        ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives >0 & hh_non_relatives>0,33,        
                                                                                                               
                                                                                                               ifelse(hh_spouses==0 & hh_childs==0 &  hh_other_relatives >0 & hh_non_relatives==0,34,
                                                                                                                      ifelse(hh_spouses==0 & hh_childs==0 &  hh_other_relatives ==0 & hh_non_relatives>0,35,
                                                                                                                             ifelse(hh_spouses==0 & hh_childs==0 &  hh_other_relatives >0 & hh_non_relatives>0,36,
                                                                                                                                    0))))))))))))))))))|>
    mutate(family_type2=ifelse(hh_per1==1, 10,
                               ifelse(hh_spouses>0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20,
                                      ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives ==0 & hh_non_relatives==0,20,
                                             ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20,       
                                                    ifelse(hh_non_relatives>0,30, # "Other non family",
                                                           ifelse((hh_parents>0 | hh_grandchilds>0),40,# "Stem family",
                                                                  ifelse(hh_other_relatives>0,50, 9999))))))))|>
    
    mutate(family_type3=ifelse(any(F_headed==1)&(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0),21,9999))|>#monomarental )
    ungroup()
  
}

system.time(
  PASO2_LFS_LIST<-parLapply(cl, PASO1_LFS_LIST, FUN_PASO2_LFS_LIST)
)

rm(PASO1_LFS_LIST)
gc()

FUN_PASO3_LFS_LIST <-  function(df) {
  library(tidyverse)
  library(haven) 
  df<-df |>
    mutate(#WEIGHT_FT10= sum(PWEIGHT[family_type==10]),
      WEIGHT_FT11= sum(COEFF[family_type==11]),
      WEIGHT_FT12= sum(COEFF[family_type==12]),
      WEIGHT_FT20= sum(COEFF[RELATE==1&family_type==20]),
      WEIGHT_FT31= sum(COEFF[RELATE==1&family_type==31]),
      WEIGHT_FT32= sum(COEFF[RELATE==1&family_type==32]),
      WEIGHT_FT33= sum(COEFF[RELATE==1&family_type==33]),
      WEIGHT_FT34= sum(COEFF[RELATE==1&family_type==34]),
      WEIGHT_FT35= sum(COEFF[RELATE==1&family_type==35]),
      WEIGHT_FT36= sum(COEFF[RELATE==1&family_type==36]),
      WEIGHT_FT00= sum(COEFF[RELATE==1&family_type==0]),
      
      WEIGHT_FT210= sum(COEFF[family_type2==10]),
      WEIGHT_FT220= sum(COEFF[RELATE==1&family_type2==20]),
      WEIGHT_FT230= sum(COEFF[RELATE==1&family_type2==30]),
      WEIGHT_FT240= sum(COEFF[RELATE==1&family_type2==40]),
      WEIGHT_FT250= sum(COEFF[RELATE==1&family_type2==50]),
      WEIGHT_FT299= sum(COEFF[RELATE==1&family_type2==9999]),
      
      WEIGHT_FT321= sum(COEFF[RELATE==1&family_type3==21])
    )  
  
} 

system.time(
  PASO3_LFS_LIST<-parLapply(cl, PASO2_LFS_LIST, FUN_PASO3_LFS_LIST)
)

rm(PASO2_LFS_LIST)
gc()

FUN_PASO4_LFS_LIST <-  function(df) {
  library(tidyverse)
  library(haven)
  df<-df |> 
    group_by(SAMPLE,ISO3,YEAR,hhid,CONTINENT,SOURCE,
             CENSUS_ROUND,DECADE,FIVE_YEAR,CONT2,
             WEIGHT_POP,WEIGHT_A,WEIGHT_A2,WEIGHT_A3,WEIGHT_A4,
             WEIGHT_A5, WEIGHT_AM,WEIGHT_AF,WEIGHT_2029,WEIGHT_3039,WEIGHT_4049,
             WEIGHT_5059,WEIGHT_6069,
             WEIGHT_FT11, WEIGHT_FT12,
             WEIGHT_FT20,
             WEIGHT_FT31,WEIGHT_FT32,WEIGHT_FT33,WEIGHT_FT34,WEIGHT_FT35,
             WEIGHT_FT36,WEIGHT_FT00,WEIGHT_FT210,WEIGHT_FT220,WEIGHT_FT230,
             WEIGHT_FT240,WEIGHT_FT250,WEIGHT_FT299,
             WEIGHT_FT321,
             family_type,
             family_type2,
             family_type3)|>
    summarise(hh=1,
              hh_per1=n(),
              hh_m=sum(M_headed),
              hh_f=sum(F_headed),
              hh_per=sum(hh*COEFF),
              hh_child5=sum(child5*COEFF),
              hh_adult18=sum(adult18*COEFF),
              hh_adult18b=sum(adult18),
              
              hh_00_09=sum(age00_09*COEFF),
              hh_10_19=sum(age10_19*COEFF),
              hh_20_29=sum(age20_29*COEFF),
              hh_30_39=sum(age30_39*COEFF),
              hh_40_49=sum(age40_49*COEFF),
              hh_50_59=sum(age50_59*COEFF),
              hh_60_69=sum(age60_69*COEFF),
              hh_70_79=sum(age70_79*COEFF),
              hh_80=sum(age80*COEFF),
              
              hh_adult18M=sum(adult18M*COEFF),
              hh_adult18F=sum(adult18F*COEFF),
              hh_adult18Mb=sum(adult18M),
              
              hh_child18=sum(child18*COEFF),
              hh_elderly65=sum(elderly65*COEFF),
              
              hh_heads=sum(heads*COEFF),
              hh_spouses=sum(spouses*COEFF),
              hh_childs=sum(childs*COEFF),
              hh_other_relatives=sum(other_relatives*COEFF),
              hh_non_relatives=sum(non_relatives*COEFF),
              hh_other_rel_or_non_rel=sum(other_rel_or_non_rel*COEFF),
              
              hh_grandchilds=sum(grandchilds*COEFF),
              hh_parents=sum(parents*COEFF),
              hh_siblings=sum(siblings*COEFF), 
              hh_M_headed=sum(M_headed*COEFF),
              hh_F_headed=sum(F_headed*COEFF),
              hh_headed2029=sum(headed2029*COEFF),
              hh_headed3039=sum(headed3039*COEFF),
              hh_headed4049=sum(headed4049*COEFF),
              hh_headed5059=sum(headed5059*COEFF),
              hh_headed6069=sum(headed6069*COEFF)
    )|>
    ungroup()
} 

system.time(
  PASO4_LFS_LIST<-parLapply(cl, PASO3_LFS_LIST, FUN_PASO4_LFS_LIST)
)

rm(PASO3_LFS_LIST)
gc()

FUN_PASO5_LFS_LIST <-  function(df) {
  library(tidyverse)
  library(haven)
  df<-df |>
    group_by(ISO3,YEAR,SOURCE,SAMPLE,CONTINENT,CONT2,CENSUS_ROUND,DECADE,FIVE_YEAR)|>
    summarise(WPOP=round(unique(WEIGHT_POP),0),
              
              HS01=sum(ifelse(hh_per1==1,hh,0))/sum(hh),
              HS02=sum(ifelse(hh_per1==2,hh,0))/sum(hh),
              HS03=sum(ifelse(hh_per1==3,hh,0))/sum(hh),
              HS04=sum(ifelse(hh_per1==4,hh,0))/sum(hh),
              HS05=sum(ifelse(hh_per1==5,hh,0))/sum(hh),
              HS06=sum(ifelse(hh_per1==6,hh,0))/sum(hh),
              HS07=sum(ifelse(hh_per1==7,hh,0))/sum(hh),
              HS08=sum(ifelse(hh_per1==8,hh,0))/sum(hh),
              HS09=sum(ifelse(hh_per1==9,hh,0))/sum(hh),
              HS10=sum(ifelse(hh_per1==10,hh,0))/sum(hh),
              HS11=sum(ifelse(hh_per1>10,hh,0))/sum(hh),
              HS12=sum(ifelse((hh_per1==2|hh_per1==3),hh,0))/sum(hh),
              HS13=sum(ifelse((hh_per1==4|hh_per1==5),hh,0))/sum(hh),
              HS14=sum(ifelse(hh_per1>=6,hh,0))/sum(hh),
              HS15=sum(hh_child5 != 0)/sum(hh),
              HS16=sum(hh_elderly65 != 0)/sum(hh),
              HS17=sum(hh_per)/unique(WEIGHT_A),
              HS18=sum(hh_child5)/unique(WEIGHT_A),
              HS19=sum(hh_adult18)/unique(WEIGHT_A),
              HS20=sum(hh_child18)/unique(WEIGHT_A),
              HS21=sum(hh_elderly65)/unique(WEIGHT_A),
              HS22=sum(hh_00_09)/unique(WEIGHT_A),
              HS23=sum(hh_10_19)/unique(WEIGHT_A),
              HS24=sum(hh_20_29)/unique(WEIGHT_A),
              HS25=sum(hh_30_39)/unique(WEIGHT_A),
              HS26=sum(hh_40_49)/unique(WEIGHT_A),
              HS27=sum(hh_50_59)/unique(WEIGHT_A),
              HS28=sum(hh_60_69)/unique(WEIGHT_A),
              HS29=sum(hh_70_79)/unique(WEIGHT_A),
              HS30=sum(hh_80)/unique(WEIGHT_A),
              
              HR01=sum(hh_heads)/unique(WEIGHT_A),
              HR02=sum(hh_spouses)/unique(WEIGHT_A),
              HR03=sum(hh_childs)/unique(WEIGHT_A),
              HR04=sum(hh_other_relatives)/unique(WEIGHT_A),
              HR05=sum(hh_non_relatives)/unique(WEIGHT_A),
              HR06=sum(hh_other_rel_or_non_rel)/unique(WEIGHT_A),
              
              HR07=sum(hh_heads[hh_per1==2])/unique(WEIGHT_A2),
              HR08=sum(hh_spouses[hh_per1==2])/unique(WEIGHT_A2),
              HR09=sum(hh_childs[hh_per1==2])/unique(WEIGHT_A2),
              HR10=sum(hh_other_relatives[hh_per1==2])/unique(WEIGHT_A2),
              HR11=sum(hh_non_relatives[hh_per1==2])/unique(WEIGHT_A2),
              HR12=sum(hh_other_rel_or_non_rel[hh_per1==2])/unique(WEIGHT_A2),
              
              HR13=sum(hh_heads[hh_per1==3])/unique(WEIGHT_A3),
              HR14=sum(hh_spouses[hh_per1==3])/unique(WEIGHT_A3),
              HR15=sum(hh_childs[hh_per1==3])/unique(WEIGHT_A3),
              HR16=sum(hh_other_relatives[hh_per1==3])/unique(WEIGHT_A3),
              HR17=sum(hh_non_relatives[hh_per1==3])/unique(WEIGHT_A3),
              HR18=sum(hh_other_rel_or_non_rel[hh_per1==3])/unique(WEIGHT_A3),
              
              HR19=sum(hh_heads[hh_per1==4])/unique(WEIGHT_A4),
              HR20=sum(hh_spouses[hh_per1==4])/unique(WEIGHT_A4),
              HR21=sum(hh_childs[hh_per1==4])/unique(WEIGHT_A4),
              HR22=sum(hh_other_relatives[hh_per1==4])/unique(WEIGHT_A4),
              HR23=sum(hh_non_relatives[hh_per1==4])/unique(WEIGHT_A4),
              HR24=sum(hh_other_rel_or_non_rel[hh_per1==4])/unique(WEIGHT_A4),
              
              HR25=sum(hh_heads[hh_per1==5])/unique(WEIGHT_A5),
              HR26=sum(hh_spouses[hh_per1==5])/unique(WEIGHT_A5),
              HR27=sum(hh_childs[hh_per1==5])/unique(WEIGHT_A5),
              HR28=sum(hh_other_relatives[hh_per1==5])/unique(WEIGHT_A5),
              HR29=sum(hh_non_relatives[hh_per1==5])/unique(WEIGHT_A5),
              HR30=sum(hh_other_rel_or_non_rel[hh_per1==5])/unique(WEIGHT_A5),
              
              HT01=sum(ifelse(family_type==11|family_type==12,1,0)/sum(hh)),
              HT01b=sum(ifelse(family_type==11,1,0)/sum(hh)),
              HT01c=sum(ifelse(family_type==12,1,0)/sum(hh)),
              HT02=sum(ifelse(family_type==20,1,0)/sum(hh)),
              HT03=sum(ifelse(family_type==31,1,0)/sum(hh)),
              HT04=sum(ifelse(family_type==32,1,0)/sum(hh)),
              HT05=sum(ifelse(family_type==33,1,0)/sum(hh)),
              HT06=sum(ifelse(family_type==34,1,0)/sum(hh)),
              HT07=sum(ifelse(family_type==35,1,0)/sum(hh)),
              HT08=sum(ifelse(family_type==36,1,0)/sum(hh)),
              HT09=sum(ifelse(family_type==0,1,0)/sum(hh)),
              
              HT10=sum(hh_per[family_type==11|family_type==12])/(unique(WEIGHT_FT11)+unique(WEIGHT_FT12)),
              HT11=sum(hh_per[family_type==20])/unique(WEIGHT_FT20),
              HT12=sum(hh_per[family_type==31])/unique(WEIGHT_FT31),
              HT13=sum(hh_per[family_type==32])/unique(WEIGHT_FT32),
              HT14=sum(hh_per[family_type==33])/unique(WEIGHT_FT33),
              HT15=sum(hh_per[family_type==34])/unique(WEIGHT_FT34),
              HT16=sum(hh_per[family_type==35])/unique(WEIGHT_FT35),
              HT17=sum(hh_per[family_type==36])/unique(WEIGHT_FT36),
              HT18=sum(hh_per[family_type==0])/unique(WEIGHT_FT00),
              
              HT20=sum(ifelse(family_type2==10,1,0)/sum(hh)),
              HT21=sum(ifelse(family_type2==20,1,0)/sum(hh)),
              HT22=sum(ifelse(family_type2==40,1,0)/sum(hh)),
              HT23=sum(ifelse(family_type2==50,1,0)/sum(hh)),
              HT24=sum(ifelse(family_type2==30,1,0)/sum(hh)),
              HT25=sum(ifelse(family_type2==9999,1,0)/sum(hh)),
              HT26=sum(hh_per[family_type2==10])/unique(WEIGHT_FT210),
              HT27=sum(hh_per[family_type2==20])/unique(WEIGHT_FT220),
              HT28=sum(hh_per[family_type2==40])/unique(WEIGHT_FT240),
              HT29=sum(hh_per[family_type2==50])/unique(WEIGHT_FT250),
              HT30=sum(hh_per[family_type2==30])/unique(WEIGHT_FT230),
              HT31=sum(hh_per[family_type2==9999])/unique(WEIGHT_FT299),
              
              HH01=sum(hh_M_headed[hh_M_headed!=0])/unique(WEIGHT_A),
              HH02=sum(hh_F_headed[hh_F_headed!=0])/unique(WEIGHT_A),
              
              HH03=sum(ifelse((hh_m==1 &hh_per1==1),hh,0))/sum(hh_m),
              HH04=sum(ifelse((hh_m==1 &hh_per1==2),hh,0))/sum(hh_m),
              HH05=sum(ifelse((hh_m==1 &hh_per1==3),hh,0))/sum(hh_m),
              HH06=sum(ifelse((hh_m==1 &hh_per1==4),hh,0))/sum(hh_m),
              HH07=sum(ifelse((hh_m==1 &hh_per1==5),hh,0))/sum(hh_m),
              HH08=sum(ifelse((hh_m==1 &hh_per1==6),hh,0))/sum(hh_m),
              HH09=sum(ifelse((hh_m==1 &hh_per1==7),hh,0))/sum(hh_m),
              HH10=sum(ifelse((hh_m==1 &hh_per1==8),hh,0))/sum(hh_m),
              HH11=sum(ifelse((hh_m==1 &hh_per1==9),hh,0))/sum(hh_m),
              HH12=sum(ifelse((hh_m==1 &hh_per1==10),hh,0))/sum(hh_m),
              HH13=sum(ifelse((hh_m==1 &hh_per1>10),hh,0))/sum(hh_m),
              
              HH14=sum(ifelse((hh_f==1 &hh_per1==1),hh,0))/sum(hh_f),
              HH15=sum(ifelse((hh_f==1 &hh_per1==2),hh,0))/sum(hh_f),
              HH16=sum(ifelse((hh_f==1 &hh_per1==3),hh,0))/sum(hh_f),
              HH17=sum(ifelse((hh_f==1 &hh_per1==4),hh,0))/sum(hh_f),
              HH18=sum(ifelse((hh_f==1 &hh_per1==5),hh,0))/sum(hh_f),
              HH19=sum(ifelse((hh_f==1 &hh_per1==6),hh,0))/sum(hh_f),
              HH20=sum(ifelse((hh_f==1 &hh_per1==7),hh,0))/sum(hh_f),
              HH21=sum(ifelse((hh_f==1 &hh_per1==8),hh,0))/sum(hh_f),
              HH22=sum(ifelse((hh_f==1 &hh_per1==9),hh,0))/sum(hh_f),
              HH23=sum(ifelse((hh_f==1 &hh_per1==10),hh,0))/sum(hh_f),
              HH24=sum(ifelse((hh_f==1 &hh_per1>10),hh,0))/sum(hh_f),
              
              HH25=sum(ifelse((hh_m==1 &family_type2==10),1,0)/sum(hh_m)),
              HH26=sum(ifelse((hh_m==1 &family_type2==20),1,0)/sum(hh_m)),
              HH27=sum(ifelse((hh_m==1 &family_type2==40),1,0)/sum(hh_m)),
              HH28=sum(ifelse((hh_m==1 &family_type2==50),1,0)/sum(hh_m)),
              HH29=sum(ifelse((hh_m==1 &family_type2==30),1,0)/sum(hh_m)),
              HH30=sum(ifelse((hh_m==1 &family_type2==9999),1,0)/sum(hh_m)),
              
              HH31=sum(ifelse((hh_f==1 &family_type2==10),1,0)/sum(hh_f)),
              HH32=sum(ifelse((hh_f==1 &family_type2==20),1,0)/sum(hh_f)),
              HH33=sum(ifelse((hh_f==1 &family_type2==40),1,0)/sum(hh_f)),
              HH34=sum(ifelse((hh_f==1 &family_type2==50),1,0)/sum(hh_f)),
              HH35=sum(ifelse((hh_f==1 &family_type2==30),1,0)/sum(hh_f)),
              HH36=sum(ifelse((hh_f==1 &family_type2==9999),1,0)/sum(hh_f)),
              
              HH37=sum(hh_per[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH38=sum(hh_per[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH39=sum(hh_child18[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH40=sum(hh_child18[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH41=sum(hh_adult18[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH42=sum(hh_adult18[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH43=sum(hh_elderly65[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH44=sum(hh_elderly65[hh_F_headed!=0])/unique(WEIGHT_AF),
              
              HH45=sum(hh_spouses[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH46=sum(hh_spouses[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH47=sum(hh_childs[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH48=sum(hh_childs[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH49=sum(hh_other_relatives[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH50=sum(hh_other_relatives[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH51=sum(hh_non_relatives[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH52=sum(hh_non_relatives[hh_F_headed!=0])/unique(WEIGHT_AF),
              
              HH53=sum(hh_adult18M[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH54=sum(hh_adult18M[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH55=sum(hh_adult18F[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH56=sum(hh_adult18F[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH57=sum(hh[hh_adult18Mb==0]),
              HH58=sum(hh[hh_adult18Mb==1]),
              HH59=sum(hh[hh_adult18Mb==2]),
              HH60=sum(hh[hh_adult18Mb==3]),
              HH61=sum(hh[hh_adult18Mb==4]),
              HH62=sum(hh[hh_adult18Mb==5]),
              HH63=sum(hh[hh_adult18Mb>=6]),
              
              HH64=sum(hh_m[hh_adult18Mb==0]),
              HH65=sum(hh_m[hh_adult18Mb==1]),
              HH66=sum(hh_m[hh_adult18Mb==2]),
              HH67=sum(hh_m[hh_adult18Mb==3]),
              HH68=sum(hh_m[hh_adult18Mb==4]),
              HH69=sum(hh_m[hh_adult18Mb==5]),
              HH70=sum(hh_m[hh_adult18Mb>=6]),
              
              HH71=sum(hh_f[hh_adult18Mb==0]),
              HH72=sum(hh_f[hh_adult18Mb==1]),
              HH73=sum(hh_f[hh_adult18Mb==2]),
              HH74=sum(hh_f[hh_adult18Mb==3]),
              HH75=sum(hh_f[hh_adult18Mb==4]),
              HH76=sum(hh_f[hh_adult18Mb==5]),
              HH77=sum(hh_f[hh_adult18Mb>=6]),
              HTMM=sum(ifelse(family_type3==21,1,0)/sum(hh))
    )
  
  
}

system.time(
  PASO5_LFS_LIST<-parLapply(cl, PASO4_LFS_LIST, FUN_PASO5_LFS_LIST)
)

agrr_database_lfs <- data.table::rbindlist(PASO5_LFS_LIST)

regionw <- read_excel("G:/Shared drives/CORESIDENCE/WP4_RESEARCH OUTPUT/4_1_Articles/(1) Household size and composition a global update/DATABASE/regionw.xlsx")
regionw<-as.data.frame(regionw)
agrr_database_lfs<-as.data.frame(agrr_database_lfs)
agrr_database_lfs<- data.frame(agrr_database_lfs,
                               regionw[match(agrr_database_lfs[,"ISO3"],
                                             regionw[,"ISO3"]),c("EU Member States")])

colnames(agrr_database_lfs)[grep(names(agrr_database_lfs %>% select(last_col())), colnames(agrr_database_lfs))]<-"CNTRY"

save(agrr_database_lfs, file="G:/Shared drives/CORESIDENCE/WP4_RESEARCH OUTPUT/4_1_Articles/(9) Gender asymmetries in household headship/DATABASE/AGGR_INDICATORS_LFS_RITA.RData")

##### SILC #######
# READ SILC FILES #####
files<-c("BEL_2021_SILC.RData", "BGR_2021_SILC.RData", "CYP_2021_SILC.RData",
         "CZE_2021_SILC.RData", "DNK_2021_SILC.RData", "ESP_2021_SILC.RData",
         "EST_2021_SILC.RData", "FIN_2021_SILC.RData", "FRA_2021_SILC.RData", "GRC_2021_SILC.RData",
         "HRV_2021_SILC.RData", "IRL_2021_SILC.RData", "ITA_2019_SILC.RData", "LTU_2021_SILC.RData", "LUX_2021_SILC.RData",
         "LVA_2021_SILC.RData", #"MLT_2021_SILC.RData", 
         "NLD_2021_SILC.RData", "PRT_2021_SILC.RData",
         "ROU_2021_SILC.RData", "SVN_2021_SILC.RData", "SWE_2021_SILC.RData")

setwd("G:\\Shared drives\\CORESIDENCE\\WP2_DATA\\2_1_Input Data\\SILC")

samples_SILC_LIST2 <- sapply(files, function(x) mget(load(x)), simplify = TRUE) 

FUN_CORE_SILC_LIST <-  function(df) {
  library(tidyverse)
  library(haven)
  library(readxl)
  ######  
  regionw <- read_excel("G:/Shared drives/CORESIDENCE/WP4_RESEARCH OUTPUT/4_1_Articles/(1) Household size and composition a global update/DATABASE/regionw.xlsx")
  df<-as_tibble(df)
  df<-df%>%
    mutate(RELATE=RG_1)
  
  df<-df %>% 
    mutate(RELATE = replace_na(RELATE, 1))
  
  df<- df %>% relocate(RELATE, .before = RG_1)
  
  df<-df%>%drop_na(RX020)
  #df$RX020[is.na(df$RX020)] <- 999
  
  df<-df%>%
    mutate(AGE=RX020)
  
  
  df$AGE2<-with(df,  ifelse(AGE==999, "999",
                            ifelse(AGE<=4, "0-4",
                                   ifelse(AGE<=9, "5-9", 
                                          ifelse(AGE<=14, "10-14",
                                                 ifelse(AGE<=19, "15-19",
                                                        ifelse(AGE<=24, "20-24",
                                                               ifelse(AGE<=29, "25-29",
                                                                      ifelse(AGE<=34, "30-34",
                                                                             ifelse(AGE<=39, "35-39",
                                                                                    ifelse(AGE<=44, "40-44",
                                                                                           ifelse(AGE<=49, "45-49",
                                                                                                  ifelse(AGE<=54, "50-54",
                                                                                                         ifelse(AGE<=59, "55-59",
                                                                                                                ifelse(AGE<=64, "60-64",
                                                                                                                       ifelse(AGE<=69, "65-69",
                                                                                                                              ifelse(AGE<=74, "70-74",
                                                                                                                                     ifelse(AGE<=79, "75-79",
                                                                                                                                            ifelse(AGE<=84, "80-84",
                                                                                                                                                   ifelse(AGE<=89, "85-89",
                                                                                                                                                          ifelse(AGE<=94, "90-94","95+")))))))))))))))))))))
  df$CENSUS_ROUND<-with(df,ifelse((YEAR>=1956 & YEAR <=1965), 1960,
                                  ifelse((YEAR>=1966 & YEAR <=1975), 1970,
                                         ifelse((YEAR>=1976 & YEAR <=1985), 1980,
                                                ifelse((YEAR>=1986 & YEAR <=1995), 1990,
                                                       ifelse((YEAR>=1996 & YEAR <=2005), 2000,
                                                              ifelse((YEAR>=2006 & YEAR <=2015), 2010,
                                                                     ifelse((YEAR>=2016 & YEAR <=2025), 2020,0))))))))
  
  df$DECADE<-with(df,ifelse((YEAR>=1951 & YEAR <=1960), 1950,
                            ifelse((YEAR>=1961 & YEAR <=1970), 1960,
                                   ifelse((YEAR>=1971 & YEAR <=1980), 1970,
                                          ifelse((YEAR>=1981 & YEAR <=1990), 1980,
                                                 ifelse((YEAR>=1991 & YEAR <=2000), 1990,
                                                        ifelse((YEAR>=2001 & YEAR <=2010), 2000,
                                                               ifelse((YEAR>=2011 & YEAR <=2020), 2010,
                                                                      ifelse((YEAR>=2021 & YEAR <=2030), 2020,0)))))))))
  
  df$FIVE_YEAR<-with(df,ifelse((YEAR>=1951 & YEAR <=1955), 1951,
                               ifelse((YEAR>=1956 & YEAR <=1960), 1956,
                                      ifelse((YEAR>=1961 & YEAR <=1965), 1961,
                                             ifelse((YEAR>=1966 & YEAR <=1970), 1966,
                                                    ifelse((YEAR>=1971 & YEAR <=1975), 1971,
                                                           ifelse((YEAR>=1976 & YEAR <=1980), 1976,
                                                                  ifelse((YEAR>=1981 & YEAR <=1985), 1981,
                                                                         ifelse((YEAR>=1986 & YEAR <=1990), 1986,
                                                                                ifelse((YEAR>=1991 & YEAR <=1995), 1991,
                                                                                       ifelse((YEAR>=1996 & YEAR <=2000), 1996,
                                                                                              ifelse((YEAR>=2001 & YEAR <=2005), 2001,
                                                                                                     ifelse((YEAR>=2006 & YEAR <=2010), 2006,
                                                                                                            ifelse((YEAR>=2011 & YEAR <=2015), 2011,
                                                                                                                   ifelse((YEAR>=2016 & YEAR <=2020), 2016,
                                                                                                                          ifelse((YEAR>=2021 & YEAR <=2025), 2021,0))))))))))))))))
  
  
  df<-df%>%
    mutate(RELATE_n=case_when(RELATE == 1 ~ 1,
                              RELATE == 10 ~ 2,
                              RELATE == 11 ~ 2,
                              RELATE == 12 ~ 2,
                              RELATE == 20 ~ 3,
                              RELATE == 21 ~ 3,
                              RELATE == 22 ~ 3,
                              RELATE == 30 ~ 3,
                              RELATE == 40 ~ 4,
                              RELATE == 50 ~ 4,
                              RELATE == 51 ~ 4,
                              RELATE == 52 ~ 4,
                              RELATE == 60 ~ 4,
                              RELATE == 80 ~ 4,
                              RELATE == 81 ~ 4,
                              RELATE == 82 ~ 4,
                              RELATE == 70 ~ 4,
                              RELATE == 90 ~ 4,
                              RELATE == 95 ~ 5,
                              RELATE == -1 ~ 9),
           
           RELATED_n=case_when(RELATE == 1 ~ 1000,
                               RELATE == 10 ~ 2000,
                               RELATE == 11 ~ 2100,
                               RELATE == 12 ~ 2200,
                               RELATE == 20 ~ 3000,
                               RELATE == 21 ~ 3000,
                               RELATE == 22 ~ 3300,
                               RELATE == 30 ~ 3400,
                               RELATE == 40 ~ 4100,
                               RELATE == 50 ~ 4200,
                               RELATE == 51 ~ 4200,
                               RELATE == 52 ~ 4211,
                               RELATE == 60 ~ 4220,
                               RELATE == 80 ~ 4410,
                               RELATE == 81 ~ 4410,
                               RELATE == 82 ~ 4420,
                               RELATE == 70 ~ 4500,
                               RELATE == 90 ~ 4900,
                               RELATE == 95 ~ 5000,
                               RELATE == -1 ~ 9999))
  
  
  df$RELATE<-labelled(x=df$RELATE_n,
                      labels=c("Head"=1, 
                               "Spouse/partner"=2,
                               "Child"=3, 
                               "Other relative"=4,
                               "Non-relative"=5,
                               "Other relative or non-relative"=6,
                               "Missing" = 8,
                               "Unknown"=9),
                      label="Relationship to household head [general version]")
  
  
  df$RELATED<-labelled(x=df$RELATED_n,
                       labels=c("Head" = 1000,#
                                "Spouse/Partner" = 2000,#
                                "Spouse" = 2100,#
                                "Co-Spouse"=2110,
                                "Unmarried partner"= 2200,#
                                
                                "Child" = 3000,#
                                "Biological child" = 3100,#
                                "Adopted child" = 3200,#
                                "Adopted/foster child" = 3210,#
                                "Foster child"= 3220,#
                                "Stepchild" = 3300,#
                                "Child/child-in-law" = 3400,#
                                
                                "Grandchild" = 4100,#
                                "Parent" = 4210,#
                                "Parent-in-law" = 4220,
                                "Parent/parent-in-law" = 4200,
                                
                                "Sibling" = 4410,#
                                "Stepsibling" = 4420,#
                                
                                "Aunt/uncle" = 4700,#
                                "Sibling-in-law" = 4430,#
                                
                                "Nephew/niece" = 4810,#
                                "Niece/nephew in law" = 4811,#
                                "Niece/nephew by blood" = 4812,#
                                "Niece/nephew by marriage" = 4813,#
                                
                                "Other relative, not elsewhere classified" = 4900,#
                                "Other relative with different family name"=4920,
                                "Grandparent" = 4500,#
                                "Great grandchild" = 4120,
                                
                                "Non relative" = 5000,#
                                "Domestic employee" = 5210,#
                                "Relative of employee, n.s." = 5220,#
                                "Herdboy"=5230,
                                "Tenant"=5700,
                                "Non-relative, n.e.c." = 5900,#
                                
                                "Unknown " = 9999,
                                "Missing " = 8888),
                       label="Relationship to household head [general version]")
  
  
  
  regionw<-as.data.frame(regionw)
  df<-as.data.frame(df)
  df<- data.frame(df,
                  regionw[match(df[,"COUNTRY"],
                                regionw[,"country"]),c("ISO3","REGIONW")])
  #colnames(aver)[grep(names(aver%>% select(last_col())), colnames(aver))]<-"REGIONW"
  
  
  df<-df%>%
    mutate(CONTINENT=case_when(REGIONW == 11 ~ "Eastern Africa",
                               REGIONW == 12 ~ "Middle Africa",
                               REGIONW == 13 ~ "Northern Africa",
                               REGIONW == 14 ~ "Southern Africa",
                               REGIONW == 15 ~ "Western Africa",
                               REGIONW == 21 ~ "Caribbean" ,
                               REGIONW == 22 ~ "Central America" ,
                               REGIONW == 23 ~ "South America" ,
                               REGIONW == 24 ~ "North America",
                               REGIONW == 31 ~ "Central Asia",
                               REGIONW == 32 ~ "Eastern Asia",
                               REGIONW == 33 ~ "Southern Asia" ,
                               REGIONW == 34 ~ "South-Eastern Asia",
                               REGIONW == 35 ~ "Western Asia",
                               REGIONW == 41 ~ "Eastern Europe" ,
                               REGIONW == 42 ~ "Northern Europe" ,
                               REGIONW == 43 ~ "Southern Europe",
                               REGIONW == 44 ~ "Western Europe",
                               REGIONW == 51 ~ "Australia and New Zealand" ,
                               REGIONW == 52 ~ "Melanesia",
                               REGIONW == 53 ~ "Micronesia",
                               REGIONW == 54 ~ "Polynesia"))
  
  df<-df%>%
    mutate(CONT2=case_when(CONTINENT == "Eastern Africa" ~ "AFRICA",
                           CONTINENT == "Middle Africa" ~ "AFRICA",
                           CONTINENT == "Northern Africa" ~ "AFRICA",
                           CONTINENT == "Southern Africa" ~ "AFRICA",
                           CONTINENT == "Western Africa" ~ "AFRICA",
                           CONTINENT == "Caribbean" ~ "LATIN-AMERICA",
                           CONTINENT == "Central America" ~ "LATIN-AMERICA",
                           CONTINENT == "South America" ~ "LATIN-AMERICA",
                           CONTINENT == "North America" ~ "NORTH-AMERICA",
                           CONTINENT == "Central Asia" ~ "ASIA",
                           CONTINENT == "Eastern Asia" ~ "ASIA",
                           CONTINENT == "Southern Asia" ~ "ASIA",
                           CONTINENT == "South-Eastern Asia" ~ "ASIA",
                           CONTINENT == "Western Asia" ~ "ASIA",
                           CONTINENT == "Eastern Europe" ~ "EUROPE",
                           CONTINENT == "Northern Europe" ~ "EUROPE",
                           CONTINENT == "Southern Europe" ~ "EUROPE",
                           CONTINENT == "Western Europe" ~ "EUROPE",
                           CONTINENT == "Australia and New Zealand" ~ "OCEANIA",
                           CONTINENT == "Melanesia" ~ "OCEANIA",
                           CONTINENT == "Micronesia" ~ "OCEANIA",
                           CONTINENT == "Polynesia" ~ "OCEANIA"))
}

system.time(
  CORE_SILC_LIST<-parLapply(cl, samples_SILC_LIST2, FUN_CORE_SILC_LIST)
)

FUN_PASO1_SILC_LIST <-  function(df) {
  library(tidyverse)
  library(haven)  
  df$SOURCE<-"SILC"
  df$SAMPLE<-with(df,paste(ISO3, YEAR, SOURCE, sep="_"))
  df<-df %>%
    add_count(HHID)%>%
    mutate(#hhid=paste(HHNUM,REFWEEK, sep="-"),
      child5=ifelse(AGE<=4,1,0),
      adult18=ifelse(AGE>=18,1,0),
      adult18M=ifelse((AGE>=18&RB090==1),1,0),
      adult18F=ifelse((AGE>=18&RB090==2),1,0),
      child18=ifelse(AGE<18,1,0),
      elderly65=ifelse(AGE>=65,1,0),
      
      age00_09=ifelse((AGE2=="0-4"|AGE2=="5-9"),1,0),
      age10_19=ifelse((AGE2=="10-14"|AGE2=="15-19"),1,0),
      age20_29=ifelse((AGE2=="20-24"|AGE2=="25-29"),1,0),
      age30_39=ifelse((AGE2=="30-34"|AGE2=="35-39"),1,0),
      age40_49=ifelse((AGE2=="40-44"|AGE2=="45-49"),1,0),
      age50_59=ifelse((AGE2=="50-54"|AGE2=="55-59"),1,0),
      age60_69=ifelse((AGE2=="60-64"|AGE2=="65-69"),1,0),
      age70_79=ifelse((AGE2=="70-74"|AGE2=="75-79"),1,0),
      age80=ifelse(AGE>=80,1,0),
      
      heads=ifelse(RELATE==1,1,0), 
      spouses=ifelse(RELATE==2,1,0),
      childs=ifelse(RELATE==3,1,0),
      other_relatives=ifelse(RELATE==4,1,0),
      non_relatives=ifelse(RELATE==5,1,0),
      other_rel_or_non_rel=ifelse(RELATE==6,1,0),
      
      grandchilds=ifelse(RELATED %in% c(4100, 4110,4120,4130),1,0),
      parents=ifelse(RELATED %in% c(4200,4210,4211,4220 ),1,0),
      siblings=ifelse(RELATED %in% c(4400,4410,4420,4430,4431,4432),1,0),
      
      WEIGHT_POP= sum(RB050,na.rm = TRUE)*1000,
      #WEIGHT_A= sum(df[df$RELATE==1,"PWEIGHT_A"]),
      WEIGHT_A= sum(RB050[RELATE==1],na.rm = TRUE),
      WEIGHT_A2= sum(RB050[RELATE==1&n==2]),
      WEIGHT_A3= sum(RB050[RELATE==1&n==3]),
      WEIGHT_A4= sum(RB050[RELATE==1&n==4]),
      WEIGHT_A5= sum(RB050[RELATE==1&n==5]),
      WEIGHT_AM= sum(RB050[RELATE==1&RB090==1]),
      WEIGHT_AF= sum(RB050[RELATE==1&RB090==2]),
      WEIGHT_2029=sum(RB050[RELATE==1&age20_29==1]),
      WEIGHT_3039=sum(RB050[RELATE==1&age30_39==1]),
      WEIGHT_4049=sum(RB050[RELATE==1&age40_49==1]),
      WEIGHT_5059=sum(RB050[RELATE==1&age50_59==1]),
      WEIGHT_6069=sum(RB050[RELATE==1&age60_69==1]),
      headed2029=ifelse((RELATE==1 &age20_29==1),1,0), 
      headed3039=ifelse((RELATE==1 &age30_39==1),1,0),
      headed4049=ifelse((RELATE==1 &age40_49==1),1,0),
      headed5059=ifelse((RELATE==1 &age50_59==1),1,0),
      headed6069=ifelse((RELATE==1 &age60_69==1),1,0),
      
      M_headed=ifelse((RELATE==1 & RB090==1),1,0),
      F_headed=ifelse((RELATE==1 & RB090==2),1,0))|>
    drop_na(RB050)
  
  
}

system.time(
  PASO1_SILC_LIST<-parLapply(cl, CORE_SILC_LIST, FUN_PASO1_SILC_LIST)
)

FUN_PASO2_SILC_LIST <-  function(df) {
  library(tidyverse)
  library(haven) 
  df<-df|>
    group_by(HHID)|>
    mutate(hh_per1=n(),
           hh_parents=sum(parents*RB050),
           hh_grandchilds=sum(grandchilds*RB050),
           hh_heads=sum(heads*RB050),
           hh_spouses=sum(spouses*RB050),
           hh_childs=sum(childs*RB050),
           hh_other_relatives=sum(other_relatives*RB050),
           hh_non_relatives=sum(non_relatives*RB050),
           hh_other_rel_or_non_rel=sum(other_rel_or_non_rel*RB050))|>
    mutate(family_type= #ifelse(hh_per1==1, 10, # unipersonal households 
             ifelse(hh_per1==1&AGE<50, 11, # unipersonal households 
                    ifelse(hh_per1==1&AGE>=50, 12, # unipersonal households 
                           ifelse(hh_spouses>0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20, #nuclear 
                                  ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives ==0 & hh_non_relatives==0,20,#nuclear 
                                         ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20,#nuclear 
                                                
                                                
                                                ifelse(hh_spouses>0 & hh_childs>0 &  hh_other_relatives >0 & hh_non_relatives==0,31,# nuclear + other relatives
                                                       ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives >0 & hh_non_relatives==0,31,
                                                              ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives >0 & hh_non_relatives==0,31,
                                                                     
                                                                     ifelse(hh_spouses>0 & hh_childs>0 &  hh_other_relatives ==0 & hh_non_relatives>0,32,
                                                                            ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives ==0 & hh_non_relatives>0,32,
                                                                                   ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives>0,32,       
                                                                                          
                                                                                          ifelse(hh_spouses>0 & hh_childs>0 &  hh_other_relatives >0 & hh_non_relatives>0,33,
                                                                                                 ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives >0 & hh_non_relatives>0,33,
                                                                                                        ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives >0 & hh_non_relatives>0,33,        
                                                                                                               
                                                                                                               ifelse(hh_spouses==0 & hh_childs==0 &  hh_other_relatives >0 & hh_non_relatives==0,34,
                                                                                                                      ifelse(hh_spouses==0 & hh_childs==0 &  hh_other_relatives ==0 & hh_non_relatives>0,35,
                                                                                                                             ifelse(hh_spouses==0 & hh_childs==0 &  hh_other_relatives >0 & hh_non_relatives>0,36,
                                                                                                                                    0))))))))))))))))))|>
    mutate(family_type2=ifelse(hh_per1==1, 10,
                               ifelse(hh_spouses>0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20,
                                      ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives ==0 & hh_non_relatives==0,20,
                                             ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20,       
                                                    ifelse(hh_non_relatives>0,30, # "Other non family",
                                                           ifelse((hh_parents>0 | hh_grandchilds>0),40,# "Stem family",
                                                                  ifelse(hh_other_relatives>0,50, 9999))))))))|>
    
    mutate(family_type3=ifelse(any(F_headed==1)&(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0),21,9999))|>#monomarental )
    ungroup()
  
}

system.time(
  PASO2_SILC_LIST<-parLapply(cl, PASO1_SILC_LIST, FUN_PASO2_SILC_LIST)
)

rm(PASO1_SILC_LIST)
gc()

FUN_PASO3_SILC_LIST <-  function(df) {
  library(tidyverse)
  library(haven) 
  df<-df |>
    mutate(#WEIGHT_FT10= sum(PWEIGHT[family_type==10]),
      WEIGHT_FT11= sum(RB050[family_type==11]),
      WEIGHT_FT12= sum(RB050[family_type==12]),
      WEIGHT_FT20= sum(RB050[RELATE==1&family_type==20]),
      WEIGHT_FT31= sum(RB050[RELATE==1&family_type==31]),
      WEIGHT_FT32= sum(RB050[RELATE==1&family_type==32]),
      WEIGHT_FT33= sum(RB050[RELATE==1&family_type==33]),
      WEIGHT_FT34= sum(RB050[RELATE==1&family_type==34]),
      WEIGHT_FT35= sum(RB050[RELATE==1&family_type==35]),
      WEIGHT_FT36= sum(RB050[RELATE==1&family_type==36]),
      WEIGHT_FT00= sum(RB050[RELATE==1&family_type==0]),
      
      WEIGHT_FT210= sum(RB050[family_type2==10]),
      WEIGHT_FT220= sum(RB050[RELATE==1&family_type2==20]),
      WEIGHT_FT230= sum(RB050[RELATE==1&family_type2==30]),
      WEIGHT_FT240= sum(RB050[RELATE==1&family_type2==40]),
      WEIGHT_FT250= sum(RB050[RELATE==1&family_type2==50]),
      WEIGHT_FT299= sum(RB050[RELATE==1&family_type2==9999]),
      
      WEIGHT_FT321= sum(RB050[RELATE==1&family_type3==21])
    )  
  
} 

system.time(
  PASO3_SILC_LIST<-parLapply(cl, PASO2_SILC_LIST, FUN_PASO3_SILC_LIST)
)

rm(PASO2_SILC_LIST)
gc()

FUN_PASO4_SILC_LIST <-  function(df) {
  library(tidyverse)
  library(haven)
  df<-df |> 
    group_by(SAMPLE,ISO3,YEAR,HHID,CONTINENT,SOURCE,
             CENSUS_ROUND,DECADE,FIVE_YEAR,CONT2,
             WEIGHT_POP,WEIGHT_A,WEIGHT_A2,WEIGHT_A3,WEIGHT_A4,
             WEIGHT_A5, WEIGHT_AM,WEIGHT_AF,WEIGHT_2029,WEIGHT_3039,WEIGHT_4049,
             WEIGHT_5059,WEIGHT_6069,
             WEIGHT_FT11, WEIGHT_FT12,
             WEIGHT_FT20,
             WEIGHT_FT31,WEIGHT_FT32,WEIGHT_FT33,WEIGHT_FT34,WEIGHT_FT35,
             WEIGHT_FT36,WEIGHT_FT00,WEIGHT_FT210,WEIGHT_FT220,WEIGHT_FT230,
             WEIGHT_FT240,WEIGHT_FT250,WEIGHT_FT299,
             WEIGHT_FT321,
             family_type,
             family_type2,
             family_type3)|>
    summarise(hh=1,
              hh_per1=n(),
              hh_m=sum(M_headed),
              hh_f=sum(F_headed),
              hh_per=sum(hh*RB050),
              hh_child5=sum(child5*RB050),
              hh_adult18=sum(adult18*RB050),
              hh_adult18b=sum(adult18),
              
              hh_00_09=sum(age00_09*RB050),
              hh_10_19=sum(age10_19*RB050),
              hh_20_29=sum(age20_29*RB050),
              hh_30_39=sum(age30_39*RB050),
              hh_40_49=sum(age40_49*RB050),
              hh_50_59=sum(age50_59*RB050),
              hh_60_69=sum(age60_69*RB050),
              hh_70_79=sum(age70_79*RB050),
              hh_80=sum(age80*RB050),
              
              hh_adult18M=sum(adult18M*RB050),
              hh_adult18F=sum(adult18F*RB050),
              hh_adult18Mb=sum(adult18M),
              
              hh_child18=sum(child18*RB050),
              hh_elderly65=sum(elderly65*RB050),
              
              hh_heads=sum(heads*RB050),
              hh_spouses=sum(spouses*RB050),
              hh_childs=sum(childs*RB050),
              hh_other_relatives=sum(other_relatives*RB050),
              hh_non_relatives=sum(non_relatives*RB050),
              hh_other_rel_or_non_rel=sum(other_rel_or_non_rel*RB050),
              
              hh_grandchilds=sum(grandchilds*RB050),
              hh_parents=sum(parents*RB050),
              hh_siblings=sum(siblings*RB050), 
              hh_M_headed=sum(M_headed*RB050),
              hh_F_headed=sum(F_headed*RB050),
              hh_headed2029=sum(headed2029*RB050),
              hh_headed3039=sum(headed3039*RB050),
              hh_headed4049=sum(headed4049*RB050),
              hh_headed5059=sum(headed5059*RB050),
              hh_headed6069=sum(headed6069*RB050)
    )|>
    ungroup()
} 

system.time(
  PASO4_SILC_LIST<-parLapply(cl, PASO3_SILC_LIST, FUN_PASO4_SILC_LIST)
)

rm(PASO3_SILC_LIST)
gc()

FUN_PASO5_SILC_LIST <-  function(df) {
  library(tidyverse)
  library(haven)
  df<-df |>
    group_by(ISO3,YEAR,SOURCE,SAMPLE,CONTINENT,CONT2,CENSUS_ROUND,DECADE,FIVE_YEAR)|>
    summarise(WPOP=round(unique(WEIGHT_POP),0),
              
              HS01=sum(ifelse(hh_per1==1,hh,0))/sum(hh),
              HS02=sum(ifelse(hh_per1==2,hh,0))/sum(hh),
              HS03=sum(ifelse(hh_per1==3,hh,0))/sum(hh),
              HS04=sum(ifelse(hh_per1==4,hh,0))/sum(hh),
              HS05=sum(ifelse(hh_per1==5,hh,0))/sum(hh),
              HS06=sum(ifelse(hh_per1==6,hh,0))/sum(hh),
              HS07=sum(ifelse(hh_per1==7,hh,0))/sum(hh),
              HS08=sum(ifelse(hh_per1==8,hh,0))/sum(hh),
              HS09=sum(ifelse(hh_per1==9,hh,0))/sum(hh),
              HS10=sum(ifelse(hh_per1==10,hh,0))/sum(hh),
              HS11=sum(ifelse(hh_per1>10,hh,0))/sum(hh),
              HS12=sum(ifelse((hh_per1==2|hh_per1==3),hh,0))/sum(hh),
              HS13=sum(ifelse((hh_per1==4|hh_per1==5),hh,0))/sum(hh),
              HS14=sum(ifelse(hh_per1>=6,hh,0))/sum(hh),
              HS15=sum(hh_child5 != 0)/sum(hh),
              HS16=sum(hh_elderly65 != 0)/sum(hh),
              HS17=sum(hh_per)/unique(WEIGHT_A),
              HS18=sum(hh_child5)/unique(WEIGHT_A),
              HS19=sum(hh_adult18)/unique(WEIGHT_A),
              HS20=sum(hh_child18)/unique(WEIGHT_A),
              HS21=sum(hh_elderly65)/unique(WEIGHT_A),
              HS22=sum(hh_00_09)/unique(WEIGHT_A),
              HS23=sum(hh_10_19)/unique(WEIGHT_A),
              HS24=sum(hh_20_29)/unique(WEIGHT_A),
              HS25=sum(hh_30_39)/unique(WEIGHT_A),
              HS26=sum(hh_40_49)/unique(WEIGHT_A),
              HS27=sum(hh_50_59)/unique(WEIGHT_A),
              HS28=sum(hh_60_69)/unique(WEIGHT_A),
              HS29=sum(hh_70_79)/unique(WEIGHT_A),
              HS30=sum(hh_80)/unique(WEIGHT_A),
              
              HR01=sum(hh_heads)/unique(WEIGHT_A),
              HR02=sum(hh_spouses)/unique(WEIGHT_A),
              HR03=sum(hh_childs)/unique(WEIGHT_A),
              HR04=sum(hh_other_relatives)/unique(WEIGHT_A),
              HR05=sum(hh_non_relatives)/unique(WEIGHT_A),
              HR06=sum(hh_other_rel_or_non_rel)/unique(WEIGHT_A),
              
              HR07=sum(hh_heads[hh_per1==2])/unique(WEIGHT_A2),
              HR08=sum(hh_spouses[hh_per1==2])/unique(WEIGHT_A2),
              HR09=sum(hh_childs[hh_per1==2])/unique(WEIGHT_A2),
              HR10=sum(hh_other_relatives[hh_per1==2])/unique(WEIGHT_A2),
              HR11=sum(hh_non_relatives[hh_per1==2])/unique(WEIGHT_A2),
              HR12=sum(hh_other_rel_or_non_rel[hh_per1==2])/unique(WEIGHT_A2),
              
              HR13=sum(hh_heads[hh_per1==3])/unique(WEIGHT_A3),
              HR14=sum(hh_spouses[hh_per1==3])/unique(WEIGHT_A3),
              HR15=sum(hh_childs[hh_per1==3])/unique(WEIGHT_A3),
              HR16=sum(hh_other_relatives[hh_per1==3])/unique(WEIGHT_A3),
              HR17=sum(hh_non_relatives[hh_per1==3])/unique(WEIGHT_A3),
              HR18=sum(hh_other_rel_or_non_rel[hh_per1==3])/unique(WEIGHT_A3),
              
              HR19=sum(hh_heads[hh_per1==4])/unique(WEIGHT_A4),
              HR20=sum(hh_spouses[hh_per1==4])/unique(WEIGHT_A4),
              HR21=sum(hh_childs[hh_per1==4])/unique(WEIGHT_A4),
              HR22=sum(hh_other_relatives[hh_per1==4])/unique(WEIGHT_A4),
              HR23=sum(hh_non_relatives[hh_per1==4])/unique(WEIGHT_A4),
              HR24=sum(hh_other_rel_or_non_rel[hh_per1==4])/unique(WEIGHT_A4),
              
              HR25=sum(hh_heads[hh_per1==5])/unique(WEIGHT_A5),
              HR26=sum(hh_spouses[hh_per1==5])/unique(WEIGHT_A5),
              HR27=sum(hh_childs[hh_per1==5])/unique(WEIGHT_A5),
              HR28=sum(hh_other_relatives[hh_per1==5])/unique(WEIGHT_A5),
              HR29=sum(hh_non_relatives[hh_per1==5])/unique(WEIGHT_A5),
              HR30=sum(hh_other_rel_or_non_rel[hh_per1==5])/unique(WEIGHT_A5),
              
              HT01=sum(ifelse(family_type==11|family_type==12,1,0)/sum(hh)),
              HT01b=sum(ifelse(family_type==11,1,0)/sum(hh)),
              HT01c=sum(ifelse(family_type==12,1,0)/sum(hh)),
              HT02=sum(ifelse(family_type==20,1,0)/sum(hh)),
              HT03=sum(ifelse(family_type==31,1,0)/sum(hh)),
              HT04=sum(ifelse(family_type==32,1,0)/sum(hh)),
              HT05=sum(ifelse(family_type==33,1,0)/sum(hh)),
              HT06=sum(ifelse(family_type==34,1,0)/sum(hh)),
              HT07=sum(ifelse(family_type==35,1,0)/sum(hh)),
              HT08=sum(ifelse(family_type==36,1,0)/sum(hh)),
              HT09=sum(ifelse(family_type==0,1,0)/sum(hh)),
              
              HT10=sum(hh_per[family_type==11|family_type==12])/(unique(WEIGHT_FT11)+unique(WEIGHT_FT12)),
              HT11=sum(hh_per[family_type==20])/unique(WEIGHT_FT20),
              HT12=sum(hh_per[family_type==31])/unique(WEIGHT_FT31),
              HT13=sum(hh_per[family_type==32])/unique(WEIGHT_FT32),
              HT14=sum(hh_per[family_type==33])/unique(WEIGHT_FT33),
              HT15=sum(hh_per[family_type==34])/unique(WEIGHT_FT34),
              HT16=sum(hh_per[family_type==35])/unique(WEIGHT_FT35),
              HT17=sum(hh_per[family_type==36])/unique(WEIGHT_FT36),
              HT18=sum(hh_per[family_type==0])/unique(WEIGHT_FT00),
              
              HT20=sum(ifelse(family_type2==10,1,0)/sum(hh)),
              HT21=sum(ifelse(family_type2==20,1,0)/sum(hh)),
              HT22=sum(ifelse(family_type2==40,1,0)/sum(hh)),
              HT23=sum(ifelse(family_type2==50,1,0)/sum(hh)),
              HT24=sum(ifelse(family_type2==30,1,0)/sum(hh)),
              HT25=sum(ifelse(family_type2==9999,1,0)/sum(hh)),
              HT26=sum(hh_per[family_type2==10])/unique(WEIGHT_FT210),
              HT27=sum(hh_per[family_type2==20])/unique(WEIGHT_FT220),
              HT28=sum(hh_per[family_type2==40])/unique(WEIGHT_FT240),
              HT29=sum(hh_per[family_type2==50])/unique(WEIGHT_FT250),
              HT30=sum(hh_per[family_type2==30])/unique(WEIGHT_FT230),
              HT31=sum(hh_per[family_type2==9999])/unique(WEIGHT_FT299),
              
              HH01=sum(hh_M_headed[hh_M_headed!=0])/unique(WEIGHT_A),
              HH02=sum(hh_F_headed[hh_F_headed!=0])/unique(WEIGHT_A),
              
              HH03=sum(ifelse((hh_m==1 &hh_per1==1),hh,0))/sum(hh_m),
              HH04=sum(ifelse((hh_m==1 &hh_per1==2),hh,0))/sum(hh_m),
              HH05=sum(ifelse((hh_m==1 &hh_per1==3),hh,0))/sum(hh_m),
              HH06=sum(ifelse((hh_m==1 &hh_per1==4),hh,0))/sum(hh_m),
              HH07=sum(ifelse((hh_m==1 &hh_per1==5),hh,0))/sum(hh_m),
              HH08=sum(ifelse((hh_m==1 &hh_per1==6),hh,0))/sum(hh_m),
              HH09=sum(ifelse((hh_m==1 &hh_per1==7),hh,0))/sum(hh_m),
              HH10=sum(ifelse((hh_m==1 &hh_per1==8),hh,0))/sum(hh_m),
              HH11=sum(ifelse((hh_m==1 &hh_per1==9),hh,0))/sum(hh_m),
              HH12=sum(ifelse((hh_m==1 &hh_per1==10),hh,0))/sum(hh_m),
              HH13=sum(ifelse((hh_m==1 &hh_per1>10),hh,0))/sum(hh_m),
              
              HH14=sum(ifelse((hh_f==1 &hh_per1==1),hh,0))/sum(hh_f),
              HH15=sum(ifelse((hh_f==1 &hh_per1==2),hh,0))/sum(hh_f),
              HH16=sum(ifelse((hh_f==1 &hh_per1==3),hh,0))/sum(hh_f),
              HH17=sum(ifelse((hh_f==1 &hh_per1==4),hh,0))/sum(hh_f),
              HH18=sum(ifelse((hh_f==1 &hh_per1==5),hh,0))/sum(hh_f),
              HH19=sum(ifelse((hh_f==1 &hh_per1==6),hh,0))/sum(hh_f),
              HH20=sum(ifelse((hh_f==1 &hh_per1==7),hh,0))/sum(hh_f),
              HH21=sum(ifelse((hh_f==1 &hh_per1==8),hh,0))/sum(hh_f),
              HH22=sum(ifelse((hh_f==1 &hh_per1==9),hh,0))/sum(hh_f),
              HH23=sum(ifelse((hh_f==1 &hh_per1==10),hh,0))/sum(hh_f),
              HH24=sum(ifelse((hh_f==1 &hh_per1>10),hh,0))/sum(hh_f),
              
              HH25=sum(ifelse((hh_m==1 &family_type2==10),1,0)/sum(hh_m)),
              HH26=sum(ifelse((hh_m==1 &family_type2==20),1,0)/sum(hh_m)),
              HH27=sum(ifelse((hh_m==1 &family_type2==40),1,0)/sum(hh_m)),
              HH28=sum(ifelse((hh_m==1 &family_type2==50),1,0)/sum(hh_m)),
              HH29=sum(ifelse((hh_m==1 &family_type2==30),1,0)/sum(hh_m)),
              HH30=sum(ifelse((hh_m==1 &family_type2==9999),1,0)/sum(hh_m)),
              
              HH31=sum(ifelse((hh_f==1 &family_type2==10),1,0)/sum(hh_f)),
              HH32=sum(ifelse((hh_f==1 &family_type2==20),1,0)/sum(hh_f)),
              HH33=sum(ifelse((hh_f==1 &family_type2==40),1,0)/sum(hh_f)),
              HH34=sum(ifelse((hh_f==1 &family_type2==50),1,0)/sum(hh_f)),
              HH35=sum(ifelse((hh_f==1 &family_type2==30),1,0)/sum(hh_f)),
              HH36=sum(ifelse((hh_f==1 &family_type2==9999),1,0)/sum(hh_f)),
              
              HH37=sum(hh_per[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH38=sum(hh_per[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH39=sum(hh_child18[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH40=sum(hh_child18[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH41=sum(hh_adult18[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH42=sum(hh_adult18[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH43=sum(hh_elderly65[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH44=sum(hh_elderly65[hh_F_headed!=0])/unique(WEIGHT_AF),
              
              HH45=sum(hh_spouses[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH46=sum(hh_spouses[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH47=sum(hh_childs[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH48=sum(hh_childs[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH49=sum(hh_other_relatives[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH50=sum(hh_other_relatives[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH51=sum(hh_non_relatives[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH52=sum(hh_non_relatives[hh_F_headed!=0])/unique(WEIGHT_AF),
              
              HH53=sum(hh_adult18M[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH54=sum(hh_adult18M[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH55=sum(hh_adult18F[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH56=sum(hh_adult18F[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH57=sum(hh[hh_adult18Mb==0]),
              HH58=sum(hh[hh_adult18Mb==1]),
              HH59=sum(hh[hh_adult18Mb==2]),
              HH60=sum(hh[hh_adult18Mb==3]),
              HH61=sum(hh[hh_adult18Mb==4]),
              HH62=sum(hh[hh_adult18Mb==5]),
              HH63=sum(hh[hh_adult18Mb>=6]),
              
              HH64=sum(hh_m[hh_adult18Mb==0]),
              HH65=sum(hh_m[hh_adult18Mb==1]),
              HH66=sum(hh_m[hh_adult18Mb==2]),
              HH67=sum(hh_m[hh_adult18Mb==3]),
              HH68=sum(hh_m[hh_adult18Mb==4]),
              HH69=sum(hh_m[hh_adult18Mb==5]),
              HH70=sum(hh_m[hh_adult18Mb>=6]),
              
              HH71=sum(hh_f[hh_adult18Mb==0]),
              HH72=sum(hh_f[hh_adult18Mb==1]),
              HH73=sum(hh_f[hh_adult18Mb==2]),
              HH74=sum(hh_f[hh_adult18Mb==3]),
              HH75=sum(hh_f[hh_adult18Mb==4]),
              HH76=sum(hh_f[hh_adult18Mb==5]),
              HH77=sum(hh_f[hh_adult18Mb>=6]),
              HTMM=sum(ifelse(family_type3==21,1,0)/sum(hh))
    )
  
  
}

system.time(
  PASO5_SILC_LIST<-parLapply(cl, PASO4_SILC_LIST, FUN_PASO5_SILC_LIST)
)

agrr_database_silc <- data.table::rbindlist(PASO5_SILC_LIST)

regionw <- read_excel("G:/Shared drives/CORESIDENCE/WP4_RESEARCH OUTPUT/4_1_Articles/(1) Household size and composition a global update/DATABASE/regionw.xlsx")
regionw<-as.data.frame(regionw)
agrr_database_silc<-as.data.frame(agrr_database_silc)
agrr_database_silc<- data.frame(agrr_database_silc,
                                regionw[match(agrr_database_silc[,"ISO3"],
                                              regionw[,"ISO3"]),c("EU Member States")])

colnames(agrr_database_silc)[grep(names(agrr_database_silc %>% select(last_col())), colnames(agrr_database_silc))]<-"CNTRY"

save(agrr_database_silc, file="G:/Shared drives/CORESIDENCE/WP4_RESEARCH OUTPUT/4_1_Articles/(9) Gender asymmetries in household headship/DATABASE/AGGR_INDICATORS_SILC_RITA.RData")

##### KOREA #######
#### KOREAN DATA 1970 ######

load("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/KOR_1970_CENSUS.RData")

unique(df$relate)


df$relate<-as.factor(df$relate)

df<-df %>% 
  mutate(relate=fct_explicit_na(relate, na_level = "Missing"))

relate<- df%>% 
  group_by(relate) %>% 
  summarise(n=n())%>% 
  mutate(n_rel = round(n / sum(n)*100,2))



df<-df%>%
  mutate(RELATE_n=case_when(relate == 1 ~ 1,
                            relate == 2 ~ 2,
                            relate == 3 ~ 3,
                            relate == 4 ~ 4,
                            relate == 5 ~ 4,
                            relate == 6 ~ 4,
                            relate == 7 ~ 4,
                            relate == 8 ~ 4,
                            relate == 9 ~ 3,
                            relate == 10 ~ 4,
                            relate == 11 ~ 5,
                            relate == 12 ~ 1,
                            relate == 20 ~ 3,
                            relate == 21 ~ 3,
                            relate == 30 ~ 5,
                            relate == 31 ~ 3,
                            relate == "Missing"~ 8),
         
         RELATED_n=case_when(relate == 1 ~ 1000,
                             relate == 2 ~ 2100,
                             relate == 3 ~ 3100,
                             relate == 4 ~ 4410,
                             relate == 5 ~ 4210,
                             relate == 6 ~ 4500,
                             relate == 7 ~ 4431,
                             relate == 8 ~ 4220,
                             relate == 9 ~ 3100,
                             relate == 10 ~ 4900,
                             relate == 11 ~ 5000,
                             relate == 12 ~ 1000,
                             relate == 20 ~ 3100,
                             relate == 21 ~ 3100,
                             relate == 30 ~ 5000,
                             relate == 31 ~ 3100,
                             relate == "Missing"~ 8888))


df$RELATE<-labelled(x=df$RELATE_n,
                    labels=c("Head"=1, 
                             "Spouse/partner"=2,
                             "Child"=3, 
                             "Other relative"=4,
                             "Non-relative"=5,
                             "Other relative or non-relative"=6,
                             "Missing" = 8,
                             "Unknown"=9),
                    label="Relationship to household head [general version]")


df$RELATED<-labelled(x=df$RELATED_n,
                     labels=c("Head" = 1000,#
                              
                              "Spouse/Partner" = 2000,#
                              "Spouse" = 2100,#
                              
                              "Biological child" = 3100,#
                              
                              "Sibling" = 4410,#
                              "Parent" = 4210,#
                              "Grandparent" = 4500,#
                              "Sibling of spouse/partner" = 4431,#
                              "Parent-in-law" = 4220,
                              "Other relative, not elsewhere classified" = 4900,#
                              
                              "Non relative" = 5000,#
                              
                              "Missing " = 8888),
                     label="Relationship to household head [general version]")


df_1970<-df

#### KOREAN DATA 1975 ######

load("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/KOR_1975_CENSUS.RData")

unique(df$relate)


df$relate<-as.factor(df$relate)

df<-df %>% 
  mutate(relate=fct_explicit_na(relate, na_level = "Missing"))

relate<- df%>% 
  group_by(relate) %>% 
  summarise(n=n())%>% 
  mutate(n_rel = round(n / sum(n)*100,2))



df<-df%>%
  mutate(RELATE_n=case_when(relate == 1 ~ 1,
                            relate == 2 ~ 2,
                            relate == 3 ~ 3,
                            relate == 4 ~ 4,
                            relate == 5 ~ 4,
                            relate == 6 ~ 4,
                            relate == 7 ~ 4,
                            relate == 8 ~ 4,
                            relate == 9 ~ 3,
                            relate == 10 ~ 4,
                            relate == 11 ~ 5,
                            relate == 12 ~ 4,
                            relate == 13 ~ 1,
                            relate == 20 ~ 3,
                            relate == 21 ~ 3,
                            relate == 30 ~ 5,
                            relate == 31 ~ 3,
                            relate == "Missing"~ 8),
         
         RELATED_n=case_when(relate == 1 ~ 1000,
                             relate == 2 ~ 2100,
                             relate == 3 ~ 3100,
                             relate == 4 ~ 4410,
                             relate == 5 ~ 4210,
                             relate == 6 ~ 4500,
                             relate == 7 ~ 4431,
                             relate == 8 ~ 4220,
                             relate == 9 ~ 3100,
                             relate == 10 ~ 4900,
                             relate == 11 ~ 5000,
                             relate == 12 ~ 4210,
                             relate == 13 ~ 1000,
                             relate == 20 ~ 3100,
                             relate == 21 ~ 3100,
                             relate == 30 ~ 5000,
                             relate == 31 ~ 3100,
                             relate == "Missing"~ 8888))


df$RELATE<-labelled(x=df$RELATE_n,
                    labels=c("Head"=1, 
                             "Spouse/partner"=2,
                             "Child"=3, 
                             "Other relative"=4,
                             "Non-relative"=5,
                             "Other relative or non-relative"=6,
                             "Missing" = 8,
                             "Unknown"=9),
                    label="Relationship to household head [general version]")


df$RELATED<-labelled(x=df$RELATED_n,
                     labels=c("Head" = 1000,#
                              
                              "Spouse/Partner" = 2000,#
                              "Spouse" = 2100,#
                              
                              "Biological child" = 3100,#
                              
                              "Sibling" = 4410,#
                              "Parent" = 4210,#
                              "Grandparent" = 4500,#
                              "Sibling of spouse/partner"= 4431,#
                              "Parent-in-law" = 4220,
                              "Other relative, not elsewhere classified" = 4900,#
                              
                              "Non relative" = 5000,#
                              
                              "Missing " = 8888),
                     label="Relationship to household head [general version]")


df_1975<-df





#### KOREAN DATA 1980 ######

load("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/KOR_1980_CENSUS.RData")

sort(unique(df$relate))


df$relate<-as.factor(df$relate)

df<-df %>% 
  mutate(relate=fct_explicit_na(relate, na_level = "Missing"))

relate<- df%>% 
  group_by(relate) %>% 
  summarise(n=n())%>% 
  mutate(n_rel = round(n / sum(n)*100,2))



df<-df%>%
  mutate(RELATE_n=case_when(relate == 1 ~ 1,
                            relate == 2 ~ 2,
                            relate == 3 ~ 3,
                            relate == 4 ~ 4,
                            relate == 5 ~ 4,
                            relate == 6 ~ 4,
                            relate == 7 ~ 4,
                            relate == 11 ~ 4,
                            relate == 12 ~ 4,
                            relate == 13 ~ 4,
                            relate == 14 ~ 4,
                            relate == 15 ~ 4,
                            relate == 16 ~ 4,
                            relate == 17 ~ 4,
                            relate == 18 ~ 4,
                            relate == 21 ~ 3,
                            relate == 22 ~ 3,
                            relate == 23 ~ 4,
                            relate == 31 ~ 4,
                            relate == 32 ~ 4,
                            relate == 33 ~ 4,
                            relate == 41 ~ 4,
                            relate == 42 ~ 4,
                            relate == 43 ~ 4,
                            relate == 51 ~ 4,
                            relate == 52 ~ 4,
                            relate == 53 ~ 4,
                            relate == 61 ~ 5,
                            relate == 62 ~ 5,
                            relate == 63 ~ 5,
                            relate == 81 ~ 5,
                            relate == 82 ~ 5,
                            relate == 83 ~ 5,
                            relate == 91 ~ 1,
                            relate == "Missing"~ 8),
         
         RELATED_n=case_when(relate == 1 ~ 1000,
                             relate == 2 ~ 2100,#
                             relate == 3 ~ 3100,#
                             relate == 4 ~ 4410,#
                             relate == 5 ~ 4210,#
                             relate == 6 ~ 4500,#
                             relate == 7 ~ 4510,#
                             relate == 11 ~ 4431,#
                             relate == 12 ~ 4220,#
                             relate == 13 ~ 4500,#
                             relate == 14 ~ 4510,#
                             relate == 15 ~ 4431,
                             relate == 16 ~ 4431,
                             relate == 17 ~ 4431,
                             relate == 18 ~ 4900,
                             relate == 21 ~ 3100,
                             relate == 22 ~ 3400,
                             relate == 23 ~ 4100,
                             relate == 31 ~ 4410,
                             relate == 32 ~ 4432,
                             relate == 33 ~ 4810,
                             relate == 41 ~ 4100,
                             relate == 42 ~ 4100,
                             relate == 43 ~ 4120,
                             relate == 51 ~ 4900,
                             relate == 52 ~ 4900,
                             relate == 53 ~ 4900,
                             relate == 61 ~ 5210,
                             relate == 62 ~ 5220,
                             relate == 63 ~ 5222,
                             relate == 81 ~ 5000,
                             relate == 82 ~ 5000,
                             relate == 83 ~ 5000,
                             relate == 91 ~ 9999,
                             relate == "Missing"~ 8888))


df$RELATE<-labelled(x=df$RELATE_n,
                    labels=c("Head"=1, 
                             "Spouse/partner"=2,
                             "Child"=3, 
                             "Other relative"=4,
                             "Non-relative"=5,
                             "Other relative or non-relative"=6,
                             "Missing" = 8,
                             "Unknown"=9),
                    label="Relationship to household head [general version]")


df$RELATED<-labelled(x=df$RELATED_n,
                     labels=c("Head" = 1000,#
                              "Spouse" = 2100,#
                              "Biological child" = 3100,#
                              "Child/child-in-law"=3400,
                              "Grandchild"=4100,
                              "Great grandchild"=4120,
                              "Parent" = 4210,#
                              "Parent-in-law" = 4220,
                              "Sibling" = 4410,#
                              "Sibling of spouse/partner"=4431,
                              "Spouse/partner of sibling"=4432,
                              "Grandparent" = 4500,#
                              "Great grandparent" = 4510,#
                              "Nephew/niece"=4810,
                              "Other relative, not elsewhere classified" = 4900,#
                              "Non relative" = 5000,#
                              "Domestic employee"=5210,
                              "Relative of employee, n.s."=5220,
                              "Child of servant"=5222,
                              "Unknown"=9999,
                              "Missing " = 8888),
                     label="Relationship to household head [general version]")


df_1980<-df





#### KOREAN DATA 1985 ######

load("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/KOR_1985_CENSUS.RData")

sort(unique(df$relate))


df$relate<-as.factor(df$relate)

df<-df %>% 
  mutate(relate=fct_explicit_na(relate, na_level = "Missing"))

relate<- df%>% 
  group_by(relate) %>% 
  summarise(n=n())%>% 
  mutate(n_rel = round(n / sum(n)*100,2))



df<-df%>%
  mutate(RELATE_n=case_when(relate == 1 ~ 1,
                            relate == 2 ~ 2,
                            relate == 3 ~ 3,
                            relate == 4 ~ 4,
                            relate == 5 ~ 4,
                            relate == 6 ~ 4,
                            relate == 7 ~ 4,
                            relate == 11 ~ 4,
                            relate == 12 ~ 4,
                            relate == 13 ~ 4,
                            relate == 14 ~ 4,
                            relate == 15 ~ 4,
                            relate == 16 ~ 4,
                            relate == 17 ~ 4,
                            relate == 18 ~ 4,
                            relate == 21 ~ 3,
                            relate == 22 ~ 3,
                            relate == 23 ~ 4,
                            relate == 31 ~ 4,
                            relate == 32 ~ 4,
                            relate == 33 ~ 4,
                            relate == 41 ~ 4,
                            relate == 42 ~ 4,
                            relate == 43 ~ 4,
                            relate == 51 ~ 4,
                            relate == 52 ~ 4,
                            relate == 53 ~ 4,
                            relate == 61 ~ 5,
                            relate == 62 ~ 5,
                            relate == 63 ~ 5,
                            relate == 71 ~ 5,
                            relate == 72 ~ 5,
                            relate == 73 ~ 5,
                            relate == 81 ~ 1,
                            relate == "Missing"~ 8),
         
         RELATED_n=case_when(relate == 1 ~ 1000,
                             relate == 2 ~ 2100,#
                             relate == 3 ~ 3100,#
                             relate == 4 ~ 4410,#
                             relate == 5 ~ 4210,#
                             relate == 6 ~ 4500,#
                             relate == 7 ~ 4510,#
                             relate == 11 ~ 4431,#
                             relate == 12 ~ 4220,#
                             relate == 13 ~ 4500,#
                             relate == 14 ~ 4510,#
                             relate == 15 ~ 4431,
                             relate == 16 ~ 4431,
                             relate == 17 ~ 4431,
                             relate == 18 ~ 4900,
                             relate == 21 ~ 3100,
                             relate == 22 ~ 3400,
                             relate == 23 ~ 4100,
                             relate == 31 ~ 4410,
                             relate == 32 ~ 4432,
                             relate == 33 ~ 4810,
                             relate == 41 ~ 4100,
                             relate == 42 ~ 4100,
                             relate == 43 ~ 4120,
                             relate == 51 ~ 4900,
                             relate == 52 ~ 4900,
                             relate == 53 ~ 4900,
                             relate == 61 ~ 5210,
                             relate == 62 ~ 5220,
                             relate == 63 ~ 5222,
                             relate == 71 ~ 5000,
                             relate == 72 ~ 5000,
                             relate == 73 ~ 5000,
                             relate == 81 ~ 9999,
                             relate == "Missing"~ 8888))


df$RELATE<-labelled(x=df$RELATE_n,
                    labels=c("Head"=1, 
                             "Spouse/partner"=2,
                             "Child"=3, 
                             "Other relative"=4,
                             "Non-relative"=5,
                             "Other relative or non-relative"=6,
                             "Missing" = 8,
                             "Unknown"=9),
                    label="Relationship to household head [general version]")


df$RELATED<-labelled(x=df$RELATED_n,
                     labels=c("Head" = 1000,#
                              "Spouse" = 2100,#
                              "Biological child" = 3100,#
                              "Child/child-in-law"=3400,
                              "Grandchild"=4100,
                              "Great grandchild"=4120,
                              "Parent" = 4210,#
                              "Parent-in-law" = 4220,
                              "Sibling" = 4410,#
                              "Sibling of spouse/partner"=4431,
                              "Spouse/partner of sibling"=4432,
                              "Grandparent" = 4500,#
                              "Great grandparent" = 4510,#
                              "Nephew/niece"=4810,
                              "Other relative, not elsewhere classified" = 4900,#
                              "Non relative" = 5000,#
                              "Domestic employee"=5210,
                              "Relative of employee, n.s."=5220,
                              "Child of servant"=5222,
                              "Unknown"=9999,
                              "Missing " = 8888),
                     label="Relationship to household head [general version]")


df_1985<-df


#### KOREAN DATA 1990 ######

load("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/KOR_1990_CENSUS.RData")

sort(unique(df$relate))


df$relate<-as.factor(df$relate)

df<-df %>% 
  mutate(relate=fct_explicit_na(relate, na_level = "Missing"))

relate<- df%>% 
  group_by(relate) %>% 
  summarise(n=n())%>% 
  mutate(n_rel = round(n / sum(n)*100,2))



df<-df%>%
  mutate(RELATE_n=case_when(relate == 1 ~ 1,
                            relate == 2 ~ 2,
                            relate == 3 ~ 3,
                            relate == 4 ~ 4,
                            relate == 5 ~ 4,
                            relate == 6 ~ 4,
                            relate == 7 ~ 4,
                            relate == 8 ~ 4,
                            relate == 9 ~ 4,
                            
                            relate == 11 ~ 4,
                            relate == 12 ~ 4,
                            relate == 13 ~ 4,
                            # relate == 14 ~ 4,
                            relate == 15 ~ 4,
                            relate == 16 ~ 4,
                            relate == 17 ~ 4,
                            relate == 18 ~ 4,
                            relate == 19 ~ 4,
                            relate == 20 ~ 4,
                            relate == 21 ~ 3,
                            relate == 22 ~ 3,
                            relate == 23 ~ 4,
                            relate == 28 ~ 4,
                            relate == 29 ~ 4,
                            
                            relate == 31 ~ 4,
                            relate == 32 ~ 4,
                            relate == 33 ~ 4,
                            relate == 41 ~ 4,
                            relate == 42 ~ 4,
                            relate == 43 ~ 4,
                            relate == 51 ~ 4,
                            relate == 52 ~ 4,
                            relate == 53 ~ 4,
                            relate == 61 ~ 5,
                            relate == 62 ~ 5,
                            relate == 63 ~ 5,
                            relate == 71 ~ 5,
                            relate == 72 ~ 5,
                            relate == 73 ~ 5,
                            #relate == 81 ~ 1,
                            relate == "Missing"~ 8),
         
         RELATED_n=case_when(relate == 1 ~ 1000,
                             relate == 2 ~ 2100,#
                             relate == 3 ~ 3100,#
                             relate == 4 ~ 4410,#
                             relate == 5 ~ 4210,#
                             relate == 6 ~ 4500,#
                             relate == 7 ~ 4510,#
                             relate == 8 ~ 4900,
                             relate == 9 ~ 4900,
                             
                             relate == 11 ~ 4431,#
                             relate == 12 ~ 4220,#
                             relate == 13 ~ 4500,#
                             relate == 14 ~ 4510,#
                             relate == 15 ~ 4431,
                             relate == 16 ~ 4431,
                             relate == 17 ~ 4431,
                             relate == 18 ~ 4900,
                             relate == 19 ~ 4900,
                             relate == 20 ~ 4900,
                             
                             relate == 21 ~ 3100,
                             relate == 22 ~ 3400,
                             relate == 23 ~ 4100,
                             relate == 28 ~ 4900,
                             relate == 29 ~ 4900,
                             
                             relate == 31 ~ 4410,
                             relate == 32 ~ 4432,
                             relate == 33 ~ 4810,
                             relate == 41 ~ 4100,
                             relate == 42 ~ 4100,
                             relate == 43 ~ 4120,
                             relate == 51 ~ 4900,
                             relate == 52 ~ 4900,
                             relate == 53 ~ 4900,
                             relate == 61 ~ 5210,
                             relate == 62 ~ 5220,
                             relate == 63 ~ 5222,
                             relate == 71 ~ 5000,
                             relate == 72 ~ 5000,
                             relate == 73 ~ 5000,
                             relate == 81 ~ 9999,
                             relate == "Missing"~ 8888))


df$RELATE<-labelled(x=df$RELATE_n,
                    labels=c("Head"=1, 
                             "Spouse/partner"=2,
                             "Child"=3, 
                             "Other relative"=4,
                             "Non-relative"=5,
                             "Other relative or non-relative"=6,
                             "Missing" = 8,
                             "Unknown"=9),
                    label="Relationship to household head [general version]")


df$RELATED<-labelled(x=df$RELATED_n,
                     labels=c("Head" = 1000,#
                              "Spouse" = 2100,#
                              "Biological child" = 3100,#
                              "Child/child-in-law"=3400,
                              "Grandchild"=4100,
                              "Great grandchild"=4120,
                              "Parent" = 4210,#
                              "Parent-in-law" = 4220,
                              "Sibling" = 4410,#
                              "Sibling of spouse/partner"=4431,
                              "Spouse/partner of sibling"=4432,
                              "Grandparent" = 4500,#
                              "Great grandparent" = 4510,#
                              "Nephew/niece"=4810,
                              "Other relative, not elsewhere classified" = 4900,#
                              "Non relative" = 5000,#
                              "Domestic employee"=5210,
                              "Relative of employee, n.s."=5220,
                              "Child of servant"=5222,
                              "Unknown"=9999,
                              "Missing " = 8888),
                     label="Relationship to household head [general version]")


df_1990<-df





#### KOREAN DATA 1995 ######

load("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/KOR_1995_CENSUS.RData")

sort(unique(df$relate))


df$relate<-as.factor(df$relate)

df<-df %>% 
  mutate(relate=fct_explicit_na(relate, na_level = "Missing"))

relate<- df%>% 
  group_by(relate) %>% 
  summarise(n=n())%>% 
  mutate(n_rel = round(n / sum(n)*100,2))



df<-df%>%
  mutate(RELATE_n=case_when(relate == 1 ~ 1,
                            relate == 2 ~ 2,
                            relate == 3 ~ 3,
                            relate == 4 ~ 3,
                            relate == 5 ~ 4,
                            relate == 6 ~ 4,
                            relate == 7 ~ 4,
                            relate == 8 ~ 4,
                            relate == 9 ~ 4,
                            relate == 10 ~ 4,
                            relate == 11 ~ 4,
                            relate == 12 ~ 4,
                            relate == 13 ~ 4,
                            relate == "Missing"~ 8),
         
         RELATED_n=case_when(relate == 1 ~ 1000,
                             relate == 2 ~ 2100,#
                             relate == 3 ~ 3100,#
                             relate == 4 ~ 3400,#
                             relate == 5 ~ 4210,#
                             relate == 6 ~ 4220,#
                             relate == 7 ~ 4100,#
                             relate == 8 ~ 4120,
                             relate == 9 ~ 4500,
                             relate == 10 ~ 4410,
                             relate == 11 ~ 4810,#
                             relate == 12 ~ 4220,#
                             relate == 13 ~ 5000,#
                             relate == "Missing"~ 8888))


df$RELATE<-labelled(x=df$RELATE_n,
                    labels=c("Head"=1, 
                             "Spouse/partner"=2,
                             "Child"=3, 
                             "Other relative"=4,
                             "Non-relative"=5,
                             "Other relative or non-relative"=6,
                             "Missing" = 8,
                             "Unknown"=9),
                    label="Relationship to household head [general version]")


df$RELATED<-labelled(x=df$RELATED_n,
                     labels=c("Head" = 1000,#
                              "Spouse" = 2100,#
                              "Biological child" = 3100,#
                              "Child/child-in-law"=3400,
                              "Grandchild"=4100,
                              "Great grandchild"=4120,
                              "Parent" = 4210,#
                              "Parent-in-law" = 4220,
                              "Sibling" = 4410,#
                              "Sibling of spouse/partner"=4431,
                              "Spouse/partner of sibling"=4432,
                              "Grandparent" = 4500,#
                              "Great grandparent" = 4510,#
                              "Nephew/niece"=4810,
                              "Other relative, not elsewhere classified" = 4900,#
                              "Non relative" = 5000,#
                              "Domestic employee"=5210,
                              "Relative of employee, n.s."=5220,
                              "Child of servant"=5222,
                              "Unknown"=9999,
                              "Missing " = 8888),
                     label="Relationship to household head [general version]")


df_1995<-df




#### KOREAN DATA 2000 ######

load("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/KOR_2000_CENSUS.RData")

sort(unique(df$relate))


df$relate<-as.factor(df$relate)

df<-df %>% 
  mutate(relate=fct_explicit_na(relate, na_level = "Missing"))

relate<- df%>% 
  group_by(relate) %>% 
  summarise(n=n())%>% 
  mutate(n_rel = round(n / sum(n)*100,2))



df<-df%>%
  mutate(RELATE_n=case_when(relate == 1 ~ 1,
                            relate == 2 ~ 2,
                            relate == 3 ~ 3,
                            relate == 4 ~ 3,
                            relate == 5 ~ 4,
                            relate == 6 ~ 4,
                            relate == 7 ~ 4,
                            relate == 8 ~ 4,
                            relate == 9 ~ 4,
                            relate == 10 ~ 4,
                            relate == 11 ~ 4,
                            relate == 12 ~ 4,
                            relate == 13 ~ 4,
                            relate == "Missing"~ 8),
         
         RELATED_n=case_when(relate == 1 ~ 1000,
                             relate == 2 ~ 2100,#
                             relate == 3 ~ 3100,#
                             relate == 4 ~ 3400,#
                             relate == 5 ~ 4210,#
                             relate == 6 ~ 4220,#
                             relate == 7 ~ 4100,#
                             relate == 8 ~ 4120,
                             relate == 9 ~ 4500,
                             relate == 10 ~ 4410,
                             relate == 11 ~ 4810,#
                             relate == 12 ~ 4220,#
                             relate == 13 ~ 5000,#
                             relate == "Missing"~ 8888))


df$RELATE<-labelled(x=df$RELATE_n,
                    labels=c("Head"=1, 
                             "Spouse/partner"=2,
                             "Child"=3, 
                             "Other relative"=4,
                             "Non-relative"=5,
                             "Other relative or non-relative"=6,
                             "Missing" = 8,
                             "Unknown"=9),
                    label="Relationship to household head [general version]")


df$RELATED<-labelled(x=df$RELATED_n,
                     labels=c("Head" = 1000,#
                              "Spouse" = 2100,#
                              "Biological child" = 3100,#
                              "Child/child-in-law"=3400,
                              "Grandchild"=4100,
                              "Great grandchild"=4120,
                              "Parent" = 4210,#
                              "Parent-in-law" = 4220,
                              "Sibling" = 4410,#
                              "Sibling of spouse/partner"=4431,
                              "Spouse/partner of sibling"=4432,
                              "Grandparent" = 4500,#
                              "Great grandparent" = 4510,#
                              "Nephew/niece"=4810,
                              "Other relative, not elsewhere classified" = 4900,#
                              "Non relative" = 5000,#
                              "Domestic employee"=5210,
                              "Relative of employee, n.s."=5220,
                              "Child of servant"=5222,
                              "Unknown"=9999,
                              "Missing " = 8888),
                     label="Relationship to household head [general version]")


df_2000<-df




#### KOREAN DATA 2005 ######

load("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/KOR_2005_CENSUS.RData")

df$year<-2005
sort(unique(df$relate))


df$relate<-as.factor(df$relate)

df<-df %>% 
  mutate(relate=fct_explicit_na(relate, na_level = "Missing"))

relate<- df%>% 
  group_by(relate) %>% 
  summarise(n=n())%>% 
  mutate(n_rel = round(n / sum(n)*100,2))



df<-df%>%
  mutate(RELATE_n=case_when(relate == 1 ~ 1,
                            relate == 2 ~ 2,
                            relate == 3 ~ 3,
                            relate == 4 ~ 3,
                            relate == 5 ~ 4,
                            relate == 6 ~ 4,
                            relate == 7 ~ 4,
                            relate == 8 ~ 4,
                            relate == 9 ~ 4,
                            relate == 10 ~ 4,
                            relate == 11 ~ 4,
                            relate == 12 ~ 4,
                            relate == 13 ~ 4,
                            relate == 14 ~ 5,#
                            relate == "Missing"~ 8),
         
         RELATED_n=case_when(relate == 1 ~ 1000,
                             relate == 2 ~ 2100,#
                             relate == 3 ~ 3100,#
                             relate == 4 ~ 3400,#
                             relate == 5 ~ 4210,#
                             relate == 6 ~ 4220,#
                             relate == 7 ~ 4500,#
                             relate == 8 ~ 4100,
                             relate == 9 ~ 4120,
                             
                             relate == 10 ~ 4410,
                             relate == 11 ~ 4810,#
                             relate == 12 ~ 4900,#
                             relate == 13 ~ 4900,#
                             relate == 14 ~ 5000,#
                             relate == "Missing"~ 8888))


df$RELATE<-labelled(x=df$RELATE_n,
                    labels=c("Head"=1, 
                             "Spouse/partner"=2,
                             "Child"=3, 
                             "Other relative"=4,
                             "Non-relative"=5,
                             "Other relative or non-relative"=6,
                             "Missing" = 8,
                             "Unknown"=9),
                    label="Relationship to household head [general version]")


df$RELATED<-labelled(x=df$RELATED_n,
                     labels=c("Head" = 1000,#
                              "Spouse" = 2100,#
                              "Biological child" = 3100,#
                              "Child/child-in-law"=3400,
                              "Grandchild"=4100,
                              "Great grandchild"=4120,
                              "Parent" = 4210,#
                              "Parent-in-law" = 4220,
                              "Sibling" = 4410,#
                              "Sibling of spouse/partner"=4431,
                              "Spouse/partner of sibling"=4432,
                              "Grandparent" = 4500,#
                              "Great grandparent" = 4510,#
                              "Nephew/niece"=4810,
                              "Other relative, not elsewhere classified" = 4900,#
                              "Non relative" = 5000,#
                              "Domestic employee"=5210,
                              "Relative of employee, n.s."=5220,
                              "Child of servant"=5222,
                              "Unknown"=9999,
                              "Missing " = 8888),
                     label="Relationship to household head [general version]")


df_2005<-df





#### KOREAN DATA 2010 ######

load("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/KOR_2010_CENSUS.RData")

sort(unique(df$relate))


df$relate<-as.factor(df$relate)

df<-df %>% 
  mutate(relate=fct_explicit_na(relate, na_level = "Missing"))

relate<- df%>% 
  group_by(relate) %>% 
  summarise(n=n())%>% 
  mutate(n_rel = round(n / sum(n)*100,2))


df<-df%>%
  mutate(RELATE_n=case_when(relate == 1 ~ 1,
                            relate == 2 ~ 2,
                            relate == 3 ~ 3,
                            relate == 4 ~ 3,
                            relate == 5 ~ 4,
                            relate == 6 ~ 4,
                            relate == 7 ~ 4,
                            relate == 8 ~ 4,
                            relate == 9 ~ 4,
                            relate == 10 ~ 4,
                            relate == 11 ~ 4,
                            relate == 12 ~ 4,
                            relate == 13 ~ 4,
                            relate == 14 ~ 5,#
                            relate == "Missing"~ 8),
         
         RELATED_n=case_when(relate == 1 ~ 1000,
                             relate == 2 ~ 2100,#
                             relate == 3 ~ 3100,#
                             relate == 4 ~ 3400,#
                             relate == 5 ~ 4210,#
                             relate == 6 ~ 4220,#
                             relate == 7 ~ 4500,#
                             relate == 8 ~ 4100,
                             relate == 9 ~ 4120,
                             
                             relate == 10 ~ 4410,
                             relate == 11 ~ 4810,#
                             relate == 12 ~ 4900,#
                             relate == 13 ~ 4900,#
                             relate == 14 ~ 5000,#
                             relate == "Missing"~ 8888))


df$RELATE<-labelled(x=df$RELATE_n,
                    labels=c("Head"=1, 
                             "Spouse/partner"=2,
                             "Child"=3, 
                             "Other relative"=4,
                             "Non-relative"=5,
                             "Other relative or non-relative"=6,
                             "Missing" = 8,
                             "Unknown"=9),
                    label="Relationship to household head [general version]")


df$RELATED<-labelled(x=df$RELATED_n,
                     labels=c("Head" = 1000,#
                              "Spouse" = 2100,#
                              "Biological child" = 3100,#
                              "Child/child-in-law"=3400,
                              "Grandchild"=4100,
                              "Great grandchild"=4120,
                              "Parent" = 4210,#
                              "Parent-in-law" = 4220,
                              "Sibling" = 4410,#
                              "Sibling of spouse/partner"=4431,
                              "Spouse/partner of sibling"=4432,
                              "Grandparent" = 4500,#
                              "Great grandparent" = 4510,#
                              "Nephew/niece"=4810,
                              "Other relative, not elsewhere classified" = 4900,#
                              "Non relative" = 5000,#
                              "Domestic employee"=5210,
                              "Relative of employee, n.s."=5220,
                              "Child of servant"=5222,
                              "Unknown"=9999,
                              "Missing " = 8888),
                     label="Relationship to household head [general version]")


df_2010<-df







#### create samples_KOREA_LIST ####
samples_KOREA_LIST<-list(df_1970, df_1975,df_1980, df_1985,df_1990, df_1995,df_2000, df_2005, df_2010)

FUN_CORE_KOR_LIST <-  function(df) {
  library(tidyverse)
  library(haven)
  library(readxl)
  ######  
  regionw <- read_excel("G:/Shared drives/CORESIDENCE/WP4_RESEARCH OUTPUT/4_1_Articles/(1) Household size and composition a global update/DATABASE/regionw.xlsx")
  df<-as_tibble(df)
  df$COUNTRY<-"KR"
  
  df<-df%>%
    mutate(AGE=age)
  
  df<-df%>%
    mutate(YEAR=year)
  df<-df%>%drop_na(AGE)
  
  df$AGE2<-with(df,  ifelse(AGE==999, "999",
                            ifelse(AGE<=4, "0-4",
                                   ifelse(AGE<=9, "5-9", 
                                          ifelse(AGE<=14, "10-14",
                                                 ifelse(AGE<=19, "15-19",
                                                        ifelse(AGE<=24, "20-24",
                                                               ifelse(AGE<=29, "25-29",
                                                                      ifelse(AGE<=34, "30-34",
                                                                             ifelse(AGE<=39, "35-39",
                                                                                    ifelse(AGE<=44, "40-44",
                                                                                           ifelse(AGE<=49, "45-49",
                                                                                                  ifelse(AGE<=54, "50-54",
                                                                                                         ifelse(AGE<=59, "55-59",
                                                                                                                ifelse(AGE<=64, "60-64",
                                                                                                                       ifelse(AGE<=69, "65-69",
                                                                                                                              ifelse(AGE<=74, "70-74",
                                                                                                                                     ifelse(AGE<=79, "75-79",
                                                                                                                                            ifelse(AGE<=84, "80-84",
                                                                                                                                                   ifelse(AGE<=89, "85-89",
                                                                                                                                                          ifelse(AGE<=94, "90-94","95+")))))))))))))))))))))
  df$CENSUS_ROUND<-with(df,ifelse((YEAR>=1956 & YEAR <=1965), 1960,
                                  ifelse((YEAR>=1966 & YEAR <=1975), 1970,
                                         ifelse((YEAR>=1976 & YEAR <=1985), 1980,
                                                ifelse((YEAR>=1986 & YEAR <=1995), 1990,
                                                       ifelse((YEAR>=1996 & YEAR <=2005), 2000,
                                                              ifelse((YEAR>=2006 & YEAR <=2015), 2010,
                                                                     ifelse((YEAR>=2016 & YEAR <=2025), 2020,0))))))))
  
  df$DECADE<-with(df,ifelse((YEAR>=1951 & YEAR <=1960), 1950,
                            ifelse((YEAR>=1961 & YEAR <=1970), 1960,
                                   ifelse((YEAR>=1971 & YEAR <=1980), 1970,
                                          ifelse((YEAR>=1981 & YEAR <=1990), 1980,
                                                 ifelse((YEAR>=1991 & YEAR <=2000), 1990,
                                                        ifelse((YEAR>=2001 & YEAR <=2010), 2000,
                                                               ifelse((YEAR>=2011 & YEAR <=2020), 2010,
                                                                      ifelse((YEAR>=2021 & YEAR <=2030), 2020,0)))))))))
  
  df$FIVE_YEAR<-with(df,ifelse((YEAR>=1951 & YEAR <=1955), 1951,
                               ifelse((YEAR>=1956 & YEAR <=1960), 1956,
                                      ifelse((YEAR>=1961 & YEAR <=1965), 1961,
                                             ifelse((YEAR>=1966 & YEAR <=1970), 1966,
                                                    ifelse((YEAR>=1971 & YEAR <=1975), 1971,
                                                           ifelse((YEAR>=1976 & YEAR <=1980), 1976,
                                                                  ifelse((YEAR>=1981 & YEAR <=1985), 1981,
                                                                         ifelse((YEAR>=1986 & YEAR <=1990), 1986,
                                                                                ifelse((YEAR>=1991 & YEAR <=1995), 1991,
                                                                                       ifelse((YEAR>=1996 & YEAR <=2000), 1996,
                                                                                              ifelse((YEAR>=2001 & YEAR <=2005), 2001,
                                                                                                     ifelse((YEAR>=2006 & YEAR <=2010), 2006,
                                                                                                            ifelse((YEAR>=2011 & YEAR <=2015), 2011,
                                                                                                                   ifelse((YEAR>=2016 & YEAR <=2020), 2016,
                                                                                                                          ifelse((YEAR>=2021 & YEAR <=2025), 2021,0))))))))))))))))
  
  
  
  regionw<-as.data.frame(regionw)
  df<-as.data.frame(df)
  df<- data.frame(df,
                  regionw[match(df[,"COUNTRY"],
                                regionw[,"country"]),c("ISO3","REGIONW")])
  #colnames(aver)[grep(names(aver%>% select(last_col())), colnames(aver))]<-"REGIONW"
  
  
  df<-df%>%
    mutate(CONTINENT=case_when(REGIONW == 11 ~ "Eastern Africa",
                               REGIONW == 12 ~ "Middle Africa",
                               REGIONW == 13 ~ "Northern Africa",
                               REGIONW == 14 ~ "Southern Africa",
                               REGIONW == 15 ~ "Western Africa",
                               REGIONW == 21 ~ "Caribbean" ,
                               REGIONW == 22 ~ "Central America" ,
                               REGIONW == 23 ~ "South America" ,
                               REGIONW == 24 ~ "North America",
                               REGIONW == 31 ~ "Central Asia",
                               REGIONW == 32 ~ "Eastern Asia",
                               REGIONW == 33 ~ "Southern Asia" ,
                               REGIONW == 34 ~ "South-Eastern Asia",
                               REGIONW == 35 ~ "Western Asia",
                               REGIONW == 41 ~ "Eastern Europe" ,
                               REGIONW == 42 ~ "Northern Europe" ,
                               REGIONW == 43 ~ "Southern Europe",
                               REGIONW == 44 ~ "Western Europe",
                               REGIONW == 51 ~ "Australia and New Zealand" ,
                               REGIONW == 52 ~ "Melanesia",
                               REGIONW == 53 ~ "Micronesia",
                               REGIONW == 54 ~ "Polynesia"))
  
  df<-df%>%
    mutate(CONT2=case_when(CONTINENT == "Eastern Africa" ~ "AFRICA",
                           CONTINENT == "Middle Africa" ~ "AFRICA",
                           CONTINENT == "Northern Africa" ~ "AFRICA",
                           CONTINENT == "Southern Africa" ~ "AFRICA",
                           CONTINENT == "Western Africa" ~ "AFRICA",
                           CONTINENT == "Caribbean" ~ "LATIN-AMERICA",
                           CONTINENT == "Central America" ~ "LATIN-AMERICA",
                           CONTINENT == "South America" ~ "LATIN-AMERICA",
                           CONTINENT == "North America" ~ "NORTH-AMERICA",
                           CONTINENT == "Central Asia" ~ "ASIA",
                           CONTINENT == "Eastern Asia" ~ "ASIA",
                           CONTINENT == "Southern Asia" ~ "ASIA",
                           CONTINENT == "South-Eastern Asia" ~ "ASIA",
                           CONTINENT == "Western Asia" ~ "ASIA",
                           CONTINENT == "Eastern Europe" ~ "EUROPE",
                           CONTINENT == "Northern Europe" ~ "EUROPE",
                           CONTINENT == "Southern Europe" ~ "EUROPE",
                           CONTINENT == "Western Europe" ~ "EUROPE",
                           CONTINENT == "Australia and New Zealand" ~ "OCEANIA",
                           CONTINENT == "Melanesia" ~ "OCEANIA",
                           CONTINENT == "Micronesia" ~ "OCEANIA",
                           CONTINENT == "Polynesia" ~ "OCEANIA"))
}

system.time(
  CORE_KOR_LIST<-parLapply(cl, samples_KOREA_LIST, FUN_CORE_KOR_LIST)
)

FUN_PASO1_KOR_LIST <-  function(df) {
  library(tidyverse)
  library(haven)  
  df$SOURCE<-"KCENSUS"
  df$SAMPLE<-with(df,paste(ISO3, YEAR, SOURCE, sep="_"))
  df$PWEIGHT_A<-100
  df<-df %>%
    add_count(hhnum)%>%
    mutate(#hhid=paste(HHNUM,REFWEEK, sep="-"),
      child5=ifelse(AGE<=4,1,0),
      adult18=ifelse(AGE>=18,1,0),
      adult18M=ifelse((AGE>=18&sex==1),1,0),
      adult18F=ifelse((AGE>=18&sex==2),1,0),
      child18=ifelse(AGE<18,1,0),
      elderly65=ifelse(AGE>=65,1,0),
      
      age00_09=ifelse((AGE2=="0-4"|AGE2=="5-9"),1,0),
      age10_19=ifelse((AGE2=="10-14"|AGE2=="15-19"),1,0),
      age20_29=ifelse((AGE2=="20-24"|AGE2=="25-29"),1,0),
      age30_39=ifelse((AGE2=="30-34"|AGE2=="35-39"),1,0),
      age40_49=ifelse((AGE2=="40-44"|AGE2=="45-49"),1,0),
      age50_59=ifelse((AGE2=="50-54"|AGE2=="55-59"),1,0),
      age60_69=ifelse((AGE2=="60-64"|AGE2=="65-69"),1,0),
      age70_79=ifelse((AGE2=="70-74"|AGE2=="75-79"),1,0),
      age80=ifelse(AGE>=80,1,0),
      
      heads=ifelse(RELATE==1,1,0), 
      spouses=ifelse(RELATE==2,1,0),
      childs=ifelse(RELATE==3,1,0),
      other_relatives=ifelse(RELATE==4,1,0),
      non_relatives=ifelse(RELATE==5,1,0),
      other_rel_or_non_rel=ifelse(RELATE==6,1,0),
      
      grandchilds=ifelse(RELATED %in% c(4100, 4110,4120,4130),1,0),
      parents=ifelse(RELATED %in% c(4200,4210,4211,4220 ),1,0),
      siblings=ifelse(RELATED %in% c(4400,4410,4420,4430,4431,4432),1,0),
      
      WEIGHT_POP= sum(PWEIGHT_A,na.rm = TRUE)*1000,
      #WEIGHT_A= sum(df[df$RELATE==1,"PWEIGHT_A"]),
      WEIGHT_A= sum(PWEIGHT_A[RELATE==1],na.rm = TRUE),
      WEIGHT_A2= sum(PWEIGHT_A[RELATE==1&n==2]),
      WEIGHT_A3= sum(PWEIGHT_A[RELATE==1&n==3]),
      WEIGHT_A4= sum(PWEIGHT_A[RELATE==1&n==4]),
      WEIGHT_A5= sum(PWEIGHT_A[RELATE==1&n==5]),
      WEIGHT_AM= sum(PWEIGHT_A[RELATE==1&sex==1]),
      WEIGHT_AF= sum(PWEIGHT_A[RELATE==1&sex==2]),
      WEIGHT_2029=sum(PWEIGHT_A[RELATE==1&age20_29==1]),
      WEIGHT_3039=sum(PWEIGHT_A[RELATE==1&age30_39==1]),
      WEIGHT_4049=sum(PWEIGHT_A[RELATE==1&age40_49==1]),
      WEIGHT_5059=sum(PWEIGHT_A[RELATE==1&age50_59==1]),
      WEIGHT_6069=sum(PWEIGHT_A[RELATE==1&age60_69==1]),
      headed2029=ifelse((RELATE==1 &age20_29==1),1,0), 
      headed3039=ifelse((RELATE==1 &age30_39==1),1,0),
      headed4049=ifelse((RELATE==1 &age40_49==1),1,0),
      headed5059=ifelse((RELATE==1 &age50_59==1),1,0),
      headed6069=ifelse((RELATE==1 &age60_69==1),1,0),
      
      M_headed=ifelse((RELATE==1 & sex==1),1,0),
      F_headed=ifelse((RELATE==1 & sex==2),1,0))|>
    drop_na(PWEIGHT_A)
  
  
}

system.time(
  PASO1_KOR_LIST<-parLapply(cl, CORE_KOR_LIST, FUN_PASO1_KOR_LIST)
)

FUN_PASO2_KOR_LIST <-  function(df) {
  library(tidyverse)
  library(haven) 
  df<-df|>
    group_by(hhnum)|>
    mutate(hh_per1=n(),
           hh_parents=sum(parents*PWEIGHT_A),
           hh_grandchilds=sum(grandchilds*PWEIGHT_A),
           hh_heads=sum(heads*PWEIGHT_A),
           hh_spouses=sum(spouses*PWEIGHT_A),
           hh_childs=sum(childs*PWEIGHT_A),
           hh_other_relatives=sum(other_relatives*PWEIGHT_A),
           hh_non_relatives=sum(non_relatives*PWEIGHT_A),
           hh_other_rel_or_non_rel=sum(other_rel_or_non_rel*PWEIGHT_A))|>
    mutate(family_type= #ifelse(hh_per1==1, 10, # unipersonal households 
             ifelse(hh_per1==1&AGE<50, 11, # unipersonal households 
                    ifelse(hh_per1==1&AGE>=50, 12, # unipersonal households 
                           ifelse(hh_spouses>0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20, #nuclear 
                                  ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives ==0 & hh_non_relatives==0,20,#nuclear 
                                         ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20,#nuclear 
                                                
                                                
                                                ifelse(hh_spouses>0 & hh_childs>0 &  hh_other_relatives >0 & hh_non_relatives==0,31,# nuclear + other relatives
                                                       ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives >0 & hh_non_relatives==0,31,
                                                              ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives >0 & hh_non_relatives==0,31,
                                                                     
                                                                     ifelse(hh_spouses>0 & hh_childs>0 &  hh_other_relatives ==0 & hh_non_relatives>0,32,
                                                                            ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives ==0 & hh_non_relatives>0,32,
                                                                                   ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives>0,32,       
                                                                                          
                                                                                          ifelse(hh_spouses>0 & hh_childs>0 &  hh_other_relatives >0 & hh_non_relatives>0,33,
                                                                                                 ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives >0 & hh_non_relatives>0,33,
                                                                                                        ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives >0 & hh_non_relatives>0,33,        
                                                                                                               
                                                                                                               ifelse(hh_spouses==0 & hh_childs==0 &  hh_other_relatives >0 & hh_non_relatives==0,34,
                                                                                                                      ifelse(hh_spouses==0 & hh_childs==0 &  hh_other_relatives ==0 & hh_non_relatives>0,35,
                                                                                                                             ifelse(hh_spouses==0 & hh_childs==0 &  hh_other_relatives >0 & hh_non_relatives>0,36,
                                                                                                                                    0))))))))))))))))))|>
    mutate(family_type2=ifelse(hh_per1==1, 10,
                               ifelse(hh_spouses>0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20,
                                      ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives ==0 & hh_non_relatives==0,20,
                                             ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20,       
                                                    ifelse(hh_non_relatives>0,30, # "Other non family",
                                                           ifelse((hh_parents>0 | hh_grandchilds>0),40,# "Stem family",
                                                                  ifelse(hh_other_relatives>0,50, 9999))))))))|>
    
    mutate(family_type3=ifelse(any(F_headed==1)&(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0),21,9999))|>#monomarental )
    ungroup()
  
}

system.time(
  PASO2_KOR_LIST<-parLapply(cl, PASO1_KOR_LIST, FUN_PASO2_KOR_LIST)
)

rm(PASO1_KOR_LIST)
gc()

FUN_PASO3_KOR_LIST <-  function(df) {
  library(tidyverse)
  library(haven) 
  df<-df |>
    mutate(#WEIGHT_FT10= sum(PWEIGHT[family_type==10]),
      WEIGHT_FT11= sum(PWEIGHT_A[family_type==11]),
      WEIGHT_FT12= sum(PWEIGHT_A[family_type==12]),
      WEIGHT_FT20= sum(PWEIGHT_A[RELATE==1&family_type==20]),
      WEIGHT_FT31= sum(PWEIGHT_A[RELATE==1&family_type==31]),
      WEIGHT_FT32= sum(PWEIGHT_A[RELATE==1&family_type==32]),
      WEIGHT_FT33= sum(PWEIGHT_A[RELATE==1&family_type==33]),
      WEIGHT_FT34= sum(PWEIGHT_A[RELATE==1&family_type==34]),
      WEIGHT_FT35= sum(PWEIGHT_A[RELATE==1&family_type==35]),
      WEIGHT_FT36= sum(PWEIGHT_A[RELATE==1&family_type==36]),
      WEIGHT_FT00= sum(PWEIGHT_A[RELATE==1&family_type==0]),
      
      WEIGHT_FT210= sum(PWEIGHT_A[family_type2==10]),
      WEIGHT_FT220= sum(PWEIGHT_A[RELATE==1&family_type2==20]),
      WEIGHT_FT230= sum(PWEIGHT_A[RELATE==1&family_type2==30]),
      WEIGHT_FT240= sum(PWEIGHT_A[RELATE==1&family_type2==40]),
      WEIGHT_FT250= sum(PWEIGHT_A[RELATE==1&family_type2==50]),
      WEIGHT_FT299= sum(PWEIGHT_A[RELATE==1&family_type2==9999]),
      
      WEIGHT_FT321= sum(PWEIGHT_A[RELATE==1&family_type3==21])
    )  
  
} 

system.time(
  PASO3_KOR_LIST<-parLapply(cl, PASO2_KOR_LIST, FUN_PASO3_KOR_LIST)
)

rm(PASO2_KOR_LIST)
gc()

FUN_PASO4_KOR_LIST <-  function(df) {
  library(tidyverse)
  library(haven)
  df<-df |> 
    group_by(SAMPLE,ISO3,YEAR,hhnum,CONTINENT,SOURCE,
             CENSUS_ROUND,DECADE,FIVE_YEAR,CONT2,
             WEIGHT_POP,WEIGHT_A,WEIGHT_A2,WEIGHT_A3,WEIGHT_A4,
             WEIGHT_A5, WEIGHT_AM,WEIGHT_AF,WEIGHT_2029,WEIGHT_3039,WEIGHT_4049,
             WEIGHT_5059,WEIGHT_6069,
             WEIGHT_FT11, WEIGHT_FT12,
             WEIGHT_FT20,
             WEIGHT_FT31,WEIGHT_FT32,WEIGHT_FT33,WEIGHT_FT34,WEIGHT_FT35,
             WEIGHT_FT36,WEIGHT_FT00,WEIGHT_FT210,WEIGHT_FT220,WEIGHT_FT230,
             WEIGHT_FT240,WEIGHT_FT250,WEIGHT_FT299,
             WEIGHT_FT321,
             family_type,
             family_type2,
             family_type3)|>
    summarise(hh=1,
              hh_per1=n(),
              hh_m=sum(M_headed),
              hh_f=sum(F_headed),
              hh_per=sum(hh*PWEIGHT_A),
              hh_child5=sum(child5*PWEIGHT_A),
              hh_adult18=sum(adult18*PWEIGHT_A),
              hh_adult18b=sum(adult18),
              
              hh_00_09=sum(age00_09*PWEIGHT_A),
              hh_10_19=sum(age10_19*PWEIGHT_A),
              hh_20_29=sum(age20_29*PWEIGHT_A),
              hh_30_39=sum(age30_39*PWEIGHT_A),
              hh_40_49=sum(age40_49*PWEIGHT_A),
              hh_50_59=sum(age50_59*PWEIGHT_A),
              hh_60_69=sum(age60_69*PWEIGHT_A),
              hh_70_79=sum(age70_79*PWEIGHT_A),
              hh_80=sum(age80*PWEIGHT_A),
              
              hh_adult18M=sum(adult18M*PWEIGHT_A),
              hh_adult18F=sum(adult18F*PWEIGHT_A),
              hh_adult18Mb=sum(adult18M),
              
              hh_child18=sum(child18*PWEIGHT_A),
              hh_elderly65=sum(elderly65*PWEIGHT_A),
              
              hh_heads=sum(heads*PWEIGHT_A),
              hh_spouses=sum(spouses*PWEIGHT_A),
              hh_childs=sum(childs*PWEIGHT_A),
              hh_other_relatives=sum(other_relatives*PWEIGHT_A),
              hh_non_relatives=sum(non_relatives*PWEIGHT_A),
              hh_other_rel_or_non_rel=sum(other_rel_or_non_rel*PWEIGHT_A),
              
              hh_grandchilds=sum(grandchilds*PWEIGHT_A),
              hh_parents=sum(parents*PWEIGHT_A),
              hh_siblings=sum(siblings*PWEIGHT_A), 
              hh_M_headed=sum(M_headed*PWEIGHT_A),
              hh_F_headed=sum(F_headed*PWEIGHT_A),
              hh_headed2029=sum(headed2029*PWEIGHT_A),
              hh_headed3039=sum(headed3039*PWEIGHT_A),
              hh_headed4049=sum(headed4049*PWEIGHT_A),
              hh_headed5059=sum(headed5059*PWEIGHT_A),
              hh_headed6069=sum(headed6069*PWEIGHT_A)
    )|>
    ungroup()
} 

system.time(
  PASO4_KOR_LIST<-parLapply(cl, PASO3_KOR_LIST, FUN_PASO4_KOR_LIST)
)

rm(PASO3_KOR_LIST)
gc()


FUN_PASO5_KOR_LIST <-  function(df) {
  library(tidyverse)
  library(haven)
  df<-df |>
    group_by(ISO3,YEAR,SOURCE,SAMPLE,CONTINENT,CONT2,CENSUS_ROUND,DECADE,FIVE_YEAR)|>
    summarise(WPOP=round(unique(WEIGHT_POP),0),
              
              HS01=sum(ifelse(hh_per1==1,hh,0))/sum(hh),
              HS02=sum(ifelse(hh_per1==2,hh,0))/sum(hh),
              HS03=sum(ifelse(hh_per1==3,hh,0))/sum(hh),
              HS04=sum(ifelse(hh_per1==4,hh,0))/sum(hh),
              HS05=sum(ifelse(hh_per1==5,hh,0))/sum(hh),
              HS06=sum(ifelse(hh_per1==6,hh,0))/sum(hh),
              HS07=sum(ifelse(hh_per1==7,hh,0))/sum(hh),
              HS08=sum(ifelse(hh_per1==8,hh,0))/sum(hh),
              HS09=sum(ifelse(hh_per1==9,hh,0))/sum(hh),
              HS10=sum(ifelse(hh_per1==10,hh,0))/sum(hh),
              HS11=sum(ifelse(hh_per1>10,hh,0))/sum(hh),
              HS12=sum(ifelse((hh_per1==2|hh_per1==3),hh,0))/sum(hh),
              HS13=sum(ifelse((hh_per1==4|hh_per1==5),hh,0))/sum(hh),
              HS14=sum(ifelse(hh_per1>=6,hh,0))/sum(hh),
              HS15=sum(hh_child5 != 0)/sum(hh),
              HS16=sum(hh_elderly65 != 0)/sum(hh),
              HS17=sum(hh_per)/unique(WEIGHT_A),
              HS18=sum(hh_child5)/unique(WEIGHT_A),
              HS19=sum(hh_adult18)/unique(WEIGHT_A),
              HS20=sum(hh_child18)/unique(WEIGHT_A),
              HS21=sum(hh_elderly65)/unique(WEIGHT_A),
              HS22=sum(hh_00_09)/unique(WEIGHT_A),
              HS23=sum(hh_10_19)/unique(WEIGHT_A),
              HS24=sum(hh_20_29)/unique(WEIGHT_A),
              HS25=sum(hh_30_39)/unique(WEIGHT_A),
              HS26=sum(hh_40_49)/unique(WEIGHT_A),
              HS27=sum(hh_50_59)/unique(WEIGHT_A),
              HS28=sum(hh_60_69)/unique(WEIGHT_A),
              HS29=sum(hh_70_79)/unique(WEIGHT_A),
              HS30=sum(hh_80)/unique(WEIGHT_A),
              
              HR01=sum(hh_heads)/unique(WEIGHT_A),
              HR02=sum(hh_spouses)/unique(WEIGHT_A),
              HR03=sum(hh_childs)/unique(WEIGHT_A),
              HR04=sum(hh_other_relatives)/unique(WEIGHT_A),
              HR05=sum(hh_non_relatives)/unique(WEIGHT_A),
              HR06=sum(hh_other_rel_or_non_rel)/unique(WEIGHT_A),
              
              HR07=sum(hh_heads[hh_per1==2])/unique(WEIGHT_A2),
              HR08=sum(hh_spouses[hh_per1==2])/unique(WEIGHT_A2),
              HR09=sum(hh_childs[hh_per1==2])/unique(WEIGHT_A2),
              HR10=sum(hh_other_relatives[hh_per1==2])/unique(WEIGHT_A2),
              HR11=sum(hh_non_relatives[hh_per1==2])/unique(WEIGHT_A2),
              HR12=sum(hh_other_rel_or_non_rel[hh_per1==2])/unique(WEIGHT_A2),
              
              HR13=sum(hh_heads[hh_per1==3])/unique(WEIGHT_A3),
              HR14=sum(hh_spouses[hh_per1==3])/unique(WEIGHT_A3),
              HR15=sum(hh_childs[hh_per1==3])/unique(WEIGHT_A3),
              HR16=sum(hh_other_relatives[hh_per1==3])/unique(WEIGHT_A3),
              HR17=sum(hh_non_relatives[hh_per1==3])/unique(WEIGHT_A3),
              HR18=sum(hh_other_rel_or_non_rel[hh_per1==3])/unique(WEIGHT_A3),
              
              HR19=sum(hh_heads[hh_per1==4])/unique(WEIGHT_A4),
              HR20=sum(hh_spouses[hh_per1==4])/unique(WEIGHT_A4),
              HR21=sum(hh_childs[hh_per1==4])/unique(WEIGHT_A4),
              HR22=sum(hh_other_relatives[hh_per1==4])/unique(WEIGHT_A4),
              HR23=sum(hh_non_relatives[hh_per1==4])/unique(WEIGHT_A4),
              HR24=sum(hh_other_rel_or_non_rel[hh_per1==4])/unique(WEIGHT_A4),
              
              HR25=sum(hh_heads[hh_per1==5])/unique(WEIGHT_A5),
              HR26=sum(hh_spouses[hh_per1==5])/unique(WEIGHT_A5),
              HR27=sum(hh_childs[hh_per1==5])/unique(WEIGHT_A5),
              HR28=sum(hh_other_relatives[hh_per1==5])/unique(WEIGHT_A5),
              HR29=sum(hh_non_relatives[hh_per1==5])/unique(WEIGHT_A5),
              HR30=sum(hh_other_rel_or_non_rel[hh_per1==5])/unique(WEIGHT_A5),
              
              HT01=sum(ifelse(family_type==11|family_type==12,1,0)/sum(hh)),
              HT01b=sum(ifelse(family_type==11,1,0)/sum(hh)),
              HT01c=sum(ifelse(family_type==12,1,0)/sum(hh)),
              HT02=sum(ifelse(family_type==20,1,0)/sum(hh)),
              HT03=sum(ifelse(family_type==31,1,0)/sum(hh)),
              HT04=sum(ifelse(family_type==32,1,0)/sum(hh)),
              HT05=sum(ifelse(family_type==33,1,0)/sum(hh)),
              HT06=sum(ifelse(family_type==34,1,0)/sum(hh)),
              HT07=sum(ifelse(family_type==35,1,0)/sum(hh)),
              HT08=sum(ifelse(family_type==36,1,0)/sum(hh)),
              HT09=sum(ifelse(family_type==0,1,0)/sum(hh)),
              
              HT10=sum(hh_per[family_type==11|family_type==12])/(unique(WEIGHT_FT11)+unique(WEIGHT_FT12)),
              HT11=sum(hh_per[family_type==20])/unique(WEIGHT_FT20),
              HT12=sum(hh_per[family_type==31])/unique(WEIGHT_FT31),
              HT13=sum(hh_per[family_type==32])/unique(WEIGHT_FT32),
              HT14=sum(hh_per[family_type==33])/unique(WEIGHT_FT33),
              HT15=sum(hh_per[family_type==34])/unique(WEIGHT_FT34),
              HT16=sum(hh_per[family_type==35])/unique(WEIGHT_FT35),
              HT17=sum(hh_per[family_type==36])/unique(WEIGHT_FT36),
              HT18=sum(hh_per[family_type==0])/unique(WEIGHT_FT00),
              
              HT20=sum(ifelse(family_type2==10,1,0)/sum(hh)),
              HT21=sum(ifelse(family_type2==20,1,0)/sum(hh)),
              HT22=sum(ifelse(family_type2==40,1,0)/sum(hh)),
              HT23=sum(ifelse(family_type2==50,1,0)/sum(hh)),
              HT24=sum(ifelse(family_type2==30,1,0)/sum(hh)),
              HT25=sum(ifelse(family_type2==9999,1,0)/sum(hh)),
              HT26=sum(hh_per[family_type2==10])/unique(WEIGHT_FT210),
              HT27=sum(hh_per[family_type2==20])/unique(WEIGHT_FT220),
              HT28=sum(hh_per[family_type2==40])/unique(WEIGHT_FT240),
              HT29=sum(hh_per[family_type2==50])/unique(WEIGHT_FT250),
              HT30=sum(hh_per[family_type2==30])/unique(WEIGHT_FT230),
              HT31=sum(hh_per[family_type2==9999])/unique(WEIGHT_FT299),
              
              HH01=sum(hh_M_headed[hh_M_headed!=0])/unique(WEIGHT_A),
              HH02=sum(hh_F_headed[hh_F_headed!=0])/unique(WEIGHT_A),
              
              HH03=sum(ifelse((hh_m==1 &hh_per1==1),hh,0))/sum(hh_m),
              HH04=sum(ifelse((hh_m==1 &hh_per1==2),hh,0))/sum(hh_m),
              HH05=sum(ifelse((hh_m==1 &hh_per1==3),hh,0))/sum(hh_m),
              HH06=sum(ifelse((hh_m==1 &hh_per1==4),hh,0))/sum(hh_m),
              HH07=sum(ifelse((hh_m==1 &hh_per1==5),hh,0))/sum(hh_m),
              HH08=sum(ifelse((hh_m==1 &hh_per1==6),hh,0))/sum(hh_m),
              HH09=sum(ifelse((hh_m==1 &hh_per1==7),hh,0))/sum(hh_m),
              HH10=sum(ifelse((hh_m==1 &hh_per1==8),hh,0))/sum(hh_m),
              HH11=sum(ifelse((hh_m==1 &hh_per1==9),hh,0))/sum(hh_m),
              HH12=sum(ifelse((hh_m==1 &hh_per1==10),hh,0))/sum(hh_m),
              HH13=sum(ifelse((hh_m==1 &hh_per1>10),hh,0))/sum(hh_m),
              
              HH14=sum(ifelse((hh_f==1 &hh_per1==1),hh,0))/sum(hh_f),
              HH15=sum(ifelse((hh_f==1 &hh_per1==2),hh,0))/sum(hh_f),
              HH16=sum(ifelse((hh_f==1 &hh_per1==3),hh,0))/sum(hh_f),
              HH17=sum(ifelse((hh_f==1 &hh_per1==4),hh,0))/sum(hh_f),
              HH18=sum(ifelse((hh_f==1 &hh_per1==5),hh,0))/sum(hh_f),
              HH19=sum(ifelse((hh_f==1 &hh_per1==6),hh,0))/sum(hh_f),
              HH20=sum(ifelse((hh_f==1 &hh_per1==7),hh,0))/sum(hh_f),
              HH21=sum(ifelse((hh_f==1 &hh_per1==8),hh,0))/sum(hh_f),
              HH22=sum(ifelse((hh_f==1 &hh_per1==9),hh,0))/sum(hh_f),
              HH23=sum(ifelse((hh_f==1 &hh_per1==10),hh,0))/sum(hh_f),
              HH24=sum(ifelse((hh_f==1 &hh_per1>10),hh,0))/sum(hh_f),
              
              HH25=sum(ifelse((hh_m==1 &family_type2==10),1,0)/sum(hh_m)),
              HH26=sum(ifelse((hh_m==1 &family_type2==20),1,0)/sum(hh_m)),
              HH27=sum(ifelse((hh_m==1 &family_type2==40),1,0)/sum(hh_m)),
              HH28=sum(ifelse((hh_m==1 &family_type2==50),1,0)/sum(hh_m)),
              HH29=sum(ifelse((hh_m==1 &family_type2==30),1,0)/sum(hh_m)),
              HH30=sum(ifelse((hh_m==1 &family_type2==9999),1,0)/sum(hh_m)),
              
              HH31=sum(ifelse((hh_f==1 &family_type2==10),1,0)/sum(hh_f)),
              HH32=sum(ifelse((hh_f==1 &family_type2==20),1,0)/sum(hh_f)),
              HH33=sum(ifelse((hh_f==1 &family_type2==40),1,0)/sum(hh_f)),
              HH34=sum(ifelse((hh_f==1 &family_type2==50),1,0)/sum(hh_f)),
              HH35=sum(ifelse((hh_f==1 &family_type2==30),1,0)/sum(hh_f)),
              HH36=sum(ifelse((hh_f==1 &family_type2==9999),1,0)/sum(hh_f)),
              
              HH37=sum(hh_per[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH38=sum(hh_per[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH39=sum(hh_child18[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH40=sum(hh_child18[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH41=sum(hh_adult18[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH42=sum(hh_adult18[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH43=sum(hh_elderly65[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH44=sum(hh_elderly65[hh_F_headed!=0])/unique(WEIGHT_AF),
              
              HH45=sum(hh_spouses[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH46=sum(hh_spouses[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH47=sum(hh_childs[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH48=sum(hh_childs[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH49=sum(hh_other_relatives[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH50=sum(hh_other_relatives[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH51=sum(hh_non_relatives[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH52=sum(hh_non_relatives[hh_F_headed!=0])/unique(WEIGHT_AF),
              
              HH53=sum(hh_adult18M[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH54=sum(hh_adult18M[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH55=sum(hh_adult18F[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH56=sum(hh_adult18F[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH57=sum(hh[hh_adult18Mb==0]),
              HH58=sum(hh[hh_adult18Mb==1]),
              HH59=sum(hh[hh_adult18Mb==2]),
              HH60=sum(hh[hh_adult18Mb==3]),
              HH61=sum(hh[hh_adult18Mb==4]),
              HH62=sum(hh[hh_adult18Mb==5]),
              HH63=sum(hh[hh_adult18Mb>=6]),
              
              HH64=sum(hh_m[hh_adult18Mb==0]),
              HH65=sum(hh_m[hh_adult18Mb==1]),
              HH66=sum(hh_m[hh_adult18Mb==2]),
              HH67=sum(hh_m[hh_adult18Mb==3]),
              HH68=sum(hh_m[hh_adult18Mb==4]),
              HH69=sum(hh_m[hh_adult18Mb==5]),
              HH70=sum(hh_m[hh_adult18Mb>=6]),
              
              HH71=sum(hh_f[hh_adult18Mb==0]),
              HH72=sum(hh_f[hh_adult18Mb==1]),
              HH73=sum(hh_f[hh_adult18Mb==2]),
              HH74=sum(hh_f[hh_adult18Mb==3]),
              HH75=sum(hh_f[hh_adult18Mb==4]),
              HH76=sum(hh_f[hh_adult18Mb==5]),
              HH77=sum(hh_f[hh_adult18Mb>=6]),
              HTMM=sum(ifelse(family_type3==21,1,0)/sum(hh))
    )
  
  
}

system.time(
  PASO5_KOR_LIST<-parLapply(cl, PASO4_KOR_LIST, FUN_PASO5_KOR_LIST)
)

agrr_database_korea <- data.table::rbindlist(PASO5_KOR_LIST)
regionw <- read_excel("G:/Shared drives/CORESIDENCE/WP4_RESEARCH OUTPUT/4_1_Articles/(1) Household size and composition a global update/DATABASE/regionw.xlsx")
regionw<-as.data.frame(regionw)
agrr_database_korea<-as.data.frame(agrr_database_korea)
agrr_database_korea<- data.frame(agrr_database_korea,
                                 regionw[match(agrr_database_korea[,"ISO3"],
                                               regionw[,"ISO3"]),c("EU Member States")])

colnames(agrr_database_korea)[grep(names(agrr_database_korea %>% select(last_col())), colnames(agrr_database_korea))]<-"CNTRY"
save(agrr_database_korea, file="G:/Shared drives/CORESIDENCE/WP4_RESEARCH OUTPUT/4_1_Articles/(9) Gender asymmetries in household headship/DATABASE/AGGR_INDICATORS_KOREA_RITA.RData")

# AUSTRALIA #####
# READ AUSTRALIAN DATA #####

df01 <- read_sav("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/HILDA/Eperson a210c.sav")
df02 <- read_sav("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/HILDA/Eperson b210c.sav")
df03 <- read_sav("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/HILDA/Eperson c210c.sav")
df04 <- read_sav("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/HILDA/Eperson d210c.sav")
df05 <- read_sav("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/HILDA/Eperson e210c.sav")
df06 <- read_sav("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/HILDA/Eperson f210c.sav")
df07 <- read_sav("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/HILDA/Eperson g210c.sav")
df08 <- read_sav("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/HILDA/Eperson h210c.sav")
df09 <- read_sav("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/HILDA/Eperson i210c.sav")
df10 <- read_sav("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/HILDA/Eperson j210c.sav")
df11 <- read_sav("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/HILDA/Eperson k210c.sav")
df12 <- read_sav("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/HILDA/Eperson l210c.sav")
df13 <- read_sav("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/HILDA/Eperson m210c.sav")
df14 <- read_sav("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/HILDA/Eperson n210c.sav")
df15 <- read_sav("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/HILDA/Eperson o210c.sav")
df16 <- read_sav("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/HILDA/Eperson p210c.sav")
df17 <- read_sav("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/HILDA/Eperson q210c.sav")
df18 <- read_sav("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/HILDA/Eperson r210c.sav")
df19 <- read_sav("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/HILDA/Eperson s210c.sav")
df20 <- read_sav("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/HILDA/Eperson t210c.sav")
df21 <- read_sav("G:/Shared drives/CORESIDENCE/WP2_DATA/2_1_Input Data/OTHERS/HILDA/Eperson u210c.sav")


df01$atifeftp

df01<-df01%>%select(ahhrhid,ahhrpid,ahhpno,ahhstate,ahgsex,ahgage,ahhrih,atifeftp, paste("arg",sprintf("%.2d",seq=1:20),sep=""),ahhwte, ahhwtes,ahhtype,ahhrih,ahhprtid,ahhfid,ahhmid)      #  ahghhm,# alnwte,
df02<-df02%>%select(bhhrhid,bhhrpid,bhhpno,bhhstate,bhgsex,bhgage,bhhrih,btifeftp, paste("brg",sprintf("%.2d",seq=1:20),sep=""),bhhwte, bhhwtes,bhhtype,bhhrih,bhhprtid,bhhfid,bhhmid)      #  ahghhm,# alnwte,
df03<-df03%>%select(chhrhid,chhrpid,chhpno,chhstate,chgsex,chgage,chhrih,ctifeftp, paste("crg",sprintf("%.2d",seq=1:20),sep=""),chhwte, chhwtes,chhtype,chhrih,chhprtid,chhfid,chhmid)      #  ahghhm,# alnwte,
df04<-df04%>%select(dhhrhid,dhhrpid,dhhpno,dhhstate,dhgsex,dhgage,dhhrih,dtifeftp, paste("drg",sprintf("%.2d",seq=1:20),sep=""),dhhwte, dhhwtes,dhhtype,dhhrih,dhhprtid,dhhfid,dhhmid)      #  ahghhm,# alnwte,
df05<-df05%>%select(ehhrhid,ehhrpid,ehhpno,ehhstate,ehgsex,ehgage,ehhrih,etifeftp, paste("erg",sprintf("%.2d",seq=1:20),sep=""),ehhwte, ehhwtes,ehhtype,ehhrih,ehhprtid,ehhfid,ehhmid)      #  ahghhm,# alnwte,
df06<-df06%>%select(fhhrhid,fhhrpid,fhhpno,fhhstate,fhgsex,fhgage,fhhrih,ftifeftp, paste("frg",sprintf("%.2d",seq=1:20),sep=""),fhhwte, fhhwtes,fhhtype,fhhrih,fhhprtid,fhhfid,fhhmid)      #  ahghhm,# alnwte,
df07<-df07%>%select(ghhrhid,ghhrpid,ghhpno,ghhstate,ghgsex,ghgage,ghhrih,gtifeftp, paste("grg",sprintf("%.2d",seq=1:20),sep=""),ghhwte, ghhwtes,ghhtype,ghhrih,ghhprtid,ghhfid,ghhmid)      #  ahghhm,# alnwte,
df08<-df08%>%select(hhhrhid,hhhrpid,hhhpno,hhhstate,hhgsex,hhgage,hhhrih,htifeftp, paste("hrg",sprintf("%.2d",seq=1:20),sep=""),hhhwte, hhhwtes,hhhtype,hhhrih,hhhprtid,hhhfid,hhhmid)      #  ahghhm,# alnwte,
df09<-df09%>%select(ihhrhid,ihhrpid,ihhpno,ihhstate,ihgsex,ihgage,ihhrih,itifeftp, paste("irg",sprintf("%.2d",seq=1:20),sep=""),ihhwte, ihhwtes,ihhtype,ihhrih,ihhprtid,ihhfid,ihhmid)      #  ahghhm,# alnwte,
df10<-df10%>%select(jhhrhid,jhhrpid,jhhpno,jhhstate,jhgsex,jhgage,jhhrih,jtifeftp, paste("jrg",sprintf("%.2d",seq=1:20),sep=""),jhhwte, jhhwtes,jhhtype,jhhrih,jhhprtid,jhhfid,jhhmid)      #  ahghhm,# alnwte,
df11<-df11%>%select(khhrhid,khhrpid,khhpno,khhstate,khgsex,khgage,khhrih,ktifeftp, paste("krg",sprintf("%.2d",seq=1:20),sep=""),khhwte, khhwtes,khhtype,khhrih,khhprtid,khhfid,khhmid)      #  ahghhm,# alnwte,
df12<-df12%>%select(lhhrhid,lhhrpid,lhhpno,lhhstate,lhgsex,lhgage,lhhrih,ltifeftp, paste("lrg",sprintf("%.2d",seq=1:20),sep=""),lhhwte, lhhwtes,lhhtype,lhhrih,lhhprtid,lhhfid,lhhmid)      #  ahghhm,# alnwte,
df13<-df13%>%select(mhhrhid,mhhrpid,mhhpno,mhhstate,mhgsex,mhgage,mhhrih,mtifeftp, paste("mrg",sprintf("%.2d",seq=1:20),sep=""),mhhwte, mhhwtes,mhhtype,mhhrih,mhhprtid,mhhfid,mhhmid)      #  ahghhm,# alnwte,
df14<-df14%>%select(nhhrhid,nhhrpid,nhhpno,nhhstate,nhgsex,nhgage,nhhrih,ntifeftp, paste("nrg",sprintf("%.2d",seq=1:20),sep=""),nhhwte, nhhwtes,nhhtype,nhhrih,nhhprtid,nhhfid,nhhmid)      #  ahghhm,# alnwte,
df15<-df15%>%select(ohhrhid,ohhrpid,ohhpno,ohhstate,ohgsex,ohgage,ohhrih,otifeftp, paste("org",sprintf("%.2d",seq=1:20),sep=""),ohhwte, ohhwtes,ohhtype,ohhrih,ohhprtid,ohhfid,ohhmid)      #  ahghhm,# alnwte,
df16<-df16%>%select(phhrhid,phhrpid,phhpno,phhstate,phgsex,phgage,phhrih,ptifeftp, paste("prg",sprintf("%.2d",seq=1:20),sep=""),phhwte, phhwtes,phhtype,phhrih,phhprtid,phhfid,phhmid)      #  ahghhm,# alnwte,
df17<-df17%>%select(qhhrhid,qhhrpid,qhhpno,qhhstate,qhgsex,qhgage,qhhrih,qtifeftp, paste("qrg",sprintf("%.2d",seq=1:20),sep=""),qhhwte, qhhwtes,qhhtype,qhhrih,qhhprtid,qhhfid,qhhmid)      #  ahghhm,# alnwte,
df18<-df18%>%select(rhhrhid,rhhrpid,rhhpno,rhhstate,rhgsex,rhgage,rhhrih,rtifeftp, paste("rrg",sprintf("%.2d",seq=1:20),sep=""),rhhwte, rhhwtes,rhhtype,rhhrih,rhhprtid,rhhfid,rhhmid)      #  ahghhm,# alnwte,
df19<-df19%>%select(shhrhid,shhrpid,shhpno,shhstate,shgsex,shgage,shhrih,stifeftp, paste("srg",sprintf("%.2d",seq=1:20),sep=""),shhwte, shhwtes,shhtype,shhrih,shhprtid,shhfid,shhmid)      #  ahghhm,# alnwte,
df20<-df20%>%select(thhrhid,thhrpid,thhpno,thhstate,thgsex,thgage,thhrih,ttifeftp, paste("trg",sprintf("%.2d",seq=1:20),sep=""),thhwte, thhwtes,thhtype,thhrih,thhprtid,thhfid,thhmid)      #  ahghhm,# alnwte,
df21<-df21%>%select(uhhrhid,uhhrpid,uhhpno,uhhstate,uhgsex,uhgage,uhhrih,utifeftp, paste("urg",sprintf("%.2d",seq=1:20),sep=""),uhhwte, uhhwtes,uhhtype,uhhrih,uhhprtid,uhhfid,uhhmid)      #  ahghhm,# alnwte,


df01$YEAR<-2001
df02$YEAR<-2002
df03$YEAR<-2003
df04$YEAR<-2004
df05$YEAR<-2005
df06$YEAR<-2006
df07$YEAR<-2007
df08$YEAR<-2008
df09$YEAR<-2009
df10$YEAR<-2010
df11$YEAR<-2011
df12$YEAR<-2012
df13$YEAR<-2013
df14$YEAR<-2014
df15$YEAR<-2015
df16$YEAR<-2016
df17$YEAR<-2017
df18$YEAR<-2018
df19$YEAR<-2019
df20$YEAR<-2020
df21$YEAR<-2021

# CREATE A LIST #####
names(df01)

samples_AUS_LIST<-list(df01,df02,df03,df04,df05,df06,df07,df08,df09,df10,df11,df12,df13,df14,df15,df16,df17,df18,df19,df20,df21)

FUN_CORE_AUS_LIST <-  function(df) {
  library(tidyverse)
  library(haven)
  library(readxl)
  ######  
  colnames(df)<-c("hhrhid","hhrpid","hhpno","hhstate","hgsex","hgage","hhrih","tifeftp",
                  paste("rg",sprintf("%.2d",seq=1:20),sep=""),"hhwte","hhwtes","hhtype","hhprtid","hhfid","hhmid","YEAR")  
  
  df<-df%>%filter(hhtype!=25)
  df<-df%>%mutate(head=ifelse(tifeftp==max(tifeftp),1,0),.by=hhrhid)
  
  df<-df%>% mutate(head2=ifelse(sum(head)>1,1,0),.by=hhrhid)
  df<-df%>%mutate(head3=ifelse(head2==1,
                               ifelse(hgage==max(hgage),1,0),0),.by=hhrhid)
  df<-df%>% mutate(head4=ifelse(head2==0,head,
                                ifelse(head2==1,head3,0))) 
  
  
  df<-df%>% mutate(hhper_head=ifelse(head4==1,1,nchar(hhpno)==2),.by=hhrhid)
  
  df<-df%>% mutate(hhper_head2=ifelse(head4==1,paste("rg",hhpno,sep=""),paste("rg",hhpno[head4==1],sep="")),.by=hhrhid)
  
  df <- df %>%
    rowwise()%>%
    mutate(relate = get(hhper_head2))%>%
    ungroup()
  df<-df%>%select(-c(rg01:rg20,hhprtid,hhfid,hhmid,head:hhper_head2))
  
  df$relate[is.na(df$relate)] <- 6000
  df$relate <- ifelse(df$relate<=-1,6000,df$relate ) 
  
  
  df$AGE <- df$hgage 
  df$CNTRY <-"Australia"
  df$CNTRY_ISO <-"AUS"
  df$CONTINENT<-"Australia and New Zealand"
  df$CONTINENT2<-"OCEANIA"
  df$SOURCE<-"HILDA"
  df$SAMPLE<-with(df,paste(CNTRY_ISO, YEAR, SOURCE, sep="_")) 
  
  df$PWEIGHT_A<-df$hhwte
  
  # df<-df%>%filter(hhtype!=25)
  
  df$AGE2<-with(df,  ifelse(AGE==999, "999",
                            ifelse(AGE<=4, "0-4",
                                   ifelse(AGE<=9, "5-9", 
                                          ifelse(AGE<=14, "10-14",
                                                 ifelse(AGE<=19, "15-19",
                                                        ifelse(AGE<=24, "20-24",
                                                               ifelse(AGE<=29, "25-29",
                                                                      ifelse(AGE<=34, "30-34",
                                                                             ifelse(AGE<=39, "35-39",
                                                                                    ifelse(AGE<=44, "40-44",
                                                                                           ifelse(AGE<=49, "45-49",
                                                                                                  ifelse(AGE<=54, "50-54",
                                                                                                         ifelse(AGE<=59, "55-59",
                                                                                                                ifelse(AGE<=64, "60-64",
                                                                                                                       ifelse(AGE<=69, "65-69",
                                                                                                                              ifelse(AGE<=74, "70-74",
                                                                                                                                     ifelse(AGE<=79, "75-79",
                                                                                                                                            ifelse(AGE<=84, "80-84",
                                                                                                                                                   ifelse(AGE<=89, "85-89",
                                                                                                                                                          ifelse(AGE<=94, "90-94","95+")))))))))))))))))))))
  
  
  df$CENSUS_ROUND<-with(df,ifelse((YEAR>=1956 & YEAR <=1965), 1960,
                                  ifelse((YEAR>=1966 & YEAR <=1975), 1970,
                                         ifelse((YEAR>=1976 & YEAR <=1985), 1980,
                                                ifelse((YEAR>=1986 & YEAR <=1995), 1990,
                                                       ifelse((YEAR>=1996 & YEAR <=2005), 2000,
                                                              ifelse((YEAR>=2006 & YEAR <=2015), 2010,
                                                                     ifelse((YEAR>=2016 & YEAR <=2025), 2020,0))))))))
  
  df$DECADE<-with(df,ifelse((YEAR>=1951 & YEAR <=1960), 1950,
                            ifelse((YEAR>=1961 & YEAR <=1970), 1960,
                                   ifelse((YEAR>=1971 & YEAR <=1980), 1970,
                                          ifelse((YEAR>=1981 & YEAR <=1990), 1980,
                                                 ifelse((YEAR>=1991 & YEAR <=2000), 1990,
                                                        ifelse((YEAR>=2001 & YEAR <=2010), 2000,
                                                               ifelse((YEAR>=2011 & YEAR <=2020), 2010,
                                                                      ifelse((YEAR>=2021 & YEAR <=2030), 2020,0)))))))))
  
  df$FIVE_YEAR<-with(df,ifelse((YEAR>=1951 & YEAR <=1955), 1951,
                               ifelse((YEAR>=1956 & YEAR <=1960), 1956,
                                      ifelse((YEAR>=1961 & YEAR <=1965), 1961,
                                             ifelse((YEAR>=1966 & YEAR <=1970), 1966,
                                                    ifelse((YEAR>=1971 & YEAR <=1975), 1971,
                                                           ifelse((YEAR>=1976 & YEAR <=1980), 1976,
                                                                  ifelse((YEAR>=1981 & YEAR <=1985), 1981,
                                                                         ifelse((YEAR>=1986 & YEAR <=1990), 1986,
                                                                                ifelse((YEAR>=1991 & YEAR <=1995), 1991,
                                                                                       ifelse((YEAR>=1996 & YEAR <=2000), 1996,
                                                                                              ifelse((YEAR>=2001 & YEAR <=2005), 2001,
                                                                                                     ifelse((YEAR>=2006 & YEAR <=2010), 2006,
                                                                                                            ifelse((YEAR>=2011 & YEAR <=2015), 2011,
                                                                                                                   ifelse((YEAR>=2016 & YEAR <=2020), 2016,
                                                                                                                          ifelse((YEAR>=2021 & YEAR <=2025), 2021,0))))))))))))))))
  
  
  
  
  
  
  
  df<-df%>%
    mutate(RELATE=case_when(relate == 0 ~ 1, #
                            relate == 1 ~ 2, #
                            relate == 2 ~ 2, #
                            relate == 3 ~ 5, #
                            relate == 4 ~ 4, #
                            relate == 5 ~ 4, #
                            relate == 6 ~ 4, #
                            relate == 7 ~ 3, #
                            relate == 8 ~ 3, #
                            relate == 9 ~ 3, #
                            relate == 10 ~ 3, #
                            relate == 11 ~ 4, #
                            relate == 12 ~ 4, #
                            relate == 13 ~ 4, #
                            relate == 14 ~ 4, #
                            relate == 15 ~ 4, #
                            relate == 16 ~ 4, #
                            relate == 17 ~ 4, #
                            relate == 18 ~ 4, #
                            relate == 19 ~ 5, #
                            relate == 6000 ~ 6)) #
  
  
  df$RELATE<-labelled(x=df$RELATE,
                      labels=c("Head"=1, 
                               "Spouse/partner"=2,
                               "Child"=3, 
                               "Other relative"=4,
                               "Non-relative"=5,
                               "Other relative or non-relative"=6,
                               "Missing" = 8,
                               "Unknown"=9),
                      label="Relationship to household head [general version]")         
  
  df<-df%>%
    mutate(RELATED=case_when(relate == 0 ~ 1000, #
                             relate == 1 ~ 2100, #
                             relate == 2 ~ 2200, #
                             relate == 3 ~ 5130, #
                             relate == 4 ~ 4120, #3100
                             relate == 5 ~ 4211, #3300
                             relate == 6 ~ 4211, #3200
                             relate == 7 ~ 3100, #4210
                             relate == 8 ~ 3300, #4211
                             relate == 9 ~ 3300, #4211
                             relate == 10 ~ 3400, #4220
                             relate == 11 ~ 4220, #3400
                             relate == 12 ~ 4500, #4100
                             relate == 13 ~ 4100, #4500
                             relate == 14 ~ 4410, #4410
                             relate == 15 ~ 4420, #
                             relate == 16 ~ 4420, #
                             relate == 17 ~ 4420, #
                             relate == 18 ~ 4000, #
                             relate == 19 ~ 5000, #
                             relate == 6000 ~ 6000))
}

system.time(
  CORE_AUS_LIST<-parLapply(cl, samples_AUS_LIST, FUN_CORE_AUS_LIST)
)

FUN_PASO1_AUS_LIST <-  function(df) {
  library(tidyverse)
  library(haven)  
  df<-df %>%
    add_count(hhrhid)%>%
    mutate(#hhid=paste(HHNUM,REFWEEK, sep="-"),
      child5=ifelse(AGE<=4,1,0),
      adult18=ifelse(AGE>=18,1,0),
      adult18M=ifelse((AGE>=18&hgsex==1),1,0),
      adult18F=ifelse((AGE>=18&hgsex==2),1,0),
      child18=ifelse(AGE<18,1,0),
      elderly65=ifelse(AGE>=65,1,0),
      
      age00_09=ifelse((AGE2=="0-4"|AGE2=="5-9"),1,0),
      age10_19=ifelse((AGE2=="10-14"|AGE2=="15-19"),1,0),
      age20_29=ifelse((AGE2=="20-24"|AGE2=="25-29"),1,0),
      age30_39=ifelse((AGE2=="30-34"|AGE2=="35-39"),1,0),
      age40_49=ifelse((AGE2=="40-44"|AGE2=="45-49"),1,0),
      age50_59=ifelse((AGE2=="50-54"|AGE2=="55-59"),1,0),
      age60_69=ifelse((AGE2=="60-64"|AGE2=="65-69"),1,0),
      age70_79=ifelse((AGE2=="70-74"|AGE2=="75-79"),1,0),
      age80=ifelse(AGE>=80,1,0),
      
      heads=ifelse(RELATE==1,1,0), 
      spouses=ifelse(RELATE==2,1,0),
      childs=ifelse(RELATE==3,1,0),
      other_relatives=ifelse(RELATE==4,1,0),
      non_relatives=ifelse(RELATE==5,1,0),
      other_rel_or_non_rel=ifelse(RELATE==6,1,0),
      
      grandchilds=ifelse(RELATED %in% c(4100, 4110,4120,4130),1,0),
      parents=ifelse(RELATED %in% c(4200,4210,4211,4220 ),1,0),
      siblings=ifelse(RELATED %in% c(4400,4410,4420,4430,4431,4432),1,0),
      
      WEIGHT_POP= sum(PWEIGHT_A,na.rm = TRUE)*1000,
      #WEIGHT_A= sum(df[df$RELATE==1,"PWEIGHT_A"]),
      WEIGHT_A= sum(PWEIGHT_A[RELATE==1],na.rm = TRUE),
      WEIGHT_A2= sum(PWEIGHT_A[RELATE==1&n==2]),
      WEIGHT_A3= sum(PWEIGHT_A[RELATE==1&n==3]),
      WEIGHT_A4= sum(PWEIGHT_A[RELATE==1&n==4]),
      WEIGHT_A5= sum(PWEIGHT_A[RELATE==1&n==5]),
      WEIGHT_AM= sum(PWEIGHT_A[RELATE==1&hgsex==1]),
      WEIGHT_AF= sum(PWEIGHT_A[RELATE==1&hgsex==2]),
      WEIGHT_2029=sum(PWEIGHT_A[RELATE==1&age20_29==1]),
      WEIGHT_3039=sum(PWEIGHT_A[RELATE==1&age30_39==1]),
      WEIGHT_4049=sum(PWEIGHT_A[RELATE==1&age40_49==1]),
      WEIGHT_5059=sum(PWEIGHT_A[RELATE==1&age50_59==1]),
      WEIGHT_6069=sum(PWEIGHT_A[RELATE==1&age60_69==1]),
      headed2029=ifelse((RELATE==1 &age20_29==1),1,0), 
      headed3039=ifelse((RELATE==1 &age30_39==1),1,0),
      headed4049=ifelse((RELATE==1 &age40_49==1),1,0),
      headed5059=ifelse((RELATE==1 &age50_59==1),1,0),
      headed6069=ifelse((RELATE==1 &age60_69==1),1,0),
      
      M_headed=ifelse((RELATE==1 & hgsex==1),1,0),
      F_headed=ifelse((RELATE==1 & hgsex==2),1,0))|>
    drop_na(PWEIGHT_A)
  
  
}

system.time(
  PASO1_AUS_LIST<-parLapply(cl, CORE_AUS_LIST, FUN_PASO1_AUS_LIST)
)

FUN_PASO2_AUS_LIST <-  function(df) {
  library(tidyverse)
  library(haven) 
  df<-df|>
    group_by(hhrhid)|>
    mutate(hh_per1=n(),
           hh_parents=sum(parents*PWEIGHT_A),
           hh_grandchilds=sum(grandchilds*PWEIGHT_A),
           hh_heads=sum(heads*PWEIGHT_A),
           hh_spouses=sum(spouses*PWEIGHT_A),
           hh_childs=sum(childs*PWEIGHT_A),
           hh_other_relatives=sum(other_relatives*PWEIGHT_A),
           hh_non_relatives=sum(non_relatives*PWEIGHT_A),
           hh_other_rel_or_non_rel=sum(other_rel_or_non_rel*PWEIGHT_A))|>
    mutate(family_type= #ifelse(hh_per1==1, 10, # unipersonal households 
             ifelse(hh_per1==1&AGE<50, 11, # unipersonal households 
                    ifelse(hh_per1==1&AGE>=50, 12, # unipersonal households 
                           ifelse(hh_spouses>0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20, #nuclear 
                                  ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives ==0 & hh_non_relatives==0,20,#nuclear 
                                         ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20,#nuclear 
                                                
                                                
                                                ifelse(hh_spouses>0 & hh_childs>0 &  hh_other_relatives >0 & hh_non_relatives==0,31,# nuclear + other relatives
                                                       ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives >0 & hh_non_relatives==0,31,
                                                              ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives >0 & hh_non_relatives==0,31,
                                                                     
                                                                     ifelse(hh_spouses>0 & hh_childs>0 &  hh_other_relatives ==0 & hh_non_relatives>0,32,
                                                                            ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives ==0 & hh_non_relatives>0,32,
                                                                                   ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives>0,32,       
                                                                                          
                                                                                          ifelse(hh_spouses>0 & hh_childs>0 &  hh_other_relatives >0 & hh_non_relatives>0,33,
                                                                                                 ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives >0 & hh_non_relatives>0,33,
                                                                                                        ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives >0 & hh_non_relatives>0,33,        
                                                                                                               
                                                                                                               ifelse(hh_spouses==0 & hh_childs==0 &  hh_other_relatives >0 & hh_non_relatives==0,34,
                                                                                                                      ifelse(hh_spouses==0 & hh_childs==0 &  hh_other_relatives ==0 & hh_non_relatives>0,35,
                                                                                                                             ifelse(hh_spouses==0 & hh_childs==0 &  hh_other_relatives >0 & hh_non_relatives>0,36,
                                                                                                                                    0))))))))))))))))))|>
    mutate(family_type2=ifelse(hh_per1==1, 10,
                               ifelse(hh_spouses>0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20,
                                      ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives ==0 & hh_non_relatives==0,20,
                                             ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20,       
                                                    ifelse(hh_non_relatives>0,30, # "Other non family",
                                                           ifelse((hh_parents>0 | hh_grandchilds>0),40,# "Stem family",
                                                                  ifelse(hh_other_relatives>0,50, 9999))))))))|>
    
    mutate(family_type3=ifelse(any(F_headed==1)&(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0),21,9999))|>#monomarental )
    ungroup()
  
}

system.time(
  PASO2_AUS_LIST<-parLapply(cl, PASO1_AUS_LIST, FUN_PASO2_AUS_LIST)
)

rm(PASO1_AUS_LIST)
gc()

FUN_PASO3_AUS_LIST <-  function(df) {
  library(tidyverse)
  library(haven) 
  df<-df |>
    mutate(#WEIGHT_FT10= sum(PWEIGHT[family_type==10]),
      WEIGHT_FT11= sum(PWEIGHT_A[family_type==11]),
      WEIGHT_FT12= sum(PWEIGHT_A[family_type==12]),
      WEIGHT_FT20= sum(PWEIGHT_A[RELATE==1&family_type==20]),
      WEIGHT_FT31= sum(PWEIGHT_A[RELATE==1&family_type==31]),
      WEIGHT_FT32= sum(PWEIGHT_A[RELATE==1&family_type==32]),
      WEIGHT_FT33= sum(PWEIGHT_A[RELATE==1&family_type==33]),
      WEIGHT_FT34= sum(PWEIGHT_A[RELATE==1&family_type==34]),
      WEIGHT_FT35= sum(PWEIGHT_A[RELATE==1&family_type==35]),
      WEIGHT_FT36= sum(PWEIGHT_A[RELATE==1&family_type==36]),
      WEIGHT_FT00= sum(PWEIGHT_A[RELATE==1&family_type==0]),
      
      WEIGHT_FT210= sum(PWEIGHT_A[family_type2==10]),
      WEIGHT_FT220= sum(PWEIGHT_A[RELATE==1&family_type2==20]),
      WEIGHT_FT230= sum(PWEIGHT_A[RELATE==1&family_type2==30]),
      WEIGHT_FT240= sum(PWEIGHT_A[RELATE==1&family_type2==40]),
      WEIGHT_FT250= sum(PWEIGHT_A[RELATE==1&family_type2==50]),
      WEIGHT_FT299= sum(PWEIGHT_A[RELATE==1&family_type2==9999]),
      
      WEIGHT_FT321= sum(PWEIGHT_A[RELATE==1&family_type3==21])
    )  
  
} 

system.time(
  PASO3_AUS_LIST<-parLapply(cl, PASO2_AUS_LIST, FUN_PASO3_AUS_LIST)
)

rm(PASO2_AUS_LIST)
gc()


FUN_PASO4_AUS_LIST <-  function(df) {
  library(tidyverse)
  library(haven)
  df<-df |> 
    group_by(SAMPLE,CNTRY,CNTRY_ISO,YEAR,hhrhid,CONTINENT,SOURCE,
             CENSUS_ROUND,DECADE,FIVE_YEAR,CONTINENT2,
             WEIGHT_POP,WEIGHT_A,WEIGHT_A2,WEIGHT_A3,WEIGHT_A4,
             WEIGHT_A5, WEIGHT_AM,WEIGHT_AF,WEIGHT_2029,WEIGHT_3039,WEIGHT_4049,
             WEIGHT_5059,WEIGHT_6069,
             WEIGHT_FT11, WEIGHT_FT12,
             WEIGHT_FT20,
             WEIGHT_FT31,WEIGHT_FT32,WEIGHT_FT33,WEIGHT_FT34,WEIGHT_FT35,
             WEIGHT_FT36,WEIGHT_FT00,WEIGHT_FT210,WEIGHT_FT220,WEIGHT_FT230,
             WEIGHT_FT240,WEIGHT_FT250,WEIGHT_FT299,
             WEIGHT_FT321,
             family_type,
             family_type2,
             family_type3)|>
    summarise(hh=1,
              hh_per1=n(),
              hh_m=sum(M_headed),
              hh_f=sum(F_headed),
              hh_per=sum(hh*PWEIGHT_A),
              hh_child5=sum(child5*PWEIGHT_A),
              hh_adult18=sum(adult18*PWEIGHT_A),
              hh_adult18b=sum(adult18),
              
              hh_00_09=sum(age00_09*PWEIGHT_A),
              hh_10_19=sum(age10_19*PWEIGHT_A),
              hh_20_29=sum(age20_29*PWEIGHT_A),
              hh_30_39=sum(age30_39*PWEIGHT_A),
              hh_40_49=sum(age40_49*PWEIGHT_A),
              hh_50_59=sum(age50_59*PWEIGHT_A),
              hh_60_69=sum(age60_69*PWEIGHT_A),
              hh_70_79=sum(age70_79*PWEIGHT_A),
              hh_80=sum(age80*PWEIGHT_A),
              
              hh_adult18M=sum(adult18M*PWEIGHT_A),
              hh_adult18F=sum(adult18F*PWEIGHT_A),
              hh_adult18Mb=sum(adult18M),
              
              hh_child18=sum(child18*PWEIGHT_A),
              hh_elderly65=sum(elderly65*PWEIGHT_A),
              
              hh_heads=sum(heads*PWEIGHT_A),
              hh_spouses=sum(spouses*PWEIGHT_A),
              hh_childs=sum(childs*PWEIGHT_A),
              hh_other_relatives=sum(other_relatives*PWEIGHT_A),
              hh_non_relatives=sum(non_relatives*PWEIGHT_A),
              hh_other_rel_or_non_rel=sum(other_rel_or_non_rel*PWEIGHT_A),
              
              hh_grandchilds=sum(grandchilds*PWEIGHT_A),
              hh_parents=sum(parents*PWEIGHT_A),
              hh_siblings=sum(siblings*PWEIGHT_A), 
              hh_M_headed=sum(M_headed*PWEIGHT_A),
              hh_F_headed=sum(F_headed*PWEIGHT_A),
              hh_headed2029=sum(headed2029*PWEIGHT_A),
              hh_headed3039=sum(headed3039*PWEIGHT_A),
              hh_headed4049=sum(headed4049*PWEIGHT_A),
              hh_headed5059=sum(headed5059*PWEIGHT_A),
              hh_headed6069=sum(headed6069*PWEIGHT_A)
    )|>
    ungroup()
} 

system.time(
  PASO4_AUS_LIST<-parLapply(cl, PASO3_AUS_LIST, FUN_PASO4_AUS_LIST)
)

rm(PASO3_AUS_LIST)
gc()


FUN_PASO5_AUS_LIST <-  function(df) {
  library(tidyverse)
  library(haven)
  df<-df |>
    group_by(CNTRY_ISO,YEAR,SOURCE,SAMPLE,CONTINENT,CONTINENT2,CENSUS_ROUND,DECADE,FIVE_YEAR)|>
    summarise(WPOP=round(unique(WEIGHT_POP),0),
              
              HS01=sum(ifelse(hh_per1==1,hh,0))/sum(hh),
              HS02=sum(ifelse(hh_per1==2,hh,0))/sum(hh),
              HS03=sum(ifelse(hh_per1==3,hh,0))/sum(hh),
              HS04=sum(ifelse(hh_per1==4,hh,0))/sum(hh),
              HS05=sum(ifelse(hh_per1==5,hh,0))/sum(hh),
              HS06=sum(ifelse(hh_per1==6,hh,0))/sum(hh),
              HS07=sum(ifelse(hh_per1==7,hh,0))/sum(hh),
              HS08=sum(ifelse(hh_per1==8,hh,0))/sum(hh),
              HS09=sum(ifelse(hh_per1==9,hh,0))/sum(hh),
              HS10=sum(ifelse(hh_per1==10,hh,0))/sum(hh),
              HS11=sum(ifelse(hh_per1>10,hh,0))/sum(hh),
              HS12=sum(ifelse((hh_per1==2|hh_per1==3),hh,0))/sum(hh),
              HS13=sum(ifelse((hh_per1==4|hh_per1==5),hh,0))/sum(hh),
              HS14=sum(ifelse(hh_per1>=6,hh,0))/sum(hh),
              HS15=sum(hh_child5 != 0)/sum(hh),
              HS16=sum(hh_elderly65 != 0)/sum(hh),
              HS17=sum(hh_per)/unique(WEIGHT_A),
              HS18=sum(hh_child5)/unique(WEIGHT_A),
              HS19=sum(hh_adult18)/unique(WEIGHT_A),
              HS20=sum(hh_child18)/unique(WEIGHT_A),
              HS21=sum(hh_elderly65)/unique(WEIGHT_A),
              HS22=sum(hh_00_09)/unique(WEIGHT_A),
              HS23=sum(hh_10_19)/unique(WEIGHT_A),
              HS24=sum(hh_20_29)/unique(WEIGHT_A),
              HS25=sum(hh_30_39)/unique(WEIGHT_A),
              HS26=sum(hh_40_49)/unique(WEIGHT_A),
              HS27=sum(hh_50_59)/unique(WEIGHT_A),
              HS28=sum(hh_60_69)/unique(WEIGHT_A),
              HS29=sum(hh_70_79)/unique(WEIGHT_A),
              HS30=sum(hh_80)/unique(WEIGHT_A),
              
              HR01=sum(hh_heads)/unique(WEIGHT_A),
              HR02=sum(hh_spouses)/unique(WEIGHT_A),
              HR03=sum(hh_childs)/unique(WEIGHT_A),
              HR04=sum(hh_other_relatives)/unique(WEIGHT_A),
              HR05=sum(hh_non_relatives)/unique(WEIGHT_A),
              HR06=sum(hh_other_rel_or_non_rel)/unique(WEIGHT_A),
              
              HR07=sum(hh_heads[hh_per1==2])/unique(WEIGHT_A2),
              HR08=sum(hh_spouses[hh_per1==2])/unique(WEIGHT_A2),
              HR09=sum(hh_childs[hh_per1==2])/unique(WEIGHT_A2),
              HR10=sum(hh_other_relatives[hh_per1==2])/unique(WEIGHT_A2),
              HR11=sum(hh_non_relatives[hh_per1==2])/unique(WEIGHT_A2),
              HR12=sum(hh_other_rel_or_non_rel[hh_per1==2])/unique(WEIGHT_A2),
              
              HR13=sum(hh_heads[hh_per1==3])/unique(WEIGHT_A3),
              HR14=sum(hh_spouses[hh_per1==3])/unique(WEIGHT_A3),
              HR15=sum(hh_childs[hh_per1==3])/unique(WEIGHT_A3),
              HR16=sum(hh_other_relatives[hh_per1==3])/unique(WEIGHT_A3),
              HR17=sum(hh_non_relatives[hh_per1==3])/unique(WEIGHT_A3),
              HR18=sum(hh_other_rel_or_non_rel[hh_per1==3])/unique(WEIGHT_A3),
              
              HR19=sum(hh_heads[hh_per1==4])/unique(WEIGHT_A4),
              HR20=sum(hh_spouses[hh_per1==4])/unique(WEIGHT_A4),
              HR21=sum(hh_childs[hh_per1==4])/unique(WEIGHT_A4),
              HR22=sum(hh_other_relatives[hh_per1==4])/unique(WEIGHT_A4),
              HR23=sum(hh_non_relatives[hh_per1==4])/unique(WEIGHT_A4),
              HR24=sum(hh_other_rel_or_non_rel[hh_per1==4])/unique(WEIGHT_A4),
              
              HR25=sum(hh_heads[hh_per1==5])/unique(WEIGHT_A5),
              HR26=sum(hh_spouses[hh_per1==5])/unique(WEIGHT_A5),
              HR27=sum(hh_childs[hh_per1==5])/unique(WEIGHT_A5),
              HR28=sum(hh_other_relatives[hh_per1==5])/unique(WEIGHT_A5),
              HR29=sum(hh_non_relatives[hh_per1==5])/unique(WEIGHT_A5),
              HR30=sum(hh_other_rel_or_non_rel[hh_per1==5])/unique(WEIGHT_A5),
              
              HT01=sum(ifelse(family_type==11|family_type==12,1,0)/sum(hh)),
              HT01b=sum(ifelse(family_type==11,1,0)/sum(hh)),
              HT01c=sum(ifelse(family_type==12,1,0)/sum(hh)),
              HT02=sum(ifelse(family_type==20,1,0)/sum(hh)),
              HT03=sum(ifelse(family_type==31,1,0)/sum(hh)),
              HT04=sum(ifelse(family_type==32,1,0)/sum(hh)),
              HT05=sum(ifelse(family_type==33,1,0)/sum(hh)),
              HT06=sum(ifelse(family_type==34,1,0)/sum(hh)),
              HT07=sum(ifelse(family_type==35,1,0)/sum(hh)),
              HT08=sum(ifelse(family_type==36,1,0)/sum(hh)),
              HT09=sum(ifelse(family_type==0,1,0)/sum(hh)),
              
              HT10=sum(hh_per[family_type==11|family_type==12])/(unique(WEIGHT_FT11)+unique(WEIGHT_FT12)),
              HT11=sum(hh_per[family_type==20])/unique(WEIGHT_FT20),
              HT12=sum(hh_per[family_type==31])/unique(WEIGHT_FT31),
              HT13=sum(hh_per[family_type==32])/unique(WEIGHT_FT32),
              HT14=sum(hh_per[family_type==33])/unique(WEIGHT_FT33),
              HT15=sum(hh_per[family_type==34])/unique(WEIGHT_FT34),
              HT16=sum(hh_per[family_type==35])/unique(WEIGHT_FT35),
              HT17=sum(hh_per[family_type==36])/unique(WEIGHT_FT36),
              HT18=sum(hh_per[family_type==0])/unique(WEIGHT_FT00),
              
              HT20=sum(ifelse(family_type2==10,1,0)/sum(hh)),
              HT21=sum(ifelse(family_type2==20,1,0)/sum(hh)),
              HT22=sum(ifelse(family_type2==40,1,0)/sum(hh)),
              HT23=sum(ifelse(family_type2==50,1,0)/sum(hh)),
              HT24=sum(ifelse(family_type2==30,1,0)/sum(hh)),
              HT25=sum(ifelse(family_type2==9999,1,0)/sum(hh)),
              HT26=sum(hh_per[family_type2==10])/unique(WEIGHT_FT210),
              HT27=sum(hh_per[family_type2==20])/unique(WEIGHT_FT220),
              HT28=sum(hh_per[family_type2==40])/unique(WEIGHT_FT240),
              HT29=sum(hh_per[family_type2==50])/unique(WEIGHT_FT250),
              HT30=sum(hh_per[family_type2==30])/unique(WEIGHT_FT230),
              HT31=sum(hh_per[family_type2==9999])/unique(WEIGHT_FT299),
              
              HH01=sum(hh_M_headed[hh_M_headed!=0])/unique(WEIGHT_A),
              HH02=sum(hh_F_headed[hh_F_headed!=0])/unique(WEIGHT_A),
              
              HH03=sum(ifelse((hh_m==1 &hh_per1==1),hh,0))/sum(hh_m),
              HH04=sum(ifelse((hh_m==1 &hh_per1==2),hh,0))/sum(hh_m),
              HH05=sum(ifelse((hh_m==1 &hh_per1==3),hh,0))/sum(hh_m),
              HH06=sum(ifelse((hh_m==1 &hh_per1==4),hh,0))/sum(hh_m),
              HH07=sum(ifelse((hh_m==1 &hh_per1==5),hh,0))/sum(hh_m),
              HH08=sum(ifelse((hh_m==1 &hh_per1==6),hh,0))/sum(hh_m),
              HH09=sum(ifelse((hh_m==1 &hh_per1==7),hh,0))/sum(hh_m),
              HH10=sum(ifelse((hh_m==1 &hh_per1==8),hh,0))/sum(hh_m),
              HH11=sum(ifelse((hh_m==1 &hh_per1==9),hh,0))/sum(hh_m),
              HH12=sum(ifelse((hh_m==1 &hh_per1==10),hh,0))/sum(hh_m),
              HH13=sum(ifelse((hh_m==1 &hh_per1>10),hh,0))/sum(hh_m),
              
              HH14=sum(ifelse((hh_f==1 &hh_per1==1),hh,0))/sum(hh_f),
              HH15=sum(ifelse((hh_f==1 &hh_per1==2),hh,0))/sum(hh_f),
              HH16=sum(ifelse((hh_f==1 &hh_per1==3),hh,0))/sum(hh_f),
              HH17=sum(ifelse((hh_f==1 &hh_per1==4),hh,0))/sum(hh_f),
              HH18=sum(ifelse((hh_f==1 &hh_per1==5),hh,0))/sum(hh_f),
              HH19=sum(ifelse((hh_f==1 &hh_per1==6),hh,0))/sum(hh_f),
              HH20=sum(ifelse((hh_f==1 &hh_per1==7),hh,0))/sum(hh_f),
              HH21=sum(ifelse((hh_f==1 &hh_per1==8),hh,0))/sum(hh_f),
              HH22=sum(ifelse((hh_f==1 &hh_per1==9),hh,0))/sum(hh_f),
              HH23=sum(ifelse((hh_f==1 &hh_per1==10),hh,0))/sum(hh_f),
              HH24=sum(ifelse((hh_f==1 &hh_per1>10),hh,0))/sum(hh_f),
              
              HH25=sum(ifelse((hh_m==1 &family_type2==10),1,0)/sum(hh_m)),
              HH26=sum(ifelse((hh_m==1 &family_type2==20),1,0)/sum(hh_m)),
              HH27=sum(ifelse((hh_m==1 &family_type2==40),1,0)/sum(hh_m)),
              HH28=sum(ifelse((hh_m==1 &family_type2==50),1,0)/sum(hh_m)),
              HH29=sum(ifelse((hh_m==1 &family_type2==30),1,0)/sum(hh_m)),
              HH30=sum(ifelse((hh_m==1 &family_type2==9999),1,0)/sum(hh_m)),
              
              HH31=sum(ifelse((hh_f==1 &family_type2==10),1,0)/sum(hh_f)),
              HH32=sum(ifelse((hh_f==1 &family_type2==20),1,0)/sum(hh_f)),
              HH33=sum(ifelse((hh_f==1 &family_type2==40),1,0)/sum(hh_f)),
              HH34=sum(ifelse((hh_f==1 &family_type2==50),1,0)/sum(hh_f)),
              HH35=sum(ifelse((hh_f==1 &family_type2==30),1,0)/sum(hh_f)),
              HH36=sum(ifelse((hh_f==1 &family_type2==9999),1,0)/sum(hh_f)),
              
              HH37=sum(hh_per[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH38=sum(hh_per[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH39=sum(hh_child18[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH40=sum(hh_child18[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH41=sum(hh_adult18[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH42=sum(hh_adult18[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH43=sum(hh_elderly65[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH44=sum(hh_elderly65[hh_F_headed!=0])/unique(WEIGHT_AF),
              
              HH45=sum(hh_spouses[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH46=sum(hh_spouses[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH47=sum(hh_childs[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH48=sum(hh_childs[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH49=sum(hh_other_relatives[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH50=sum(hh_other_relatives[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH51=sum(hh_non_relatives[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH52=sum(hh_non_relatives[hh_F_headed!=0])/unique(WEIGHT_AF),
              
              HH53=sum(hh_adult18M[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH54=sum(hh_adult18M[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH55=sum(hh_adult18F[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH56=sum(hh_adult18F[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH57=sum(hh[hh_adult18Mb==0]),
              HH58=sum(hh[hh_adult18Mb==1]),
              HH59=sum(hh[hh_adult18Mb==2]),
              HH60=sum(hh[hh_adult18Mb==3]),
              HH61=sum(hh[hh_adult18Mb==4]),
              HH62=sum(hh[hh_adult18Mb==5]),
              HH63=sum(hh[hh_adult18Mb>=6]),
              
              HH64=sum(hh_m[hh_adult18Mb==0]),
              HH65=sum(hh_m[hh_adult18Mb==1]),
              HH66=sum(hh_m[hh_adult18Mb==2]),
              HH67=sum(hh_m[hh_adult18Mb==3]),
              HH68=sum(hh_m[hh_adult18Mb==4]),
              HH69=sum(hh_m[hh_adult18Mb==5]),
              HH70=sum(hh_m[hh_adult18Mb>=6]),
              
              HH71=sum(hh_f[hh_adult18Mb==0]),
              HH72=sum(hh_f[hh_adult18Mb==1]),
              HH73=sum(hh_f[hh_adult18Mb==2]),
              HH74=sum(hh_f[hh_adult18Mb==3]),
              HH75=sum(hh_f[hh_adult18Mb==4]),
              HH76=sum(hh_f[hh_adult18Mb==5]),
              HH77=sum(hh_f[hh_adult18Mb>=6]),
              HTMM=sum(ifelse(family_type3==21,1,0)/sum(hh))
    )
  
  
}

system.time(
  PASO5_AUS_LIST<-parLapply(cl, PASO4_AUS_LIST, FUN_PASO5_AUS_LIST)
)

agrr_database_aus <- data.table::rbindlist(PASO5_AUS_LIST)
agrr_database_aus$CNTRY<-"Australia"
save(agrr_database_aus, file="G:/Shared drives/CORESIDENCE/WP4_RESEARCH OUTPUT/4_1_Articles/(9) Gender asymmetries in household headship/DATABASE/AGGR_INDICATORS_AUS_RITA.RData")

## CFPS CHINA ######

setwd("G:\\Shared drives\\CORESIDENCE\\WP2_DATA\\2_1_Input Data\\OTHERS\\CFPS_CHINA\\")

patt.shp <- ".*RData*"

data.shp <-list.files(pattern=patt.shp)


# CORE FILE CFPS CHINA #####
CORE_CFPS_LIST <- sapply(data.shp, function(x) mget(load(x)), simplify = TRUE) 

FUN_PASO1_CFPS_LIST <-  function(df) {
  library(tidyverse)
  library(haven)  
  df<-df %>%
    #add_count(hhrhid)%>%
    mutate(#hhid=paste(HHNUM,REFWEEK, sep="-"),
      child5=ifelse(AGE<=4,1,0),
      adult18=ifelse(AGE>=18,1,0),
      adult18M=ifelse((AGE>=18&SEX==1),1,0),
      adult18F=ifelse((AGE>=18&SEX==2),1,0),
      child18=ifelse(AGE<18,1,0),
      elderly65=ifelse(AGE>=65,1,0),
      
      age00_09=ifelse((AGE2=="0-4"|AGE2=="5-9"),1,0),
      age10_19=ifelse((AGE2=="10-14"|AGE2=="15-19"),1,0),
      age20_29=ifelse((AGE2=="20-24"|AGE2=="25-29"),1,0),
      age30_39=ifelse((AGE2=="30-34"|AGE2=="35-39"),1,0),
      age40_49=ifelse((AGE2=="40-44"|AGE2=="45-49"),1,0),
      age50_59=ifelse((AGE2=="50-54"|AGE2=="55-59"),1,0),
      age60_69=ifelse((AGE2=="60-64"|AGE2=="65-69"),1,0),
      age70_79=ifelse((AGE2=="70-74"|AGE2=="75-79"),1,0),
      age80=ifelse(AGE>=80,1,0),
      
      heads=ifelse(RELATE==1,1,0), 
      spouses=ifelse(RELATE==2,1,0),
      childs=ifelse(RELATE==3,1,0),
      other_relatives=ifelse(RELATE==4,1,0),
      non_relatives=ifelse(RELATE==5,1,0),
      other_rel_or_non_rel=ifelse(RELATE==6,1,0),
      
      grandchilds=ifelse(RELATED %in% c(4100, 4110,4120,4130),1,0),
      parents=ifelse(RELATED %in% c(4200,4210,4211,4220 ),1,0),
      siblings=ifelse(RELATED %in% c(4400,4410,4420,4430,4431,4432),1,0),
      
      WEIGHT_POP= sum(PWEIGHT,na.rm = TRUE)*1000,
      #WEIGHT_A= sum(df[df$RELATE==1,"PWEIGHT_A"]),
      WEIGHT_A= sum(PWEIGHT[RELATE==1],na.rm = TRUE),
      WEIGHT_A2= sum(PWEIGHT[RELATE==1&n==2]),
      WEIGHT_A3= sum(PWEIGHT[RELATE==1&n==3]),
      WEIGHT_A4= sum(PWEIGHT[RELATE==1&n==4]),
      WEIGHT_A5= sum(PWEIGHT[RELATE==1&n==5]),
      WEIGHT_AM= sum(PWEIGHT[RELATE==1&SEX==1]),
      WEIGHT_AF= sum(PWEIGHT[RELATE==1&SEX==2]),
      WEIGHT_2029=sum(PWEIGHT[RELATE==1&age20_29==1]),
      WEIGHT_3039=sum(PWEIGHT[RELATE==1&age30_39==1]),
      WEIGHT_4049=sum(PWEIGHT[RELATE==1&age40_49==1]),
      WEIGHT_5059=sum(PWEIGHT[RELATE==1&age50_59==1]),
      WEIGHT_6069=sum(PWEIGHT[RELATE==1&age60_69==1]),
      headed2029=ifelse((RELATE==1 &age20_29==1),1,0), 
      headed3039=ifelse((RELATE==1 &age30_39==1),1,0),
      headed4049=ifelse((RELATE==1 &age40_49==1),1,0),
      headed5059=ifelse((RELATE==1 &age50_59==1),1,0),
      headed6069=ifelse((RELATE==1 &age60_69==1),1,0),
      
      M_headed=ifelse((RELATE==1 & SEX==1),1,0),
      F_headed=ifelse((RELATE==1 & SEX==2),1,0))|>
    drop_na(PWEIGHT)
  
  
}

system.time(
  PASO1_CFPS_LIST<-parLapply(cl, CORE_CFPS_LIST, FUN_PASO1_CFPS_LIST)
)

FUN_PASO2_CFPS_LIST <-  function(df) {
  library(tidyverse)
  library(haven) 
  df<-df|>
    group_by(fid)|>
    mutate(hh_per1=n(),
           hh_parents=sum(parents*PWEIGHT),
           hh_grandchilds=sum(grandchilds*PWEIGHT),
           hh_heads=sum(heads*PWEIGHT),
           hh_spouses=sum(spouses*PWEIGHT),
           hh_childs=sum(childs*PWEIGHT),
           hh_other_relatives=sum(other_relatives*PWEIGHT),
           hh_non_relatives=sum(non_relatives*PWEIGHT),
           hh_other_rel_or_non_rel=sum(other_rel_or_non_rel*PWEIGHT))|>
    mutate(family_type= #ifelse(hh_per1==1, 10, # unipersonal households 
             ifelse(hh_per1==1&AGE<50, 11, # unipersonal households 
                    ifelse(hh_per1==1&AGE>=50, 12, # unipersonal households 
                           ifelse(hh_spouses>0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20, #nuclear 
                                  ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives ==0 & hh_non_relatives==0,20,#nuclear 
                                         ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20,#nuclear 
                                                
                                                
                                                ifelse(hh_spouses>0 & hh_childs>0 &  hh_other_relatives >0 & hh_non_relatives==0,31,# nuclear + other relatives
                                                       ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives >0 & hh_non_relatives==0,31,
                                                              ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives >0 & hh_non_relatives==0,31,
                                                                     
                                                                     ifelse(hh_spouses>0 & hh_childs>0 &  hh_other_relatives ==0 & hh_non_relatives>0,32,
                                                                            ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives ==0 & hh_non_relatives>0,32,
                                                                                   ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives>0,32,       
                                                                                          
                                                                                          ifelse(hh_spouses>0 & hh_childs>0 &  hh_other_relatives >0 & hh_non_relatives>0,33,
                                                                                                 ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives >0 & hh_non_relatives>0,33,
                                                                                                        ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives >0 & hh_non_relatives>0,33,        
                                                                                                               
                                                                                                               ifelse(hh_spouses==0 & hh_childs==0 &  hh_other_relatives >0 & hh_non_relatives==0,34,
                                                                                                                      ifelse(hh_spouses==0 & hh_childs==0 &  hh_other_relatives ==0 & hh_non_relatives>0,35,
                                                                                                                             ifelse(hh_spouses==0 & hh_childs==0 &  hh_other_relatives >0 & hh_non_relatives>0,36,
                                                                                                                                    0))))))))))))))))))|>
    mutate(family_type2=ifelse(hh_per1==1, 10,
                               ifelse(hh_spouses>0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20,
                                      ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives ==0 & hh_non_relatives==0,20,
                                             ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20,       
                                                    ifelse(hh_non_relatives>0,30, # "Other non family",
                                                           ifelse((hh_parents>0 | hh_grandchilds>0),40,# "Stem family",
                                                                  ifelse(hh_other_relatives>0,50, 9999))))))))|>
    
    mutate(family_type3=ifelse(any(F_headed==1)&(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0),21,9999))|>#monomarental )
    ungroup()
  
}

system.time(
  PASO2_CFPS_LIST<-parLapply(cl, PASO1_CFPS_LIST, FUN_PASO2_CFPS_LIST)
)

rm(PASO1_CFPS_LIST)
gc()

FUN_PASO3_CFPS_LIST <-  function(df) {
  library(tidyverse)
  library(haven) 
  df<-df |>
    mutate(#WEIGHT_FT10= sum(PWEIGHT[family_type==10]),
      WEIGHT_FT11= sum(PWEIGHT[family_type==11]),
      WEIGHT_FT12= sum(PWEIGHT[family_type==12]),
      WEIGHT_FT20= sum(PWEIGHT[RELATE==1&family_type==20]),
      WEIGHT_FT31= sum(PWEIGHT[RELATE==1&family_type==31]),
      WEIGHT_FT32= sum(PWEIGHT[RELATE==1&family_type==32]),
      WEIGHT_FT33= sum(PWEIGHT[RELATE==1&family_type==33]),
      WEIGHT_FT34= sum(PWEIGHT[RELATE==1&family_type==34]),
      WEIGHT_FT35= sum(PWEIGHT[RELATE==1&family_type==35]),
      WEIGHT_FT36= sum(PWEIGHT[RELATE==1&family_type==36]),
      WEIGHT_FT00= sum(PWEIGHT[RELATE==1&family_type==0]),
      
      WEIGHT_FT210= sum(PWEIGHT[family_type2==10]),
      WEIGHT_FT220= sum(PWEIGHT[RELATE==1&family_type2==20]),
      WEIGHT_FT230= sum(PWEIGHT[RELATE==1&family_type2==30]),
      WEIGHT_FT240= sum(PWEIGHT[RELATE==1&family_type2==40]),
      WEIGHT_FT250= sum(PWEIGHT[RELATE==1&family_type2==50]),
      WEIGHT_FT299= sum(PWEIGHT[RELATE==1&family_type2==9999]),
      
      WEIGHT_FT321= sum(PWEIGHT[RELATE==1&family_type3==21])
    )  
  
} 

system.time(
  PASO3_CFPS_LIST<-parLapply(cl, PASO2_CFPS_LIST, FUN_PASO3_CFPS_LIST)
)

rm(PASO2_CFPS_LIST)
gc()

FUN_PASO4_CFPS_LIST <-  function(df) {
  library(tidyverse)
  library(haven)
  df<-df |> 
    group_by(SAMPLE,CNTRY,YEAR,fid,CONTINENT,CNTRY_ISO,
             SOURCE,CENSUS_ROUND,DECADE,FIVE_YEAR,CONTINENT2,
             WEIGHT_POP,WEIGHT_A,WEIGHT_A2,WEIGHT_A3,WEIGHT_A4,
             WEIGHT_A5, WEIGHT_AM,WEIGHT_AF,WEIGHT_2029,WEIGHT_3039,WEIGHT_4049,
             WEIGHT_5059,WEIGHT_6069,
             WEIGHT_FT11, WEIGHT_FT12,
             WEIGHT_FT20,
             WEIGHT_FT31,WEIGHT_FT32,WEIGHT_FT33,WEIGHT_FT34,WEIGHT_FT35,
             WEIGHT_FT36,WEIGHT_FT00,WEIGHT_FT210,WEIGHT_FT220,WEIGHT_FT230,
             WEIGHT_FT240,WEIGHT_FT250,WEIGHT_FT299,
             WEIGHT_FT321,
             family_type,
             family_type2,
             family_type3)|>
    summarise(hh=1,
              hh_per1=n(),
              hh_m=sum(M_headed),
              hh_f=sum(F_headed),
              hh_per=sum(hh*PWEIGHT),
              hh_child5=sum(child5*PWEIGHT),
              hh_adult18=sum(adult18*PWEIGHT),
              hh_adult18b=sum(adult18),
              
              hh_00_09=sum(age00_09*PWEIGHT),
              hh_10_19=sum(age10_19*PWEIGHT),
              hh_20_29=sum(age20_29*PWEIGHT),
              hh_30_39=sum(age30_39*PWEIGHT),
              hh_40_49=sum(age40_49*PWEIGHT),
              hh_50_59=sum(age50_59*PWEIGHT),
              hh_60_69=sum(age60_69*PWEIGHT),
              hh_70_79=sum(age70_79*PWEIGHT),
              hh_80=sum(age80*PWEIGHT),
              
              hh_adult18M=sum(adult18M*PWEIGHT),
              hh_adult18F=sum(adult18F*PWEIGHT),
              hh_adult18Mb=sum(adult18M),
              
              hh_child18=sum(child18*PWEIGHT),
              hh_elderly65=sum(elderly65*PWEIGHT),
              
              hh_heads=sum(heads*PWEIGHT),
              hh_spouses=sum(spouses*PWEIGHT),
              hh_childs=sum(childs*PWEIGHT),
              hh_other_relatives=sum(other_relatives*PWEIGHT),
              hh_non_relatives=sum(non_relatives*PWEIGHT),
              hh_other_rel_or_non_rel=sum(other_rel_or_non_rel*PWEIGHT),
              
              hh_grandchilds=sum(grandchilds*PWEIGHT),
              hh_parents=sum(parents*PWEIGHT),
              hh_siblings=sum(siblings*PWEIGHT), 
              hh_M_headed=sum(M_headed*PWEIGHT),
              hh_F_headed=sum(F_headed*PWEIGHT),
              hh_headed2029=sum(headed2029*PWEIGHT),
              hh_headed3039=sum(headed3039*PWEIGHT),
              hh_headed4049=sum(headed4049*PWEIGHT),
              hh_headed5059=sum(headed5059*PWEIGHT),
              hh_headed6069=sum(headed6069*PWEIGHT)
    )|>
    ungroup()
} 

system.time(
  PASO4_CFPS_LIST<-parLapply(cl, PASO3_CFPS_LIST, FUN_PASO4_CFPS_LIST)
)

rm(PASO3_CFPS_LIST)
gc()

FUN_PASO5_CFPS_LIST <-  function(df) {
  library(tidyverse)
  library(haven)
  df<-df |>
    group_by(CNTRY,CNTRY_ISO,YEAR,SOURCE,SAMPLE,CONTINENT,CONTINENT2,CENSUS_ROUND,DECADE,FIVE_YEAR)|>
    summarise(WPOP=round(unique(WEIGHT_POP),0),
              
              HS01=sum(ifelse(hh_per1==1,hh,0))/sum(hh),
              HS02=sum(ifelse(hh_per1==2,hh,0))/sum(hh),
              HS03=sum(ifelse(hh_per1==3,hh,0))/sum(hh),
              HS04=sum(ifelse(hh_per1==4,hh,0))/sum(hh),
              HS05=sum(ifelse(hh_per1==5,hh,0))/sum(hh),
              HS06=sum(ifelse(hh_per1==6,hh,0))/sum(hh),
              HS07=sum(ifelse(hh_per1==7,hh,0))/sum(hh),
              HS08=sum(ifelse(hh_per1==8,hh,0))/sum(hh),
              HS09=sum(ifelse(hh_per1==9,hh,0))/sum(hh),
              HS10=sum(ifelse(hh_per1==10,hh,0))/sum(hh),
              HS11=sum(ifelse(hh_per1>10,hh,0))/sum(hh),
              HS12=sum(ifelse((hh_per1==2|hh_per1==3),hh,0))/sum(hh),
              HS13=sum(ifelse((hh_per1==4|hh_per1==5),hh,0))/sum(hh),
              HS14=sum(ifelse(hh_per1>=6,hh,0))/sum(hh),
              HS15=sum(hh_child5 != 0)/sum(hh),
              HS16=sum(hh_elderly65 != 0)/sum(hh),
              HS17=sum(hh_per)/unique(WEIGHT_A),
              HS18=sum(hh_child5)/unique(WEIGHT_A),
              HS19=sum(hh_adult18)/unique(WEIGHT_A),
              HS20=sum(hh_child18)/unique(WEIGHT_A),
              HS21=sum(hh_elderly65)/unique(WEIGHT_A),
              HS22=sum(hh_00_09)/unique(WEIGHT_A),
              HS23=sum(hh_10_19)/unique(WEIGHT_A),
              HS24=sum(hh_20_29)/unique(WEIGHT_A),
              HS25=sum(hh_30_39)/unique(WEIGHT_A),
              HS26=sum(hh_40_49)/unique(WEIGHT_A),
              HS27=sum(hh_50_59)/unique(WEIGHT_A),
              HS28=sum(hh_60_69)/unique(WEIGHT_A),
              HS29=sum(hh_70_79)/unique(WEIGHT_A),
              HS30=sum(hh_80)/unique(WEIGHT_A),
              
              HR01=sum(hh_heads)/unique(WEIGHT_A),
              HR02=sum(hh_spouses)/unique(WEIGHT_A),
              HR03=sum(hh_childs)/unique(WEIGHT_A),
              HR04=sum(hh_other_relatives)/unique(WEIGHT_A),
              HR05=sum(hh_non_relatives)/unique(WEIGHT_A),
              HR06=sum(hh_other_rel_or_non_rel)/unique(WEIGHT_A),
              
              HR07=sum(hh_heads[hh_per1==2])/unique(WEIGHT_A2),
              HR08=sum(hh_spouses[hh_per1==2])/unique(WEIGHT_A2),
              HR09=sum(hh_childs[hh_per1==2])/unique(WEIGHT_A2),
              HR10=sum(hh_other_relatives[hh_per1==2])/unique(WEIGHT_A2),
              HR11=sum(hh_non_relatives[hh_per1==2])/unique(WEIGHT_A2),
              HR12=sum(hh_other_rel_or_non_rel[hh_per1==2])/unique(WEIGHT_A2),
              
              HR13=sum(hh_heads[hh_per1==3])/unique(WEIGHT_A3),
              HR14=sum(hh_spouses[hh_per1==3])/unique(WEIGHT_A3),
              HR15=sum(hh_childs[hh_per1==3])/unique(WEIGHT_A3),
              HR16=sum(hh_other_relatives[hh_per1==3])/unique(WEIGHT_A3),
              HR17=sum(hh_non_relatives[hh_per1==3])/unique(WEIGHT_A3),
              HR18=sum(hh_other_rel_or_non_rel[hh_per1==3])/unique(WEIGHT_A3),
              
              HR19=sum(hh_heads[hh_per1==4])/unique(WEIGHT_A4),
              HR20=sum(hh_spouses[hh_per1==4])/unique(WEIGHT_A4),
              HR21=sum(hh_childs[hh_per1==4])/unique(WEIGHT_A4),
              HR22=sum(hh_other_relatives[hh_per1==4])/unique(WEIGHT_A4),
              HR23=sum(hh_non_relatives[hh_per1==4])/unique(WEIGHT_A4),
              HR24=sum(hh_other_rel_or_non_rel[hh_per1==4])/unique(WEIGHT_A4),
              
              HR25=sum(hh_heads[hh_per1==5])/unique(WEIGHT_A5),
              HR26=sum(hh_spouses[hh_per1==5])/unique(WEIGHT_A5),
              HR27=sum(hh_childs[hh_per1==5])/unique(WEIGHT_A5),
              HR28=sum(hh_other_relatives[hh_per1==5])/unique(WEIGHT_A5),
              HR29=sum(hh_non_relatives[hh_per1==5])/unique(WEIGHT_A5),
              HR30=sum(hh_other_rel_or_non_rel[hh_per1==5])/unique(WEIGHT_A5),
              
              HT01=sum(ifelse(family_type==11|family_type==12,1,0)/sum(hh)),
              HT01b=sum(ifelse(family_type==11,1,0)/sum(hh)),
              HT01c=sum(ifelse(family_type==12,1,0)/sum(hh)),
              HT02=sum(ifelse(family_type==20,1,0)/sum(hh)),
              HT03=sum(ifelse(family_type==31,1,0)/sum(hh)),
              HT04=sum(ifelse(family_type==32,1,0)/sum(hh)),
              HT05=sum(ifelse(family_type==33,1,0)/sum(hh)),
              HT06=sum(ifelse(family_type==34,1,0)/sum(hh)),
              HT07=sum(ifelse(family_type==35,1,0)/sum(hh)),
              HT08=sum(ifelse(family_type==36,1,0)/sum(hh)),
              HT09=sum(ifelse(family_type==0,1,0)/sum(hh)),
              
              HT10=sum(hh_per[family_type==11|family_type==12])/(unique(WEIGHT_FT11)+unique(WEIGHT_FT12)),
              HT11=sum(hh_per[family_type==20])/unique(WEIGHT_FT20),
              HT12=sum(hh_per[family_type==31])/unique(WEIGHT_FT31),
              HT13=sum(hh_per[family_type==32])/unique(WEIGHT_FT32),
              HT14=sum(hh_per[family_type==33])/unique(WEIGHT_FT33),
              HT15=sum(hh_per[family_type==34])/unique(WEIGHT_FT34),
              HT16=sum(hh_per[family_type==35])/unique(WEIGHT_FT35),
              HT17=sum(hh_per[family_type==36])/unique(WEIGHT_FT36),
              HT18=sum(hh_per[family_type==0])/unique(WEIGHT_FT00),
              
              HT20=sum(ifelse(family_type2==10,1,0)/sum(hh)),
              HT21=sum(ifelse(family_type2==20,1,0)/sum(hh)),
              HT22=sum(ifelse(family_type2==40,1,0)/sum(hh)),
              HT23=sum(ifelse(family_type2==50,1,0)/sum(hh)),
              HT24=sum(ifelse(family_type2==30,1,0)/sum(hh)),
              HT25=sum(ifelse(family_type2==9999,1,0)/sum(hh)),
              HT26=sum(hh_per[family_type2==10])/unique(WEIGHT_FT210),
              HT27=sum(hh_per[family_type2==20])/unique(WEIGHT_FT220),
              HT28=sum(hh_per[family_type2==40])/unique(WEIGHT_FT240),
              HT29=sum(hh_per[family_type2==50])/unique(WEIGHT_FT250),
              HT30=sum(hh_per[family_type2==30])/unique(WEIGHT_FT230),
              HT31=sum(hh_per[family_type2==9999])/unique(WEIGHT_FT299),
              
              HH01=sum(hh_M_headed[hh_M_headed!=0])/unique(WEIGHT_A),
              HH02=sum(hh_F_headed[hh_F_headed!=0])/unique(WEIGHT_A),
              
              HH03=sum(ifelse((hh_m==1 &hh_per1==1),hh,0))/sum(hh_m),
              HH04=sum(ifelse((hh_m==1 &hh_per1==2),hh,0))/sum(hh_m),
              HH05=sum(ifelse((hh_m==1 &hh_per1==3),hh,0))/sum(hh_m),
              HH06=sum(ifelse((hh_m==1 &hh_per1==4),hh,0))/sum(hh_m),
              HH07=sum(ifelse((hh_m==1 &hh_per1==5),hh,0))/sum(hh_m),
              HH08=sum(ifelse((hh_m==1 &hh_per1==6),hh,0))/sum(hh_m),
              HH09=sum(ifelse((hh_m==1 &hh_per1==7),hh,0))/sum(hh_m),
              HH10=sum(ifelse((hh_m==1 &hh_per1==8),hh,0))/sum(hh_m),
              HH11=sum(ifelse((hh_m==1 &hh_per1==9),hh,0))/sum(hh_m),
              HH12=sum(ifelse((hh_m==1 &hh_per1==10),hh,0))/sum(hh_m),
              HH13=sum(ifelse((hh_m==1 &hh_per1>10),hh,0))/sum(hh_m),
              
              HH14=sum(ifelse((hh_f==1 &hh_per1==1),hh,0))/sum(hh_f),
              HH15=sum(ifelse((hh_f==1 &hh_per1==2),hh,0))/sum(hh_f),
              HH16=sum(ifelse((hh_f==1 &hh_per1==3),hh,0))/sum(hh_f),
              HH17=sum(ifelse((hh_f==1 &hh_per1==4),hh,0))/sum(hh_f),
              HH18=sum(ifelse((hh_f==1 &hh_per1==5),hh,0))/sum(hh_f),
              HH19=sum(ifelse((hh_f==1 &hh_per1==6),hh,0))/sum(hh_f),
              HH20=sum(ifelse((hh_f==1 &hh_per1==7),hh,0))/sum(hh_f),
              HH21=sum(ifelse((hh_f==1 &hh_per1==8),hh,0))/sum(hh_f),
              HH22=sum(ifelse((hh_f==1 &hh_per1==9),hh,0))/sum(hh_f),
              HH23=sum(ifelse((hh_f==1 &hh_per1==10),hh,0))/sum(hh_f),
              HH24=sum(ifelse((hh_f==1 &hh_per1>10),hh,0))/sum(hh_f),
              
              HH25=sum(ifelse((hh_m==1 &family_type2==10),1,0)/sum(hh_m)),
              HH26=sum(ifelse((hh_m==1 &family_type2==20),1,0)/sum(hh_m)),
              HH27=sum(ifelse((hh_m==1 &family_type2==40),1,0)/sum(hh_m)),
              HH28=sum(ifelse((hh_m==1 &family_type2==50),1,0)/sum(hh_m)),
              HH29=sum(ifelse((hh_m==1 &family_type2==30),1,0)/sum(hh_m)),
              HH30=sum(ifelse((hh_m==1 &family_type2==9999),1,0)/sum(hh_m)),
              
              HH31=sum(ifelse((hh_f==1 &family_type2==10),1,0)/sum(hh_f)),
              HH32=sum(ifelse((hh_f==1 &family_type2==20),1,0)/sum(hh_f)),
              HH33=sum(ifelse((hh_f==1 &family_type2==40),1,0)/sum(hh_f)),
              HH34=sum(ifelse((hh_f==1 &family_type2==50),1,0)/sum(hh_f)),
              HH35=sum(ifelse((hh_f==1 &family_type2==30),1,0)/sum(hh_f)),
              HH36=sum(ifelse((hh_f==1 &family_type2==9999),1,0)/sum(hh_f)),
              
              HH37=sum(hh_per[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH38=sum(hh_per[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH39=sum(hh_child18[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH40=sum(hh_child18[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH41=sum(hh_adult18[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH42=sum(hh_adult18[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH43=sum(hh_elderly65[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH44=sum(hh_elderly65[hh_F_headed!=0])/unique(WEIGHT_AF),
              
              HH45=sum(hh_spouses[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH46=sum(hh_spouses[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH47=sum(hh_childs[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH48=sum(hh_childs[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH49=sum(hh_other_relatives[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH50=sum(hh_other_relatives[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH51=sum(hh_non_relatives[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH52=sum(hh_non_relatives[hh_F_headed!=0])/unique(WEIGHT_AF),
              
              HH53=sum(hh_adult18M[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH54=sum(hh_adult18M[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH55=sum(hh_adult18F[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH56=sum(hh_adult18F[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH57=sum(hh[hh_adult18Mb==0]),
              HH58=sum(hh[hh_adult18Mb==1]),
              HH59=sum(hh[hh_adult18Mb==2]),
              HH60=sum(hh[hh_adult18Mb==3]),
              HH61=sum(hh[hh_adult18Mb==4]),
              HH62=sum(hh[hh_adult18Mb==5]),
              HH63=sum(hh[hh_adult18Mb>=6]),
              
              HH64=sum(hh_m[hh_adult18Mb==0]),
              HH65=sum(hh_m[hh_adult18Mb==1]),
              HH66=sum(hh_m[hh_adult18Mb==2]),
              HH67=sum(hh_m[hh_adult18Mb==3]),
              HH68=sum(hh_m[hh_adult18Mb==4]),
              HH69=sum(hh_m[hh_adult18Mb==5]),
              HH70=sum(hh_m[hh_adult18Mb>=6]),
              
              HH71=sum(hh_f[hh_adult18Mb==0]),
              HH72=sum(hh_f[hh_adult18Mb==1]),
              HH73=sum(hh_f[hh_adult18Mb==2]),
              HH74=sum(hh_f[hh_adult18Mb==3]),
              HH75=sum(hh_f[hh_adult18Mb==4]),
              HH76=sum(hh_f[hh_adult18Mb==5]),
              HH77=sum(hh_f[hh_adult18Mb>=6]),
              HTMM=sum(ifelse(family_type3==21,1,0)/sum(hh))
    )
  
  
}

system.time(
  PASO5_CFPS_LIST<-parLapply(cl, PASO4_CFPS_LIST, FUN_PASO5_CFPS_LIST)
)

agrr_database_cfps <- data.table::rbindlist(PASO5_CFPS_LIST)
save(agrr_database_cfps, file="G:/Shared drives/CORESIDENCE/WP4_RESEARCH OUTPUT/4_1_Articles/(9) Gender asymmetries in household headship/DATABASE/AGGR_INDICATORS_CFPS_RITA.RData")

## MICS ######

setwd("G:\\Shared drives\\CORESIDENCE\\WP2_DATA\\2_1_Input Data\\MICS")

patt.shp <- ".*RData*"

data.shp <-list.files(pattern=patt.shp)

# CORE FILE MICS #####
samples_MICS_LIST2 <- sapply(data.shp, function(x) mget(load(x)), simplify = TRUE) 

FUN_CORE_MICS_LIST <-  function(df) {
  library(tidyverse)
  library(haven)
  library(readxl)
  ######  
  regionw <- read_excel("G:/Shared drives/CORESIDENCE/WP4_RESEARCH OUTPUT/4_1_Articles/(1) Household size and composition a global update/DATABASE/regionw.xlsx")
  regionw<-as.data.frame(regionw)
  df<-as.data.frame(df)
  df<- data.frame(df,
                  regionw[match(df[,"CNTRY_ISO"],
                                regionw[,"ISO3"]),c("EU Member States", "REGIONW")])
  #colnames(df)[grep(names(df%>% select(last_col())), colnames(df))]<-"REGIONW"
  
  df<-as_tibble(df)
  df<-df%>%
    mutate(CONTINENT=case_when(REGIONW == 11 ~ "Eastern Africa",
                               REGIONW == 12 ~ "Middle Africa",
                               REGIONW == 13 ~ "Northern Africa",
                               REGIONW == 14 ~ "Southern Africa",
                               REGIONW == 15 ~ "Western Africa",
                               REGIONW == 21 ~ "Caribbean" ,
                               REGIONW == 22 ~ "Central America" ,
                               REGIONW == 23 ~ "South America" ,
                               REGIONW == 24 ~ "North America",
                               REGIONW == 31 ~ "Central Asia",
                               REGIONW == 32 ~ "Eastern Asia",
                               REGIONW == 33 ~ "Southern Asia" ,
                               REGIONW == 34 ~ "South-Eastern Asia",
                               REGIONW == 35 ~ "Western Asia",
                               REGIONW == 41 ~ "Eastern Europe" ,
                               REGIONW == 42 ~ "Northern Europe" ,
                               REGIONW == 43 ~ "Southern Europe",
                               REGIONW == 44 ~ "Western Europe",
                               REGIONW == 51 ~ "Australia and New Zealand" ,
                               REGIONW == 52 ~ "Melanesia",
                               REGIONW == 53 ~ "Micronesia",
                               REGIONW == 54 ~ "Polynesia"))
  
  df<-df%>%
    mutate(CONT2=case_when(CONTINENT == "Eastern Africa" ~ "AFRICA",
                           CONTINENT == "Middle Africa" ~ "AFRICA",
                           CONTINENT == "Northern Africa" ~ "AFRICA",
                           CONTINENT == "Southern Africa" ~ "AFRICA",
                           CONTINENT == "Western Africa" ~ "AFRICA",
                           CONTINENT == "Caribbean" ~ "LATIN-AMERICA",
                           CONTINENT == "Central America" ~ "LATIN-AMERICA",
                           CONTINENT == "South America" ~ "LATIN-AMERICA",
                           CONTINENT == "North America" ~ "NORTH-AMERICA",
                           CONTINENT == "Central Asia" ~ "ASIA",
                           CONTINENT == "Eastern Asia" ~ "ASIA",
                           CONTINENT == "Southern Asia" ~ "ASIA",
                           CONTINENT == "South-Eastern Asia" ~ "ASIA",
                           CONTINENT == "Western Asia" ~ "ASIA",
                           CONTINENT == "Eastern Europe" ~ "EUROPE",
                           CONTINENT == "Northern Europe" ~ "EUROPE",
                           CONTINENT == "Southern Europe" ~ "EUROPE",
                           CONTINENT == "Western Europe" ~ "EUROPE",
                           CONTINENT == "Australia and New Zealand" ~ "OCEANIA",
                           CONTINENT == "Melanesia" ~ "OCEANIA",
                           CONTINENT == "Micronesia" ~ "OCEANIA",
                           CONTINENT == "Polynesia" ~ "OCEANIA"))
  
  
  colnames(df)[18]<-"CNTRY"  
  df<-df%>%
    drop_na(AGE)%>% drop_na(RELATED)
}

system.time(
  CORE_MICS_LIST<-parLapply(cl, samples_MICS_LIST2, FUN_CORE_MICS_LIST)
)

FUN_PASO1_MICS_LIST <-  function(df) {
  library(tidyverse)
  library(haven)  
  colnames(df)[17]<-"PWEIGHT"
  df$PWEIGHT<-as.numeric(df$PWEIGHT)
  df<-df %>%
    #   filter(GQ %in% VALID_GQ) %>% #filtrem nom?s els private households
    add_count(SERIAL)%>%
    mutate(#hhid=paste(HHNUM,REFWEEK, sep="-"),
      child5=ifelse(AGE<=4,1,0),
      adult18=ifelse(AGE>=18,1,0),
      adult18M=ifelse((AGE>=18&sex==1),1,0),
      adult18F=ifelse((AGE>=18&sex==2),1,0),
      child18=ifelse(AGE<18,1,0),
      elderly65=ifelse(AGE>=65,1,0),
      
      age00_09=ifelse((AGE2=="0-4"|AGE2=="5-9"),1,0),
      age10_19=ifelse((AGE2=="10-14"|AGE2=="15-19"),1,0),
      age20_29=ifelse((AGE2=="20-24"|AGE2=="25-29"),1,0),
      age30_39=ifelse((AGE2=="30-34"|AGE2=="35-39"),1,0),
      age40_49=ifelse((AGE2=="40-44"|AGE2=="45-49"),1,0),
      age50_59=ifelse((AGE2=="50-54"|AGE2=="55-59"),1,0),
      age60_69=ifelse((AGE2=="60-64"|AGE2=="65-69"),1,0),
      age70_79=ifelse((AGE2=="70-74"|AGE2=="75-79"),1,0),
      age80=ifelse(AGE>=80,1,0),
      
      heads=ifelse(RELATE==1,1,0), 
      spouses=ifelse(RELATE==2,1,0),
      childs=ifelse(RELATE==3,1,0),
      other_relatives=ifelse(RELATE==4,1,0),
      non_relatives=ifelse(RELATE==5,1,0),
      other_rel_or_non_rel=ifelse(RELATE==6,1,0),
      
      grandchilds=ifelse(RELATED %in% c(4100, 4110,4120,4130),1,0),
      parents=ifelse(RELATED %in% c(4200,4210,4211,4220 ),1,0),
      siblings=ifelse(RELATED %in% c(4400,4410,4420,4430,4431,4432),1,0),
      
      WEIGHT_POP= sum(PWEIGHT,na.rm = TRUE)*1000,
      #WEIGHT_A= sum(df[df$RELATE==1,"PWEIGHT_A"]),
      WEIGHT_A= sum(PWEIGHT[RELATE==1],na.rm = TRUE),
      WEIGHT_A2= sum(PWEIGHT[RELATE==1&n==2]),
      WEIGHT_A3= sum(PWEIGHT[RELATE==1&n==3]),
      WEIGHT_A4= sum(PWEIGHT[RELATE==1&n==4]),
      WEIGHT_A5= sum(PWEIGHT[RELATE==1&n==5]),
      WEIGHT_AM= sum(PWEIGHT[RELATE==1&sex==1]),
      WEIGHT_AF= sum(PWEIGHT[RELATE==1&sex==2]),
      WEIGHT_2029=sum(PWEIGHT[RELATE==1&age20_29==1]),
      WEIGHT_3039=sum(PWEIGHT[RELATE==1&age30_39==1]),
      WEIGHT_4049=sum(PWEIGHT[RELATE==1&age40_49==1]),
      WEIGHT_5059=sum(PWEIGHT[RELATE==1&age50_59==1]),
      WEIGHT_6069=sum(PWEIGHT[RELATE==1&age60_69==1]),
      headed2029=ifelse((RELATE==1 &age20_29==1),1,0), 
      headed3039=ifelse((RELATE==1 &age30_39==1),1,0),
      headed4049=ifelse((RELATE==1 &age40_49==1),1,0),
      headed5059=ifelse((RELATE==1 &age50_59==1),1,0),
      headed6069=ifelse((RELATE==1 &age60_69==1),1,0),
      
      M_headed=ifelse((RELATE==1 & sex==1),1,0),
      F_headed=ifelse((RELATE==1 & sex==2),1,0))|>
    drop_na(PWEIGHT)
  
  
}

system.time(
  PASO1_MICS_LIST<-parLapply(cl, CORE_MICS_LIST, FUN_PASO1_MICS_LIST)
)

FUN_PASO2_MICS_LIST <-  function(df) {
  library(tidyverse)
  library(haven) 
  df<-df|>
    group_by(SERIAL)|>
    mutate(hh_per1=n(),
           hh_parents=sum(parents*PWEIGHT),
           hh_grandchilds=sum(grandchilds*PWEIGHT),
           hh_heads=sum(heads*PWEIGHT),
           hh_spouses=sum(spouses*PWEIGHT),
           hh_childs=sum(childs*PWEIGHT),
           hh_other_relatives=sum(other_relatives*PWEIGHT),
           hh_non_relatives=sum(non_relatives*PWEIGHT),
           hh_other_rel_or_non_rel=sum(other_rel_or_non_rel*PWEIGHT))|>
    mutate(family_type= #ifelse(hh_per1==1, 10, # unipersonal households 
             ifelse(hh_per1==1&AGE<50, 11, # unipersonal households 
                    ifelse(hh_per1==1&AGE>=50, 12, # unipersonal households 
                           ifelse(hh_spouses>0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20, #nuclear 
                                  ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives ==0 & hh_non_relatives==0,20,#nuclear 
                                         ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20,#nuclear 
                                                
                                                
                                                ifelse(hh_spouses>0 & hh_childs>0 &  hh_other_relatives >0 & hh_non_relatives==0,31,# nuclear + other relatives
                                                       ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives >0 & hh_non_relatives==0,31,
                                                              ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives >0 & hh_non_relatives==0,31,
                                                                     
                                                                     ifelse(hh_spouses>0 & hh_childs>0 &  hh_other_relatives ==0 & hh_non_relatives>0,32,
                                                                            ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives ==0 & hh_non_relatives>0,32,
                                                                                   ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives>0,32,       
                                                                                          
                                                                                          ifelse(hh_spouses>0 & hh_childs>0 &  hh_other_relatives >0 & hh_non_relatives>0,33,
                                                                                                 ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives >0 & hh_non_relatives>0,33,
                                                                                                        ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives >0 & hh_non_relatives>0,33,        
                                                                                                               
                                                                                                               ifelse(hh_spouses==0 & hh_childs==0 &  hh_other_relatives >0 & hh_non_relatives==0,34,
                                                                                                                      ifelse(hh_spouses==0 & hh_childs==0 &  hh_other_relatives ==0 & hh_non_relatives>0,35,
                                                                                                                             ifelse(hh_spouses==0 & hh_childs==0 &  hh_other_relatives >0 & hh_non_relatives>0,36,
                                                                                                                                    0))))))))))))))))))|>
    mutate(family_type2=ifelse(hh_per1==1, 10,
                               ifelse(hh_spouses>0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20,
                                      ifelse(hh_spouses>0 & hh_childs==0 & hh_other_relatives ==0 & hh_non_relatives==0,20,
                                             ifelse(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0,20,       
                                                    ifelse(hh_non_relatives>0,30, # "Other non family",
                                                           ifelse((hh_parents>0 | hh_grandchilds>0),40,# "Stem family",
                                                                  ifelse(hh_other_relatives>0,50, 9999))))))))|>
    
    mutate(family_type3=ifelse(any(F_headed==1)&(hh_spouses==0 & hh_childs>0 & hh_other_relatives ==0 & hh_non_relatives==0),21,9999))|>#monomarental )
    ungroup()
  
}

system.time(
  PASO2_MICS_LIST<-parLapply(cl, PASO1_MICS_LIST, FUN_PASO2_MICS_LIST)
)

rm(PASO1_MICS_LIST)
gc()

FUN_PASO3_MICS_LIST <-  function(df) {
  library(tidyverse)
  library(haven) 
  df<-df |>
    mutate(#WEIGHT_FT10= sum(PWEIGHT[family_type==10]),
      WEIGHT_FT11= sum(PWEIGHT[family_type==11]),
      WEIGHT_FT12= sum(PWEIGHT[family_type==12]),
      WEIGHT_FT20= sum(PWEIGHT[RELATE==1&family_type==20]),
      WEIGHT_FT31= sum(PWEIGHT[RELATE==1&family_type==31]),
      WEIGHT_FT32= sum(PWEIGHT[RELATE==1&family_type==32]),
      WEIGHT_FT33= sum(PWEIGHT[RELATE==1&family_type==33]),
      WEIGHT_FT34= sum(PWEIGHT[RELATE==1&family_type==34]),
      WEIGHT_FT35= sum(PWEIGHT[RELATE==1&family_type==35]),
      WEIGHT_FT36= sum(PWEIGHT[RELATE==1&family_type==36]),
      WEIGHT_FT00= sum(PWEIGHT[RELATE==1&family_type==0]),
      
      WEIGHT_FT210= sum(PWEIGHT[family_type2==10]),
      WEIGHT_FT220= sum(PWEIGHT[RELATE==1&family_type2==20]),
      WEIGHT_FT230= sum(PWEIGHT[RELATE==1&family_type2==30]),
      WEIGHT_FT240= sum(PWEIGHT[RELATE==1&family_type2==40]),
      WEIGHT_FT250= sum(PWEIGHT[RELATE==1&family_type2==50]),
      WEIGHT_FT299= sum(PWEIGHT[RELATE==1&family_type2==9999]),
      
      WEIGHT_FT321= sum(PWEIGHT[RELATE==1&family_type3==21])
    )  
  
} 

system.time(
  PASO3_MICS_LIST<-parLapply(cl, PASO2_MICS_LIST, FUN_PASO3_MICS_LIST)
)

rm(PASO2_MICS_LIST)
gc()

FUN_PASO4_MICS_LIST <-  function(df) {
  library(tidyverse)
  library(haven)
  df<-df |> 
    group_by(SAMPLE,CNTRY,YEAR,SERIAL,CONTINENT,CNTRY_ISO,
             SOURCE,CENSUS_ROUND,DECADE,FIVE_YEAR,CONT2,
             WEIGHT_POP,WEIGHT_A,WEIGHT_A2,WEIGHT_A3,WEIGHT_A4,
             WEIGHT_A5, WEIGHT_AM,WEIGHT_AF,WEIGHT_2029,WEIGHT_3039,WEIGHT_4049,
             WEIGHT_5059,WEIGHT_6069,
             WEIGHT_FT11, WEIGHT_FT12,
             WEIGHT_FT20,
             WEIGHT_FT31,WEIGHT_FT32,WEIGHT_FT33,WEIGHT_FT34,WEIGHT_FT35,
             WEIGHT_FT36,WEIGHT_FT00,WEIGHT_FT210,WEIGHT_FT220,WEIGHT_FT230,
             WEIGHT_FT240,WEIGHT_FT250,WEIGHT_FT299,
             WEIGHT_FT321,
             family_type,
             family_type2,
             family_type3)|>
    summarise(hh=1,
              hh_per1=n(),
              hh_m=sum(M_headed),
              hh_f=sum(F_headed),
              hh_per=sum(hh*PWEIGHT),
              hh_child5=sum(child5*PWEIGHT),
              hh_adult18=sum(adult18*PWEIGHT),
              hh_adult18b=sum(adult18),
              
              hh_00_09=sum(age00_09*PWEIGHT),
              hh_10_19=sum(age10_19*PWEIGHT),
              hh_20_29=sum(age20_29*PWEIGHT),
              hh_30_39=sum(age30_39*PWEIGHT),
              hh_40_49=sum(age40_49*PWEIGHT),
              hh_50_59=sum(age50_59*PWEIGHT),
              hh_60_69=sum(age60_69*PWEIGHT),
              hh_70_79=sum(age70_79*PWEIGHT),
              hh_80=sum(age80*PWEIGHT),
              
              hh_adult18M=sum(adult18M*PWEIGHT),
              hh_adult18F=sum(adult18F*PWEIGHT),
              hh_adult18Mb=sum(adult18M),
              
              hh_child18=sum(child18*PWEIGHT),
              hh_elderly65=sum(elderly65*PWEIGHT),
              
              hh_heads=sum(heads*PWEIGHT),
              hh_spouses=sum(spouses*PWEIGHT),
              hh_childs=sum(childs*PWEIGHT),
              hh_other_relatives=sum(other_relatives*PWEIGHT),
              hh_non_relatives=sum(non_relatives*PWEIGHT),
              hh_other_rel_or_non_rel=sum(other_rel_or_non_rel*PWEIGHT),
              
              hh_grandchilds=sum(grandchilds*PWEIGHT),
              hh_parents=sum(parents*PWEIGHT),
              hh_siblings=sum(siblings*PWEIGHT), 
              hh_M_headed=sum(M_headed*PWEIGHT),
              hh_F_headed=sum(F_headed*PWEIGHT),
              hh_headed2029=sum(headed2029*PWEIGHT),
              hh_headed3039=sum(headed3039*PWEIGHT),
              hh_headed4049=sum(headed4049*PWEIGHT),
              hh_headed5059=sum(headed5059*PWEIGHT),
              hh_headed6069=sum(headed6069*PWEIGHT)
    )|>
    ungroup()
} 

system.time(
  PASO4_MICS_LIST<-parLapply(cl, PASO3_MICS_LIST, FUN_PASO4_MICS_LIST)
)

rm(PASO3_MICS_LIST)
gc()

FUN_PASO5_MICS_LIST <-  function(df) {
  library(tidyverse)
  library(haven)
  df<-df |>
    group_by(CNTRY_ISO,CNTRY,YEAR,SOURCE,SAMPLE,CONTINENT,CONT2,CENSUS_ROUND,DECADE,FIVE_YEAR)|>
    summarise(WPOP=round(unique(WEIGHT_POP),0),
              
              HS01=sum(ifelse(hh_per1==1,hh,0))/sum(hh),
              HS02=sum(ifelse(hh_per1==2,hh,0))/sum(hh),
              HS03=sum(ifelse(hh_per1==3,hh,0))/sum(hh),
              HS04=sum(ifelse(hh_per1==4,hh,0))/sum(hh),
              HS05=sum(ifelse(hh_per1==5,hh,0))/sum(hh),
              HS06=sum(ifelse(hh_per1==6,hh,0))/sum(hh),
              HS07=sum(ifelse(hh_per1==7,hh,0))/sum(hh),
              HS08=sum(ifelse(hh_per1==8,hh,0))/sum(hh),
              HS09=sum(ifelse(hh_per1==9,hh,0))/sum(hh),
              HS10=sum(ifelse(hh_per1==10,hh,0))/sum(hh),
              HS11=sum(ifelse(hh_per1>10,hh,0))/sum(hh),
              HS12=sum(ifelse((hh_per1==2|hh_per1==3),hh,0))/sum(hh),
              HS13=sum(ifelse((hh_per1==4|hh_per1==5),hh,0))/sum(hh),
              HS14=sum(ifelse(hh_per1>=6,hh,0))/sum(hh),
              HS15=sum(hh_child5 != 0)/sum(hh),
              HS16=sum(hh_elderly65 != 0)/sum(hh),
              HS17=sum(hh_per)/unique(WEIGHT_A),
              HS18=sum(hh_child5)/unique(WEIGHT_A),
              HS19=sum(hh_adult18)/unique(WEIGHT_A),
              HS20=sum(hh_child18)/unique(WEIGHT_A),
              HS21=sum(hh_elderly65)/unique(WEIGHT_A),
              HS22=sum(hh_00_09)/unique(WEIGHT_A),
              HS23=sum(hh_10_19)/unique(WEIGHT_A),
              HS24=sum(hh_20_29)/unique(WEIGHT_A),
              HS25=sum(hh_30_39)/unique(WEIGHT_A),
              HS26=sum(hh_40_49)/unique(WEIGHT_A),
              HS27=sum(hh_50_59)/unique(WEIGHT_A),
              HS28=sum(hh_60_69)/unique(WEIGHT_A),
              HS29=sum(hh_70_79)/unique(WEIGHT_A),
              HS30=sum(hh_80)/unique(WEIGHT_A),
              
              HR01=sum(hh_heads)/unique(WEIGHT_A),
              HR02=sum(hh_spouses)/unique(WEIGHT_A),
              HR03=sum(hh_childs)/unique(WEIGHT_A),
              HR04=sum(hh_other_relatives)/unique(WEIGHT_A),
              HR05=sum(hh_non_relatives)/unique(WEIGHT_A),
              HR06=sum(hh_other_rel_or_non_rel)/unique(WEIGHT_A),
              
              HR07=sum(hh_heads[hh_per1==2])/unique(WEIGHT_A2),
              HR08=sum(hh_spouses[hh_per1==2])/unique(WEIGHT_A2),
              HR09=sum(hh_childs[hh_per1==2])/unique(WEIGHT_A2),
              HR10=sum(hh_other_relatives[hh_per1==2])/unique(WEIGHT_A2),
              HR11=sum(hh_non_relatives[hh_per1==2])/unique(WEIGHT_A2),
              HR12=sum(hh_other_rel_or_non_rel[hh_per1==2])/unique(WEIGHT_A2),
              
              HR13=sum(hh_heads[hh_per1==3])/unique(WEIGHT_A3),
              HR14=sum(hh_spouses[hh_per1==3])/unique(WEIGHT_A3),
              HR15=sum(hh_childs[hh_per1==3])/unique(WEIGHT_A3),
              HR16=sum(hh_other_relatives[hh_per1==3])/unique(WEIGHT_A3),
              HR17=sum(hh_non_relatives[hh_per1==3])/unique(WEIGHT_A3),
              HR18=sum(hh_other_rel_or_non_rel[hh_per1==3])/unique(WEIGHT_A3),
              
              HR19=sum(hh_heads[hh_per1==4])/unique(WEIGHT_A4),
              HR20=sum(hh_spouses[hh_per1==4])/unique(WEIGHT_A4),
              HR21=sum(hh_childs[hh_per1==4])/unique(WEIGHT_A4),
              HR22=sum(hh_other_relatives[hh_per1==4])/unique(WEIGHT_A4),
              HR23=sum(hh_non_relatives[hh_per1==4])/unique(WEIGHT_A4),
              HR24=sum(hh_other_rel_or_non_rel[hh_per1==4])/unique(WEIGHT_A4),
              
              HR25=sum(hh_heads[hh_per1==5])/unique(WEIGHT_A5),
              HR26=sum(hh_spouses[hh_per1==5])/unique(WEIGHT_A5),
              HR27=sum(hh_childs[hh_per1==5])/unique(WEIGHT_A5),
              HR28=sum(hh_other_relatives[hh_per1==5])/unique(WEIGHT_A5),
              HR29=sum(hh_non_relatives[hh_per1==5])/unique(WEIGHT_A5),
              HR30=sum(hh_other_rel_or_non_rel[hh_per1==5])/unique(WEIGHT_A5),
              
              HT01=sum(ifelse(family_type==11|family_type==12,1,0)/sum(hh)),
              HT01b=sum(ifelse(family_type==11,1,0)/sum(hh)),
              HT01c=sum(ifelse(family_type==12,1,0)/sum(hh)),
              HT02=sum(ifelse(family_type==20,1,0)/sum(hh)),
              HT03=sum(ifelse(family_type==31,1,0)/sum(hh)),
              HT04=sum(ifelse(family_type==32,1,0)/sum(hh)),
              HT05=sum(ifelse(family_type==33,1,0)/sum(hh)),
              HT06=sum(ifelse(family_type==34,1,0)/sum(hh)),
              HT07=sum(ifelse(family_type==35,1,0)/sum(hh)),
              HT08=sum(ifelse(family_type==36,1,0)/sum(hh)),
              HT09=sum(ifelse(family_type==0,1,0)/sum(hh)),
              
              HT10=sum(hh_per[family_type==11|family_type==12])/(unique(WEIGHT_FT11)+unique(WEIGHT_FT12)),
              HT11=sum(hh_per[family_type==20])/unique(WEIGHT_FT20),
              HT12=sum(hh_per[family_type==31])/unique(WEIGHT_FT31),
              HT13=sum(hh_per[family_type==32])/unique(WEIGHT_FT32),
              HT14=sum(hh_per[family_type==33])/unique(WEIGHT_FT33),
              HT15=sum(hh_per[family_type==34])/unique(WEIGHT_FT34),
              HT16=sum(hh_per[family_type==35])/unique(WEIGHT_FT35),
              HT17=sum(hh_per[family_type==36])/unique(WEIGHT_FT36),
              HT18=sum(hh_per[family_type==0])/unique(WEIGHT_FT00),
              
              HT20=sum(ifelse(family_type2==10,1,0)/sum(hh)),
              HT21=sum(ifelse(family_type2==20,1,0)/sum(hh)),
              HT22=sum(ifelse(family_type2==40,1,0)/sum(hh)),
              HT23=sum(ifelse(family_type2==50,1,0)/sum(hh)),
              HT24=sum(ifelse(family_type2==30,1,0)/sum(hh)),
              HT25=sum(ifelse(family_type2==9999,1,0)/sum(hh)),
              HT26=sum(hh_per[family_type2==10])/unique(WEIGHT_FT210),
              HT27=sum(hh_per[family_type2==20])/unique(WEIGHT_FT220),
              HT28=sum(hh_per[family_type2==40])/unique(WEIGHT_FT240),
              HT29=sum(hh_per[family_type2==50])/unique(WEIGHT_FT250),
              HT30=sum(hh_per[family_type2==30])/unique(WEIGHT_FT230),
              HT31=sum(hh_per[family_type2==9999])/unique(WEIGHT_FT299),
              
              HH01=sum(hh_M_headed[hh_M_headed!=0])/unique(WEIGHT_A),
              HH02=sum(hh_F_headed[hh_F_headed!=0])/unique(WEIGHT_A),
              
              HH03=sum(ifelse((hh_m==1 &hh_per1==1),hh,0))/sum(hh_m),
              HH04=sum(ifelse((hh_m==1 &hh_per1==2),hh,0))/sum(hh_m),
              HH05=sum(ifelse((hh_m==1 &hh_per1==3),hh,0))/sum(hh_m),
              HH06=sum(ifelse((hh_m==1 &hh_per1==4),hh,0))/sum(hh_m),
              HH07=sum(ifelse((hh_m==1 &hh_per1==5),hh,0))/sum(hh_m),
              HH08=sum(ifelse((hh_m==1 &hh_per1==6),hh,0))/sum(hh_m),
              HH09=sum(ifelse((hh_m==1 &hh_per1==7),hh,0))/sum(hh_m),
              HH10=sum(ifelse((hh_m==1 &hh_per1==8),hh,0))/sum(hh_m),
              HH11=sum(ifelse((hh_m==1 &hh_per1==9),hh,0))/sum(hh_m),
              HH12=sum(ifelse((hh_m==1 &hh_per1==10),hh,0))/sum(hh_m),
              HH13=sum(ifelse((hh_m==1 &hh_per1>10),hh,0))/sum(hh_m),
              
              HH14=sum(ifelse((hh_f==1 &hh_per1==1),hh,0))/sum(hh_f),
              HH15=sum(ifelse((hh_f==1 &hh_per1==2),hh,0))/sum(hh_f),
              HH16=sum(ifelse((hh_f==1 &hh_per1==3),hh,0))/sum(hh_f),
              HH17=sum(ifelse((hh_f==1 &hh_per1==4),hh,0))/sum(hh_f),
              HH18=sum(ifelse((hh_f==1 &hh_per1==5),hh,0))/sum(hh_f),
              HH19=sum(ifelse((hh_f==1 &hh_per1==6),hh,0))/sum(hh_f),
              HH20=sum(ifelse((hh_f==1 &hh_per1==7),hh,0))/sum(hh_f),
              HH21=sum(ifelse((hh_f==1 &hh_per1==8),hh,0))/sum(hh_f),
              HH22=sum(ifelse((hh_f==1 &hh_per1==9),hh,0))/sum(hh_f),
              HH23=sum(ifelse((hh_f==1 &hh_per1==10),hh,0))/sum(hh_f),
              HH24=sum(ifelse((hh_f==1 &hh_per1>10),hh,0))/sum(hh_f),
              
              HH25=sum(ifelse((hh_m==1 &family_type2==10),1,0)/sum(hh_m)),
              HH26=sum(ifelse((hh_m==1 &family_type2==20),1,0)/sum(hh_m)),
              HH27=sum(ifelse((hh_m==1 &family_type2==40),1,0)/sum(hh_m)),
              HH28=sum(ifelse((hh_m==1 &family_type2==50),1,0)/sum(hh_m)),
              HH29=sum(ifelse((hh_m==1 &family_type2==30),1,0)/sum(hh_m)),
              HH30=sum(ifelse((hh_m==1 &family_type2==9999),1,0)/sum(hh_m)),
              
              HH31=sum(ifelse((hh_f==1 &family_type2==10),1,0)/sum(hh_f)),
              HH32=sum(ifelse((hh_f==1 &family_type2==20),1,0)/sum(hh_f)),
              HH33=sum(ifelse((hh_f==1 &family_type2==40),1,0)/sum(hh_f)),
              HH34=sum(ifelse((hh_f==1 &family_type2==50),1,0)/sum(hh_f)),
              HH35=sum(ifelse((hh_f==1 &family_type2==30),1,0)/sum(hh_f)),
              HH36=sum(ifelse((hh_f==1 &family_type2==9999),1,0)/sum(hh_f)),
              
              HH37=sum(hh_per[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH38=sum(hh_per[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH39=sum(hh_child18[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH40=sum(hh_child18[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH41=sum(hh_adult18[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH42=sum(hh_adult18[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH43=sum(hh_elderly65[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH44=sum(hh_elderly65[hh_F_headed!=0])/unique(WEIGHT_AF),
              
              HH45=sum(hh_spouses[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH46=sum(hh_spouses[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH47=sum(hh_childs[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH48=sum(hh_childs[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH49=sum(hh_other_relatives[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH50=sum(hh_other_relatives[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH51=sum(hh_non_relatives[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH52=sum(hh_non_relatives[hh_F_headed!=0])/unique(WEIGHT_AF),
              
              HH53=sum(hh_adult18M[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH54=sum(hh_adult18M[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH55=sum(hh_adult18F[hh_M_headed!=0])/unique(WEIGHT_AM),
              HH56=sum(hh_adult18F[hh_F_headed!=0])/unique(WEIGHT_AF),
              HH57=sum(hh[hh_adult18Mb==0]),
              HH58=sum(hh[hh_adult18Mb==1]),
              HH59=sum(hh[hh_adult18Mb==2]),
              HH60=sum(hh[hh_adult18Mb==3]),
              HH61=sum(hh[hh_adult18Mb==4]),
              HH62=sum(hh[hh_adult18Mb==5]),
              HH63=sum(hh[hh_adult18Mb>=6]),
              
              HH64=sum(hh_m[hh_adult18Mb==0]),
              HH65=sum(hh_m[hh_adult18Mb==1]),
              HH66=sum(hh_m[hh_adult18Mb==2]),
              HH67=sum(hh_m[hh_adult18Mb==3]),
              HH68=sum(hh_m[hh_adult18Mb==4]),
              HH69=sum(hh_m[hh_adult18Mb==5]),
              HH70=sum(hh_m[hh_adult18Mb>=6]),
              
              HH71=sum(hh_f[hh_adult18Mb==0]),
              HH72=sum(hh_f[hh_adult18Mb==1]),
              HH73=sum(hh_f[hh_adult18Mb==2]),
              HH74=sum(hh_f[hh_adult18Mb==3]),
              HH75=sum(hh_f[hh_adult18Mb==4]),
              HH76=sum(hh_f[hh_adult18Mb==5]),
              HH77=sum(hh_f[hh_adult18Mb>=6]),
              HTMM=sum(ifelse(family_type3==21,1,0)/sum(hh))
    )
  
  
}

system.time(
  PASO5_MICS_LIST<-parLapply(cl, PASO4_MICS_LIST, FUN_PASO5_MICS_LIST)
)

agrr_database_mics <- data.table::rbindlist(PASO5_MICS_LIST)
save(agrr_database_mics, file="G:/Shared drives/CORESIDENCE/WP4_RESEARCH OUTPUT/4_1_Articles/(9) Gender asymmetries in household headship/DATABASE/AGGR_INDICATORS_MICS_RITA.RData")

stopCluster(cl)



# READ ALL FOUR DATAFRAMES WITH AGGERGATED INDICATOR INDICATORS #####
setwd("G:/Shared drives/CORESIDENCE/WP4_RESEARCH OUTPUT/4_1_Articles/(9) Gender asymmetries in household headship/DATABASE/")

load("AGGR_INDICATORS_IPUMS.RData")
load("AGGR_INDICATORS_DHS.RData")
load("AGGR_INDICATORS_LFS.RData")
load("AGGR_INDICATORS_SILC.RData")
load("AGGR_INDICATORS_KOREA.RData")
load("AGGR_INDICATORS_AUS.RData")
load("AGGR_INDICATORS_CFPS.RData")
load("AGGR_INDICATORS_MICS.RData")

length(unique(agrr_database_ipums$CNTRY))
length(unique(agrr_database_dhs$CNTRY))
length(unique(agrr_database_lfs$CNTRY))
length(unique(agrr_database_mics$CNTRY))

# CHECK NAMES ######
names(agrr_database_ipums)
names(agrr_database_dhs)
names(agrr_database_lfs)
names(agrr_database_silc)
names(agrr_database_korea)
names(agrr_database_aus)
names(agrr_database_cfps)
names(agrr_database_mics)

# ARRANGE COLUMNS ORDER #####
agrr_database_dhs<- agrr_database_dhs %>% relocate(CNTRY, .before = country_control)
agrr_database_lfs<- agrr_database_lfs %>% relocate(CNTRY, .before = ISO3)
agrr_database_silc<- agrr_database_silc %>% relocate(CNTRY, .before = ISO3)
agrr_database_korea<- agrr_database_korea %>% relocate(CNTRY, .before = ISO3)
agrr_database_aus<- agrr_database_aus %>% relocate(CNTRY, .before = CNTRY_ISO)
agrr_database_mics<- agrr_database_mics %>% relocate(CNTRY, .before = CNTRY_ISO)


colnames(agrr_database_dhs)[2]<-"CNTRY_ISO"
colnames(agrr_database_dhs)[7]<-"CONTINENT2"
colnames(agrr_database_lfs)[2]<-"CNTRY_ISO"
colnames(agrr_database_lfs)[7]<-"CONTINENT2"
colnames(agrr_database_silc)[2]<-"CNTRY_ISO"
colnames(agrr_database_silc)[7]<-"CONTINENT2"
colnames(agrr_database_korea)[2]<-"CNTRY_ISO"
colnames(agrr_database_korea)[7]<-"CONTINENT2"
colnames(agrr_database_mics)[2]<-"CNTRY_ISO"
colnames(agrr_database_mics)[7]<-"CONTINENT2"

# GET LABELS OF COUNTRY NAMES ######
agrr_database_ipums$CNTRY<-as_factor(agrr_database_ipums$CNTRY)
agrr_database_ipums$CNTRY<-as.character(agrr_database_ipums$CNTRY)


# CHECK THERE ARE NO DIFFERENCES IN COLUMNS BETWEE DATAFRAMES ######
setdiff(names(agrr_database_ipums), names(agrr_database_dhs))
setdiff(names(agrr_database_ipums), names(agrr_database_lfs))
setdiff(names(agrr_database_dhs), names(agrr_database_lfs))
setdiff(names(agrr_database_silc), names(agrr_database_ipums))
setdiff(names(agrr_database_korea), names(agrr_database_ipums))
setdiff(names(agrr_database_ipums), names(agrr_database_aus))
setdiff(names(agrr_database_ipums), names(agrr_database_cfps))
setdiff(names(agrr_database_ipums), names(agrr_database_mics))


# RBIND DATAFRAMES INTO CORESIDENCE_AGG
CORESIDENCE_AGG<-rbind(agrr_database_ipums,
                       agrr_database_dhs,
                       agrr_database_lfs,
                       agrr_database_silc,
                       agrr_database_korea,
                       agrr_database_aus,
                       agrr_database_cfps,
                       agrr_database_mics)

# CORRECT ISO SURINAM ####
CORESIDENCE_AGG[263,2]<-"SUR"
length(unique(CORESIDENCE_AGG$CNTRY_ISO))

### remove colombia 1964
CORESIDENCE_AGG<-CORESIDENCE_AGG %>% 
  filter(SAMPLE!="COL_1964_IPUMS")

CORESIDENCE_AGG<-CORESIDENCE_AGG %>% 
  filter(SAMPLE!="MLT_2021_SILC")

#recent_year####
RY <- CORESIDENCE_AGG %>% group_by(CNTRY) %>% 
  summarise(ry=max(YEAR)) %>%
  mutate(RECENT_YEAR =1)


head(RY)
names(RY)<-c('CNTRY','YEAR','RECENT_YEAR')

CORESIDENCE_AGG$RECENT_YEAR==0
CORESIDENCE_AGG<-merge(CORESIDENCE_AGG,RY, by =c('CNTRY','YEAR'), all = TRUE)
CORESIDENCE_AGG$RECENT_YEAR[is.na(CORESIDENCE_AGG$RECENT_YEAR)] <- 0


#### POP_OWD #####


library(readxl)
OWD <- read_excel("G:/Shared drives/CORESIDENCE/WP2_DATA/2_5_Context Data and Indicators/Indices_OWD_1960_2021.xlsx", 
                  sheet = "pop")

OWD<-OWD%>%select(-Entity) 

names(OWD)<-c("CNTRY_ISO","YEAR","P1")

OWD$YEAR<-as.numeric(OWD$YEAR)
head(CORESIDENCE_AGG);head(OWD)
CORESIDENCE_AGG<-merge(CORESIDENCE_AGG,OWD,by=c('CNTRY_ISO','YEAR'),all.x=TRUE)

head(CORESIDENCE_AGG)



#### POP2021_OWD #####


library(readxl)
OWD <- read_excel("G:/Shared drives/CORESIDENCE/WP2_DATA/2_5_Context Data and Indicators/Indices_OWD_1960_2021.xlsx", 
                  sheet = "pop_2021")

OWD<-OWD%>%select(-Entity) 

names(OWD)<-c("CNTRY_ISO","YEAR","P2")

OWD<-OWD%>%select(-YEAR) 

#OWD$YEAR<-as.numeric(OWD$YEAR)
head(CORESIDENCE_AGG);head(OWD)
CORESIDENCE_AGG<-merge(CORESIDENCE_AGG,OWD,by=c('CNTRY_ISO'),all.x=TRUE)

head(CORESIDENCE_AGG)


KOS<-CORESIDENCE_AGG[CORESIDENCE_AGG$CNTRY_ISO=="XXK",]






#### FR_OWD #####


library(readxl)
OWD <- read_excel("G:/Shared drives/CORESIDENCE/WP2_DATA/2_5_Context Data and Indicators/Indices_OWD_1960_2021.xlsx", 
                  sheet = "fer")

OWD<-OWD%>%select(-Entity) 

names(OWD)<-c("CNTRY_ISO","YEAR","P3")

OWD$YEAR<-as.numeric(OWD$YEAR)
head(CORESIDENCE_AGG);head(OWD)
CORESIDENCE_AGG<-merge(CORESIDENCE_AGG,OWD,by=c('CNTRY_ISO','YEAR'),all.x=TRUE)

head(CORESIDENCE_AGG)







#### LE_OWD #####

library(readxl)
OWD <- read_excel("G:/Shared drives/CORESIDENCE/WP2_DATA/2_5_Context Data and Indicators/Indices_OWD_1960_2021.xlsx", 
                  sheet = "LE")

OWD<-OWD%>%select(-Entity) 

names(OWD)<-c("CNTRY_ISO","YEAR","P4")

OWD$YEAR<-as.numeric(OWD$YEAR)
head(CORESIDENCE_AGG);head(OWD)
CORESIDENCE_AGG<-merge(CORESIDENCE_AGG,OWD,by=c('CNTRY_ISO','YEAR'),all.x=TRUE)

head(CORESIDENCE_AGG)



#### LE_OWD female #####

library(readxl)
OWD <- read_excel("G:/Shared drives/CORESIDENCE/WP2_DATA/2_5_Context Data and Indicators/Indices_OWD_1960_2021.xlsx", 
                  sheet = "LE_f")

OWD<-OWD%>%select(-Entity) 

names(OWD)<-c("CNTRY_ISO","YEAR","P5")

OWD$YEAR<-as.numeric(OWD$YEAR)
head(CORESIDENCE_AGG);head(OWD)
CORESIDENCE_AGG<-merge(CORESIDENCE_AGG,OWD,by=c('CNTRY_ISO','YEAR'),all.x=TRUE)

head(CORESIDENCE_AGG)






#### LE_OWD male #####

library(readxl)
OWD <- read_excel("G:/Shared drives/CORESIDENCE/WP2_DATA/2_5_Context Data and Indicators/Indices_OWD_1960_2021.xlsx", 
                  sheet = "LE_m")

OWD<-OWD%>%select(-Entity) 

names(OWD)<-c("CNTRY_ISO","YEAR","P6")

OWD$YEAR<-as.numeric(OWD$YEAR)
head(CORESIDENCE_AGG);head(OWD)
CORESIDENCE_AGG<-merge(CORESIDENCE_AGG,OWD,by=c('CNTRY_ISO','YEAR'),all.x=TRUE)

head(CORESIDENCE_AGG)







#### HDI#####

library(readxl)
Indices_NU_1990_2021 <- read_excel("G:/Shared drives/CORESIDENCE/WP2_DATA/2_5_Context Data and Indicators/Indices_NU_1990_2021.xlsx", 
                                   sheet = "hdi")

hdi<-Indices_NU_1990_2021%>%
  pivot_longer(c(2:33),names_to = "year",values_to = "hdi")

head(hdi)

names(hdi)<-c("CNTRY_ISO","YEAR","D1")

hdi$YEAR<-as.numeric(hdi$YEAR)
head(CORESIDENCE_AGG);head(hdi)
CORESIDENCE_AGG<-merge(CORESIDENCE_AGG,hdi,by=c('CNTRY_ISO','YEAR'),all.x=TRUE)
head(CORESIDENCE_AGG)


#### HDI_2021 #####

library(readxl)
Indices_NU_1990_2021 <- read_excel("G:/Shared drives/CORESIDENCE/WP2_DATA/2_5_Context Data and Indicators/Indices_NU_1990_2021.xlsx", 
                                   sheet = "hdi21")



head(Indices_NU_1990_2021)

head(Indices_NU_1990_2021)

names(Indices_NU_1990_2021)<-c("CNTRY_ISO","D2")


head(CORESIDENCE_AGG);head(Indices_NU_1990_2021)
CORESIDENCE_AGG<-merge(CORESIDENCE_AGG,Indices_NU_1990_2021,by=c('CNTRY_ISO'),all.x=TRUE)
head(CORESIDENCE_AGG)



#### EYS #####

library(readxl)
Indices_NU_1990_2021 <- read_excel("G:/Shared drives/CORESIDENCE/WP2_DATA/2_5_Context Data and Indicators/Indices_NU_1990_2021.xlsx", 
                                   sheet = "eys")

eys<-Indices_NU_1990_2021%>%
  pivot_longer(c(2:33),names_to = "year",values_to = "eys")

head(eys)

names(eys)<-c("CNTRY_ISO","YEAR","D3")

eys$YEAR<-as.numeric(eys$YEAR)
head(CORESIDENCE_AGG);head(eys)
CORESIDENCE_AGG<-merge(CORESIDENCE_AGG,eys,by=c('CNTRY_ISO','YEAR'),all.x=TRUE)
head(CORESIDENCE_AGG)

#### MYS #####

library(readxl)
Indices_NU_1990_2021 <- read_excel("G:/Shared drives/CORESIDENCE/WP2_DATA/2_5_Context Data and Indicators/Indices_NU_1990_2021.xlsx", 
                                   sheet = "mys")

mys<-Indices_NU_1990_2021%>%
  pivot_longer(c(2:33),names_to = "year",values_to = "mys")

head(mys)

names(mys)<-c("CNTRY_ISO","YEAR","D4")

mys$YEAR<-as.numeric(mys$YEAR)
head(CORESIDENCE_AGG);head(mys)
CORESIDENCE_AGG<-merge(CORESIDENCE_AGG,mys,by=c('CNTRY_ISO','YEAR'),all.x=TRUE)
head(CORESIDENCE_AGG)


#### GDI #####

library(readxl)
Indices_NU_1990_2021 <- read_excel("G:/Shared drives/CORESIDENCE/WP2_DATA/2_5_Context Data and Indicators/Indices_NU_1990_2021.xlsx", 
                                   sheet = "gdi")

gdi<-Indices_NU_1990_2021%>%
  pivot_longer(c(2:33),names_to = "year",values_to = "gdi")

head(gdi)

names(gdi)<-c("CNTRY_ISO","YEAR","D5")

gdi$YEAR<-as.numeric(gdi$YEAR)
head(CORESIDENCE_AGG);head(gdi)
CORESIDENCE_AGG<-merge(CORESIDENCE_AGG,gdi,by=c('CNTRY_ISO','YEAR'),all.x=TRUE)
head(CORESIDENCE_AGG)




#### GNIPC #####

library(readxl)
Indices_NU_1990_2021 <- read_excel("G:/Shared drives/CORESIDENCE/WP2_DATA/2_5_Context Data and Indicators/Indices_NU_1990_2021.xlsx", 
                                   sheet = "gnipc")

gnipc<-Indices_NU_1990_2021%>%
  pivot_longer(c(2:33),names_to = "year",values_to = "gnipc")

head(gnipc)

names(gnipc)<-c("CNTRY_ISO","YEAR","D6")

gnipc$YEAR<-as.numeric(gnipc$YEAR)
head(CORESIDENCE_AGG);head(gnipc)
CORESIDENCE_AGG<-merge(CORESIDENCE_AGG,gnipc,by=c('CNTRY_ISO','YEAR'),all.x=TRUE)
head(CORESIDENCE_AGG)


#### HDI_F #####

library(readxl)
Indices_NU_1990_2021 <- read_excel("G:/Shared drives/CORESIDENCE/WP2_DATA/2_5_Context Data and Indicators/Indices_NU_1990_2021.xlsx", 
                                   sheet = "hdi_f")

hdi_f<-Indices_NU_1990_2021%>%
  pivot_longer(c(2:33),names_to = "year",values_to = "hdi_f")

head(hdi_f)

names(hdi_f)<-c("CNTRY_ISO","YEAR","D7")

hdi_f$YEAR<-as.numeric(hdi_f$YEAR)
head(CORESIDENCE_AGG);head(hdi_f)
CORESIDENCE_AGG<-merge(CORESIDENCE_AGG,hdi_f,by=c('CNTRY_ISO','YEAR'),all.x=TRUE)
head(CORESIDENCE_AGG)




#### EYS_F #####

library(readxl)
Indices_NU_1990_2021 <- read_excel("G:/Shared drives/CORESIDENCE/WP2_DATA/2_5_Context Data and Indicators/Indices_NU_1990_2021.xlsx", 
                                   sheet = "eys_f")

eys_f<-Indices_NU_1990_2021%>%
  pivot_longer(c(2:33),names_to = "year",values_to = "eys_f")

head(eys_f)

names(eys_f)<-c("CNTRY_ISO","YEAR","D8")

eys_f$YEAR<-as.numeric(eys_f$YEAR)
head(CORESIDENCE_AGG);head(eys_f)
CORESIDENCE_AGG<-merge(CORESIDENCE_AGG,eys_f,by=c('CNTRY_ISO','YEAR'),all.x=TRUE)
head(CORESIDENCE_AGG)



#### MYS_F #####

library(readxl)
Indices_NU_1990_2021 <- read_excel("G:/Shared drives/CORESIDENCE/WP2_DATA/2_5_Context Data and Indicators/Indices_NU_1990_2021.xlsx", 
                                   sheet = "mys_f")

mys_f<-Indices_NU_1990_2021%>%
  pivot_longer(c(2:33),names_to = "year",values_to = "mys_f")

head(mys_f)

names(mys_f)<-c("CNTRY_ISO","YEAR","D9")

mys_f$YEAR<-as.numeric(mys_f$YEAR)
head(CORESIDENCE_AGG);head(mys_f)
CORESIDENCE_AGG<-merge(CORESIDENCE_AGG,mys_f,by=c('CNTRY_ISO','YEAR'),all.x=TRUE)
head(CORESIDENCE_AGG)



#### GNIPC_F #####

library(readxl)
Indices_NU_1990_2021 <- read_excel("G:/Shared drives/CORESIDENCE/WP2_DATA/2_5_Context Data and Indicators/Indices_NU_1990_2021.xlsx", 
                                   sheet = "gnipc_f")

gnipc_f<-Indices_NU_1990_2021%>%
  pivot_longer(c(2:33),names_to = "year",values_to = "gnipc_f")

head(gnipc_f)

names(gnipc_f)<-c("CNTRY_ISO","YEAR","D10")

gnipc_f$YEAR<-as.numeric(gnipc_f$YEAR)
head(CORESIDENCE_AGG);head(gnipc_f)
CORESIDENCE_AGG<-merge(CORESIDENCE_AGG,gnipc_f,by=c('CNTRY_ISO','YEAR'),all.x=TRUE)
head(CORESIDENCE_AGG)



#### HDI_M #####

library(readxl)
Indices_NU_1990_2021 <- read_excel("G:/Shared drives/CORESIDENCE/WP2_DATA/2_5_Context Data and Indicators/Indices_NU_1990_2021.xlsx", 
                                   sheet = "hdi_m")

hdi_f<-Indices_NU_1990_2021%>%
  pivot_longer(c(2:33),names_to = "year",values_to = "hdi_f")

head(hdi_f)

names(hdi_f)<-c("CNTRY_ISO","YEAR","D11")

hdi_f$YEAR<-as.numeric(hdi_f$YEAR)
head(CORESIDENCE_AGG);head(hdi_f)
CORESIDENCE_AGG<-merge(CORESIDENCE_AGG,hdi_f,by=c('CNTRY_ISO','YEAR'),all.x=TRUE)
head(CORESIDENCE_AGG)






#### EYS_M #####

library(readxl)
Indices_NU_1990_2021 <- read_excel("G:/Shared drives/CORESIDENCE/WP2_DATA/2_5_Context Data and Indicators/Indices_NU_1990_2021.xlsx", 
                                   sheet = "eys_m")

eys_m<-Indices_NU_1990_2021%>%
  pivot_longer(c(2:33),names_to = "year",values_to = "eys_m")

head(eys_m)

names(eys_m)<-c("CNTRY_ISO","YEAR","D12")

eys_m$YEAR<-as.numeric(eys_m$YEAR)
head(CORESIDENCE_AGG);head(eys_m)
CORESIDENCE_AGG<-merge(CORESIDENCE_AGG,eys_m,by=c('CNTRY_ISO','YEAR'),all.x=TRUE)
head(CORESIDENCE_AGG)



#### MYS_M #####

library(readxl)
Indices_NU_1990_2021 <- read_excel("G:/Shared drives/CORESIDENCE/WP2_DATA/2_5_Context Data and Indicators/Indices_NU_1990_2021.xlsx", 
                                   sheet = "mys_m")

mys_m<-Indices_NU_1990_2021%>%
  pivot_longer(c(2:33),names_to = "year",values_to = "mys_m")

head(mys_m)

names(mys_m)<-c("CNTRY_ISO","YEAR","D13")

mys_m$YEAR<-as.numeric(mys_m$YEAR)
head(CORESIDENCE_AGG);head(mys_m)
CORESIDENCE_AGG<-merge(CORESIDENCE_AGG,mys_m,by=c('CNTRY_ISO','YEAR'),all.x=TRUE)
head(CORESIDENCE_AGG)


#### GNIPC_M #####

library(readxl)
Indices_NU_1990_2021 <- read_excel("G:/Shared drives/CORESIDENCE/WP2_DATA/2_5_Context Data and Indicators/Indices_NU_1990_2021.xlsx", 
                                   sheet = "gnipc_m")

gnipc_m<-Indices_NU_1990_2021%>%
  pivot_longer(c(2:33),names_to = "year",values_to = "gnipc_m")

head(gnipc_m)

names(gnipc_m)<-c("CNTRY_ISO","YEAR","D14")

gnipc_m$YEAR<-as.numeric(gnipc_m$YEAR)
head(CORESIDENCE_AGG);head(gnipc_m)
CORESIDENCE_AGG<-merge(CORESIDENCE_AGG,gnipc_m,by=c('CNTRY_ISO','YEAR'),all.x=TRUE)
head(CORESIDENCE_AGG)


####### CHANGE NAMES AND ORDER #######

colnames(CORESIDENCE_AGG)[2]<-"T1"
#CORESIDENCE_AGG<- CORESIDENCE_AGG %>% relocate(T1, .after = HH16)
colnames(CORESIDENCE_AGG)[8]<-"T2"
#CORESIDENCE_AGG<- CORESIDENCE_AGG %>% relocate(T2, .after = T1)
colnames(CORESIDENCE_AGG)[158]<-"T3"
colnames(CORESIDENCE_AGG)[10]<-"T5"
#CORESIDENCE_AGG<- CORESIDENCE_AGG %>% relocate(T5, .after = T3)
colnames(CORESIDENCE_AGG)[9]<-"T10"
#CORESIDENCE_AGG<- CORESIDENCE_AGG %>% relocate(T10, .after = T5)
colnames(CORESIDENCE_AGG)[1]<-"C1"
colnames(CORESIDENCE_AGG)[3]<-"C2"
colnames(CORESIDENCE_AGG)[7]<-"C3"
#CORESIDENCE_AGG<- CORESIDENCE_AGG %>% relocate(C3, .after = C2)
colnames(CORESIDENCE_AGG)[6]<-"C4"
#CORESIDENCE_AGG<- CORESIDENCE_AGG %>% relocate(C4, .after = C3)
colnames(CORESIDENCE_AGG)[5]<-"S1"
#CORESIDENCE_AGG<- CORESIDENCE_AGG %>% relocate(S1, .after = C4)
colnames(CORESIDENCE_AGG)[4]<-"S2"

CORESIDENCE_AGG<- CORESIDENCE_AGG %>% relocate(C2, .after = C1)
CORESIDENCE_AGG<- CORESIDENCE_AGG %>% relocate(C3, .after = C2)
CORESIDENCE_AGG<- CORESIDENCE_AGG %>% relocate(C4, .after = C3)
CORESIDENCE_AGG<- CORESIDENCE_AGG %>% relocate(T2, .after = T1)
CORESIDENCE_AGG<- CORESIDENCE_AGG %>% relocate(T3, .after = T2)
CORESIDENCE_AGG<- CORESIDENCE_AGG %>% relocate(T5, .after = T3)
CORESIDENCE_AGG<- CORESIDENCE_AGG %>% relocate(T10, .after = T5)
CORESIDENCE_AGG<- CORESIDENCE_AGG %>% relocate(S2, .after = S1)

CORESIDENCE_AGG$WPOP<-NULL

# READ CODES REGIONS #####
library(readxl)
regionw <- read_excel("regionw.xlsx")

regionw<-as.data.frame(regionw)
CORESIDENCE_AGG<-as.data.frame(CORESIDENCE_AGG)

CORESIDENCE_AGG<- data.frame(CORESIDENCE_AGG,
                             regionw[match(CORESIDENCE_AGG[,"C1"],
                                           regionw[,"ISO3"]),c("country")])

colnames(CORESIDENCE_AGG)[grep(names(CORESIDENCE_AGG %>% select(last_col())), colnames(CORESIDENCE_AGG))]<-"C0"
CORESIDENCE_AGG<- CORESIDENCE_AGG %>% relocate(C0, .before = C1)

save(CORESIDENCE_AGG,file="A0_CORESIDENCE_AGG_RITA.RData")
clipr::write_clip(CORESIDENCE_AGG)
